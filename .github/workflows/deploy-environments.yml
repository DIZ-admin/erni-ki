# Environment-Specific Deployment Pipeline for ERNI-KI
# Deploy to development, staging, production with environment-specific secrets
# Author: Alteon Schultz (Tech Lead)
# Date: 2025-09-19

name: ğŸš€ Environment Deployment

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".github/workflows/ci.yml"
      - ".github/workflows/security.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment for deployment"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - staging
          - production
      force_deploy:
        description: "Force deployment (skip some checks)"
        required: false
        default: false
        type: boolean

# Permissions for deploy and secrets access
permissions:
  contents: read
  packages: write
  deployments: write
  actions: read

# Environment variables
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Cancel previous runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.environment || 'auto' }}
  cancel-in-progress: true

jobs:
  # Determine target environment
  determine-environment:
    name: ğŸ¯ Determine Target Environment
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}

    steps:
      - name: ğŸ“‹ Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

          echo "ğŸ¯ Target environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d'=' -f2)"

  # Validate secrets for target environment
  validate-secrets:
    name: ğŸ” Validate Environment Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: determine-environment
    environment: ${{ needs['determine-environment'].outputs.environment }}
    if: needs['determine-environment'].outputs.should_deploy == 'true'

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ğŸ”§ Resolve and validate environment secrets
        uses: ./.github/actions/resolve-secrets
        with:
          environment: ${{ needs['determine-environment'].outputs.environment }}
          tunnel-token: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.TUNNEL_TOKEN_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.TUNNEL_TOKEN_STAGING || secrets.TUNNEL_TOKEN_PROD }}
          openai-api-key: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.OPENAI_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.OPENAI_API_KEY_STAGING || secrets.OPENAI_API_KEY_PROD }}
          context7-api-key: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.CONTEXT7_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.CONTEXT7_API_KEY_STAGING || secrets.CONTEXT7_API_KEY_PROD }}
          anthropic-api-key: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.ANTHROPIC_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.ANTHROPIC_API_KEY_STAGING || secrets.ANTHROPIC_API_KEY_PROD }}
          google-api-key: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.GOOGLE_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.GOOGLE_API_KEY_STAGING || secrets.GOOGLE_API_KEY_PROD }}
          validate: "true"

  # Build Docker images with environment-specific configuration
  build-and-deploy:
    name: ğŸ—ï¸ Build & Deploy to ${{ needs['determine-environment'].outputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [determine-environment, validate-secrets]
    environment: ${{ needs['determine-environment'].outputs.environment }}
    if: needs['determine-environment'].outputs.should_deploy == 'true'
    env:
      ENVIRONMENT: ${{ needs['determine-environment'].outputs.environment }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ğŸ”§ Resolve environment secrets
        uses: ./.github/actions/resolve-secrets
        with:
          environment: ${{ needs['determine-environment'].outputs.environment }}
          tunnel-token: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.TUNNEL_TOKEN_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.TUNNEL_TOKEN_STAGING || secrets.TUNNEL_TOKEN_PROD }}
          openai-api-key: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.OPENAI_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.OPENAI_API_KEY_STAGING || secrets.OPENAI_API_KEY_PROD }}

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: ğŸ”‘ Log in to Container Registry
        uses: docker/login-action@5e57cd118135c172c3672efd75eb46360885c0ef # v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ”¡ Normalize repository to lowercase
        id: repo-lc
        run: |
          repo_lc=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          echo "repo_lc=${repo_lc}" >> "$GITHUB_OUTPUT"

      - name: ğŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@c299e40c65443455700f0fdfc63efafe5b349051 # v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.repo-lc.outputs.repo_lc }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            # Use explicit prefix for SHA tags to avoid empty tag names
            type=sha,format=short,prefix=sha-
            type=raw,value=${{ needs['determine-environment'].outputs.environment }}-latest

      - name: âœ… Validate Docker tags are lowercase
        run: |
          echo "${{ steps.meta.outputs.tags }}" | bash scripts/utilities/check-docker-tags.sh

      - name: ğŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: ./auth
          file: ./auth/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            ENVIRONMENT=${{ needs['determine-environment'].outputs.environment }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          secrets: | # pragma: allowlist secret
            tunnel_token=${{ env.TUNNEL_TOKEN }} # pragma: allowlist secret
            openai_key=${{ env.OPENAI_API_KEY }} # pragma: allowlist secret

  # Deploy to target environment
  deploy:
    name: ğŸš€ Deploy to ${{ needs['determine-environment'].outputs.environment }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [determine-environment, validate-secrets, build-and-deploy]
    environment: ${{ needs['determine-environment'].outputs.environment }}
    if: needs['determine-environment'].outputs.should_deploy == 'true'
    env:
      ENVIRONMENT: ${{ needs['determine-environment'].outputs.environment }}
      TUNNEL_TOKEN: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.TUNNEL_TOKEN_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.TUNNEL_TOKEN_STAGING || secrets.TUNNEL_TOKEN_PROD }}
      OPENAI_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.OPENAI_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.OPENAI_API_KEY_STAGING || secrets.OPENAI_API_KEY_PROD }}
      CONTEXT7_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.CONTEXT7_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.CONTEXT7_API_KEY_STAGING || secrets.CONTEXT7_API_KEY_PROD }}
      ANTHROPIC_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.ANTHROPIC_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.ANTHROPIC_API_KEY_STAGING || secrets.ANTHROPIC_API_KEY_PROD }}
      GOOGLE_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.GOOGLE_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.GOOGLE_API_KEY_STAGING || secrets.GOOGLE_API_KEY_PROD }}

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ğŸ”§ Prepare environment configuration (no secrets written to disk)
        run: |
          echo "Preparing configuration for: ${{ needs['determine-environment'].outputs.environment }}"

          # Create ephemeral env file and delete after deploy to avoid leaking secrets
          tmp_env=$(mktemp)
          {
            echo "ENVIRONMENT=${{ needs['determine-environment'].outputs.environment }}"
            echo "TUNNEL_TOKEN=${TUNNEL_TOKEN}"
            echo "OPENAI_API_KEY=${OPENAI_API_KEY}"
            echo "CONTEXT7_API_KEY=${CONTEXT7_API_KEY}"
            echo "ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}"
            echo "GOOGLE_API_KEY=${GOOGLE_API_KEY}"
            echo "DEPLOY_TIMESTAMP=$(date -u +\"%Y-%m-%dT%H:%M:%SZ\")"
            echo "DEPLOY_SHA=${{ github.sha }}"
            echo "DEPLOY_REF=${{ github.ref }}"
          } > "$tmp_env"

          echo "CONFIG_PATH=$tmp_env" >> "$GITHUB_ENV"
          echo "âœ… Environment configuration prepared (ephemeral)"
        env:
          TUNNEL_TOKEN: ${{ env.TUNNEL_TOKEN }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          CONTEXT7_API_KEY: ${{ env.CONTEXT7_API_KEY }}
          ANTHROPIC_API_KEY: ${{ env.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ env.GOOGLE_API_KEY }}

      - name: ğŸ¯ Deploy to ${{ needs['determine-environment'].outputs.environment }}
        run: |
          echo "ğŸš€ Deploying to ${{ needs['determine-environment'].outputs.environment }} environment"
          echo "ğŸ“¦ Image: ${{ env.REGISTRY }}/${{ steps.repo-lc.outputs.repo_lc }}:${{ needs['determine-environment'].outputs.environment }}-latest"
          echo "ğŸ”§ Configuration: ${CONFIG_PATH}"

          # Note: Actual deploy logic is implemented via external tools
          # (e.g., kubectl, docker-compose, Ansible) and configured via GitHub Secrets
          echo "âœ… Deployment completed successfully"
        env:
          CONFIG_PATH: ${{ env.CONFIG_PATH }}

      - name: ğŸ“Š Post-deployment verification
        run: |
          echo "ğŸ” Verifying deployment in ${{ needs['determine-environment'].outputs.environment }}"

          # Here you can add service health checks
          # For example, health checks, smoke tests, etc.

          echo "âœ… Deployment verification completed"

      - name: ğŸ§¹ Cleanup ephemeral config
        if: always()
        run: |
          if [ -n "${CONFIG_PATH:-}" ] && [ -f "${CONFIG_PATH}" ]; then
            shred -u "${CONFIG_PATH}" || rm -f "${CONFIG_PATH}"
            echo "Cleaned CONFIG_PATH"
          fi

  # Deployment result notifications
  notify:
    name: ğŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [determine-environment, deploy]
    if: always() && needs['determine-environment'].outputs.should_deploy == 'true'

    steps:
      - name: ğŸ“¢ Send deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… Deployment to ${{ needs['determine-environment'].outputs.environment }} completed successfully"
            echo "ğŸ”— Environment: ${{ needs['determine-environment'].outputs.environment }}"
            echo "ğŸ“¦ SHA: ${{ github.sha }}"
            echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          else
            echo "âŒ Deployment to ${{ needs['determine-environment'].outputs.environment }} failed"
            echo "ğŸ” Check the logs for details"
          fi
