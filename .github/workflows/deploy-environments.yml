# Environment-Specific Deployment Pipeline for ERNI-KI
# Deploy to development, staging, production with environment-specific secrets
# Author: Alteon Schultz (Tech Lead)
# Date: 2025-09-19

name: ðŸš€ Environment Deployment

on:
  push:
    branches: [main, develop]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".github/workflows/ci.yml"
      - ".github/workflows/security.yml"
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment for deployment"
        required: true
        default: "development"
        type: choice
        options:
          - development
          - staging
          - production
      force_deploy:
        description: "Force deployment (skip some checks)"
        required: false
        default: false
        type: boolean

# Permissions for deploy and secrets access
permissions:
  contents: read
  packages: write
  deployments: write
  actions: read

# Environment variables
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

# Cancel previous runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.environment || 'auto' }}
  cancel-in-progress: true

jobs:
  # Determine target environment
  determine-environment:
    name: ðŸŽ¯ Determine Target Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
      should_deploy: ${{ steps.env.outputs.should_deploy }}

    steps:
      - name: ðŸ“‹ Determine environment
        id: env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "should_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "environment=development" >> $GITHUB_OUTPUT
            echo "should_deploy=false" >> $GITHUB_OUTPUT
          fi

          echo "ðŸŽ¯ Target environment: $(cat $GITHUB_OUTPUT | grep environment | cut -d'=' -f2)"

  # Validate secrets for target environment
  validate-secrets:
    name: ðŸ” Validate Environment Secrets
    runs-on: ubuntu-latest
    needs: determine-environment
    environment: ${{ needs['determine-environment'].outputs.environment }}
    if: needs['determine-environment'].outputs.should_deploy == 'true'

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ” Validate required config
        # pragma: allowlist secret
        run: |
          echo "Validating environment config for: ${{ needs['determine-environment'].outputs.environment }}"

          env_keys=(TUNNEL_TOKEN OPENAI_API_KEY)
          missing_env_keys=()

          for key in "${env_keys[@]}"; do
            value="${!key:-}"
            if [ -z "$value" ] || [[ "$value" == *"REPLACE_WITH_REAL"* ]]; then
              missing_env_keys+=("$key")
            else
              echo "âœ… $key: configured"
            fi
          done

          if [ ${#missing_env_keys[@]} -gt 0 ]; then
            echo "âŒ Missing or invalid environment keys:"
            printf '%s\n' "${missing_env_keys[@]}"

            if [ "${{ needs['determine-environment'].outputs.environment }}" = "production" ]; then
              echo "ðŸ”´ CRITICAL: Production environment keys must be real values!"
              exit 1
            else
              echo "âš ï¸ WARNING: Some environment keys are missing, but continuing for non-production environment"
            fi
          else
            echo "âœ… All required environment keys are configured"
          fi
        env:
          TUNNEL_TOKEN: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.TUNNEL_TOKEN_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.TUNNEL_TOKEN_STAGING || secrets.TUNNEL_TOKEN_PROD }}
          OPENAI_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.OPENAI_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.OPENAI_API_KEY_STAGING || secrets.OPENAI_API_KEY_PROD }}
          CONTEXT7_API_KEY_DEV: ${{ secrets.CONTEXT7_API_KEY_DEV }}
          CONTEXT7_API_KEY_STAGING: ${{ secrets.CONTEXT7_API_KEY_STAGING }}
          CONTEXT7_API_KEY_PROD: ${{ secrets.CONTEXT7_API_KEY_PROD }}
          ANTHROPIC_API_KEY_DEV: ${{ secrets.ANTHROPIC_API_KEY_DEV }}
          ANTHROPIC_API_KEY_STAGING: ${{ secrets.ANTHROPIC_API_KEY_STAGING }}
          ANTHROPIC_API_KEY_PROD: ${{ secrets.ANTHROPIC_API_KEY_PROD }}
          GOOGLE_API_KEY_DEV: ${{ secrets.GOOGLE_API_KEY_DEV }}
          GOOGLE_API_KEY_STAGING: ${{ secrets.GOOGLE_API_KEY_STAGING }}
          GOOGLE_API_KEY_PROD: ${{ secrets.GOOGLE_API_KEY_PROD }}

  # Build Docker images with environment-specific configuration
  build-and-deploy:
    name: ðŸ—ï¸ Build & Deploy to ${{ needs['determine-environment'].outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, validate-secrets]
    environment: ${{ needs['determine-environment'].outputs.environment }}
    if: needs['determine-environment'].outputs.should_deploy == 'true'
    env:
      ENVIRONMENT: ${{ needs['determine-environment'].outputs.environment }}
      TUNNEL_TOKEN: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.TUNNEL_TOKEN_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.TUNNEL_TOKEN_STAGING || secrets.TUNNEL_TOKEN_PROD }}
      OPENAI_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.OPENAI_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.OPENAI_API_KEY_STAGING || secrets.OPENAI_API_KEY_PROD }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”¡ Normalize repository to lowercase
        id: repo-lc
        run: |
          repo_lc=$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')
          echo "repo_lc=${repo_lc}" >> "$GITHUB_OUTPUT"

      - name: ðŸ“‹ Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ steps.repo-lc.outputs.repo_lc }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=raw,value=sha-${{ github.sha }}
            type=raw,value=${{ needs['determine-environment'].outputs.environment }}-latest

      - name: âœ… Validate Docker tags are lowercase
        run: |
          echo "${{ steps.meta.outputs.tags }}" | bash scripts/utilities/check-docker-tags.sh

      - name: ðŸ—ï¸ Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./auth
          file: ./auth/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            ENVIRONMENT=${{ needs['determine-environment'].outputs.environment }}
            BUILD_DATE=${{ github.event.head_commit.timestamp }}
            VCS_REF=${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          secrets: | # pragma: allowlist secret
            tunnel_token=${{ env.TUNNEL_TOKEN }} # pragma: allowlist secret
            openai_key=${{ env.OPENAI_API_KEY }} # pragma: allowlist secret

  # Deploy to target environment
  deploy:
    name: ðŸš€ Deploy to ${{ needs['determine-environment'].outputs.environment }}
    runs-on: ubuntu-latest
    needs: [determine-environment, validate-secrets, build-and-deploy]
    environment: ${{ needs['determine-environment'].outputs.environment }}
    if: needs['determine-environment'].outputs.should_deploy == 'true'
    env:
      ENVIRONMENT: ${{ needs['determine-environment'].outputs.environment }}
      TUNNEL_TOKEN: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.TUNNEL_TOKEN_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.TUNNEL_TOKEN_STAGING || secrets.TUNNEL_TOKEN_PROD }}
      OPENAI_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.OPENAI_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.OPENAI_API_KEY_STAGING || secrets.OPENAI_API_KEY_PROD }}
      CONTEXT7_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.CONTEXT7_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.CONTEXT7_API_KEY_STAGING || secrets.CONTEXT7_API_KEY_PROD }}
      ANTHROPIC_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.ANTHROPIC_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.ANTHROPIC_API_KEY_STAGING || secrets.ANTHROPIC_API_KEY_PROD }}
      GOOGLE_API_KEY: ${{ needs['determine-environment'].outputs.environment == 'development' && secrets.GOOGLE_API_KEY_DEV || needs['determine-environment'].outputs.environment == 'staging' && secrets.GOOGLE_API_KEY_STAGING || secrets.GOOGLE_API_KEY_PROD }}

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ”§ Prepare environment configuration
        run: |
          echo "Preparing configuration for: ${{ needs['determine-environment'].outputs.environment }}"

          # Create environment-specific configuration
          mkdir -p .deploy-config

          # Determine suffix for secrets
          ENV_SUFFIX=""
          case "${{ needs['determine-environment'].outputs.environment }}" in
            "development") ENV_SUFFIX="_DEV" ;;
            "staging") ENV_SUFFIX="_STAGING" ;;
            "production") ENV_SUFFIX="_PROD" ;;
          esac

          # Create file with environment variables for deploy
          cat > .deploy-config/environment.env << EOF
          ENVIRONMENT=${{ needs['determine-environment'].outputs.environment }}
          TUNNEL_TOKEN=${TUNNEL_TOKEN}
          OPENAI_API_KEY=${OPENAI_API_KEY}
          CONTEXT7_API_KEY=${CONTEXT7_API_KEY}
          ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
          GOOGLE_API_KEY=${GOOGLE_API_KEY}
          DEPLOY_TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DEPLOY_SHA=${{ github.sha }}
          DEPLOY_REF=${{ github.ref }}
          EOF

          echo "âœ… Environment configuration prepared"
        env:
          TUNNEL_TOKEN: ${{ env.TUNNEL_TOKEN }}
          OPENAI_API_KEY: ${{ env.OPENAI_API_KEY }}
          CONTEXT7_API_KEY: ${{ env.CONTEXT7_API_KEY }}
          ANTHROPIC_API_KEY: ${{ env.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ env.GOOGLE_API_KEY }}

      - name: ðŸŽ¯ Deploy to ${{ needs['determine-environment'].outputs.environment }}
        run: |
          echo "ðŸš€ Deploying to ${{ needs['determine-environment'].outputs.environment }} environment"
          echo "ðŸ“¦ Image: ${{ env.REGISTRY }}/${{ steps.repo-lc.outputs.repo_lc }}:${{ needs['determine-environment'].outputs.environment }}-latest"
          echo "ðŸ”§ Configuration: .deploy-config/environment.env"

          # Note: Actual deploy logic is implemented via external tools
          # (e.g., kubectl, docker-compose, Ansible) and configured via GitHub Secrets
          echo "âœ… Deployment completed successfully"

      - name: ðŸ“Š Post-deployment verification
        run: |
          echo "ðŸ” Verifying deployment in ${{ needs['determine-environment'].outputs.environment }}"

          # Here you can add service health checks
          # For example, health checks, smoke tests, etc.

          echo "âœ… Deployment verification completed"

  # Deployment result notifications
  notify:
    name: ðŸ“¢ Deployment Notification
    runs-on: ubuntu-latest
    needs: [determine-environment, deploy]
    if: always() && needs['determine-environment'].outputs.should_deploy == 'true'

    steps:
      - name: ðŸ“¢ Send deployment notification
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… Deployment to ${{ needs['determine-environment'].outputs.environment }} completed successfully"
            echo "ðŸ”— Environment: ${{ needs['determine-environment'].outputs.environment }}"
            echo "ðŸ“¦ SHA: ${{ github.sha }}"
            echo "ðŸŒ¿ Branch: ${{ github.ref_name }}"
          else
            echo "âŒ Deployment to ${{ needs['determine-environment'].outputs.environment }} failed"
            echo "ðŸ” Check the logs for details"
          fi
