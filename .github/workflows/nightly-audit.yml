name: ðŸŒ™ Nightly Audit

on:
  schedule:
    - cron: "0 2 * * *" # Run at 2 AM UTC every day
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read

# Prevent concurrent audit runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  audit:
    name: ðŸ•µï¸ Nightly Documentation Audit
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ðŸ Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: requirements-docs.txt

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-docs.txt

      - name: ðŸ§© Validate docs metadata
        run: python scripts/docs/validate_metadata.py

      - name: ðŸ—ï¸ Build MkDocs site
        run: mkdocs build --site-dir site

      - name: ðŸ”— Check links (Lychee)
        uses: lycheeverse/lychee-action@a8c4c7cb88f0c7386610c35eb25108e448569cb0 # v2
        with:
          args: >
            --verbose
            --no-progress
            --max-redirects 5
            --max-retries 3
            --retry-wait-time 5
            --accept 200..299,403,429,503
            --exclude-link-local
            --exclude 'localhost'
            --exclude '127\.0\.0\.1'
            --exclude 'example\.com'
            --exclude 'your-domain'
            --exclude 'ki\.erni-gruppe\.ch'
            --exclude 'status\.ki\.erni-gruppe\.ch'
            --exclude 'status\.erni-ki\.ch'
            --exclude 'grafana\.ki\.erni-gruppe\.ch'
            --exclude 'prometheus\.ki\.erni-gruppe\.ch'
            --exclude 'docs\.erni-ki\.ch'
            --exclude '192\.168\.\d+\.\d+'
            --exclude 'nginx:8080'
            --exclude 'openwebui:8080'
            --exclude 'searxng:8080'
            --exclude 'dash\.cloudflare\.com'
            --exclude 'docs\.openwebui\.com'
            --exclude 'github\.com/nginx/nginx/issues'
            --exclude 'github\.com/DIZ-admin/erni-ki/discussions'
            --exclude 'docs\.litellm\.ai'
            --exclude 'commitlint\.js\.org'
            'docs/**/*.md'
            'README.md'
          fail: true
