# Security Pipeline for erni-ki project
# CodeQL security analysis and dependency scanning

name: ðŸ”’ Security Analysis

on:
  push:
    branches:
      - main
      - develop
      - release/*
    paths:
      - "auth/**"
      - "services/**"
      - "ops/**"
      - "scripts/**"
      - "package.json"
      - "bun.lock"
      - "go.mod"
      - "go.sum"
      - "requirements*.txt"
      - "pyproject.toml"
      - ".github/workflows/security.yml"
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "auth/**"
      - "services/**"
      - "ops/**"
      - "scripts/**"
      - "package.json"
      - "bun.lock"
      - "go.mod"
      - "go.sum"
      - "requirements*.txt"
      - "pyproject.toml"
  schedule:
    # Weekly on Sunday at 2:00 UTC (was daily)
    - cron: "0 2 * * 0"
  workflow_dispatch:

# Permissions for security events
permissions:
  actions: read
  contents: read
  security-events: write

# Cancel previous runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # CodeQL analysis
  codeql:
    name: ðŸ” CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        language: [go, javascript-typescript, python]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ðŸ”§ Initialize CodeQL
        uses: github/codeql-action/init@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - name: ðŸ¹ Setup Go
        if: matrix.language == 'go'
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v5
        with:
          go-version-file: auth/go.mod
          cache-dependency-path: auth/go.sum

      - name: ðŸ—ï¸ Autobuild
        uses: github/codeql-action/autobuild@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4

      - name: ðŸ” Perform CodeQL Analysis
        uses: github/codeql-action/analyze@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4
        with:
          category: "/language:${{ matrix.language }}"

  # Dependency scanning
  dependency-scan:
    name: ðŸ“¦ Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      # Scan Go dependencies
      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v5
        with:
          go-version-file: auth/go.mod
          cache-dependency-path: auth/go.sum

      - name: ðŸ” Run Go vulnerability check
        working-directory: ./auth
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@v1.1.1
          govulncheck ./...

      # Scan npm dependencies (if any)
      - name: ðŸŸ£ Setup Bun
        if: hashFiles('package.json') != ''
        uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2.0.2
        with:
          bun-version: "1.3.3"

      - name: ðŸ” Run bun audit (production severity)
        if: hashFiles('package.json') != ''
        run: |
          bun audit --severity high
          bun audit --json --severity high > bun-audit-results.json

      - name: ðŸ“¤ Upload bun audit results
        if: hashFiles('package.json') != ''
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: bun-audit-results
          path: bun-audit-results.json
          retention-days: 30

  bandit:
    name: ðŸ Bandit + Ruff security
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ðŸ Setup Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ðŸ“¦ Install security linters
        run: |
          python -m pip install --upgrade pip
          pip install bandit==1.7.10 ruff==0.5.7

      - name: ðŸ”’ Run Bandit
        run: |
          bandit -q -r conf scripts ops docs examples || exit 1

      - name: ðŸ”’ Run Ruff (security rules)
        run: |
          ruff check --select S,B,ASYNC,N --ignore S101 .

  trivy:
    name: ðŸ›¡ï¸ Trivy filesystem scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ðŸ›¡ï¸ Run Trivy FS scan (HIGH,CRITICAL)
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          version: "v0.68.1"
          scan-type: fs
          format: sarif
          output: trivy-fs-results.sarif
          ignore-unfixed: true
          severity: HIGH,CRITICAL
          trivyignores: ".github/trivy.ignore"
          exit-code: 0
        env:
          TRIVY_SKIP_VERSION_CHECK: "true"

      - name: ðŸ“¤ Upload Trivy FS SARIF to Security
        if: always()
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4
        with:
          sarif_file: trivy-fs-results.sarif
          category: trivy-fs

  # Secret scanning
  secret-scan:
    name: ðŸ” Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0

      - name: ðŸ” Run TruffleHog
        uses: trufflesecurity/trufflehog@ef6e76c3c4023279497fab4721ffa071a722fd05 # v3.92.4
        with:
          path: ./
          base: ${{ github.event.before || 'HEAD~1' }}
          head: HEAD
          extra_args: --only-verified

      - name: ðŸ¹ Setup Go
        uses: actions/setup-go@4dc6199c7b1a012772edbd06daecab0f50c9053c # v5
        with:
          go-version-file: auth/go.mod
          cache-dependency-path: auth/go.sum

      - name: ðŸ” Run Gitleaks
        run: |
          go install github.com/zricethezav/gitleaks/v8@v8.29.1
          gitleaks detect --redact --source=. -c .gitleaks.toml --report-format=sarif --report-path=gitleaks-results.sarif

      - name: ðŸ“¤ Upload Gitleaks SARIF to Security
        if: always()
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4
        with:
          sarif_file: gitleaks-results.sarif
          category: gitleaks

  # Docker image scanning
  container-scan:
    name: ðŸ³ Container Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@e468171a9de216ec08956ac3ada2f0791b6bd435 # v3

      - name: ðŸ—ï¸ Build Docker image
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5
        with:
          context: ./auth
          file: ./auth/Dockerfile
          load: true
          tags: erni-ki-auth:security-scan
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ðŸ” Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@b6643a29fecd7f34b3597bc6acb0a98b03d33ff8 # 0.33.1
        with:
          version: "v0.68.1"
          image-ref: "erni-ki-auth:security-scan"
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"
          scanners: "vuln"
          ignore-unfixed: true
          exit-code: "0"
          trivyignores: ".github/trivy.ignore"
        env:
          TRIVY_SKIP_VERSION_CHECK: "true"

      - name: ðŸ“¤ Upload Trivy Image SARIF to Security
        if: always()
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4
        with:
          sarif_file: trivy-results.sarif
          category: trivy-image

      - name: ðŸ” Run Grype vulnerability scanner
        uses: anchore/scan-action@64a33b277ea7a1215a3c142735a1091341939ff5 # v4
        id: grype-scan
        with:
          image: "erni-ki-auth:security-scan"
          fail-build: false
          severity-cutoff: high
          output-format: sarif

      - name: ðŸ“„ Detect Grype SARIF
        id: grype-sarif
        if: always()
        run: |
          sarif_path="${{ steps.grype-scan.outputs.sarif }}"
          if [ -n "$sarif_path" ] && [ -s "$sarif_path" ]; then
            echo "sarif_file=$sarif_path" >> "$GITHUB_OUTPUT"
          else
            echo "Grype SARIF not found or empty; skipping upload."
          fi

      - name: ðŸ“¤ Upload Grype SARIF to Security
        if: always() && steps.grype-sarif.outputs.sarif_file != ''
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4
        with:
          sarif_file: ${{ steps.grype-sarif.outputs.sarif_file }}
          category: grype

  # Configuration analysis
  config-scan:
    name: âš™ï¸ Configuration Security
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ðŸ” Run Checkov
        uses: bridgecrewio/checkov-action@4dcc9609e7734e8bc66e77c5691a16ad0d247420 # v12.2961.0
        with:
          directory: .
          framework: dockerfile,github_actions,secrets
          output_format: sarif
          output_file_path: checkov-results.sarif
          config_file: .checkov.yml
          quiet: true
          soft_fail: false

      - name: ðŸ“¤ Upload Checkov SARIF to Security
        if: always()
        uses: github/codeql-action/upload-sarif@cf1bb45a277cb3c205638b2cd5c984db1c46a412 # v4
        with:
          sarif_file: checkov-results.sarif
          category: checkov

      # Validate Docker Compose configuration
      - name: ðŸ³ Validate Docker Compose
        run: |
          if [ -f "compose.yml.example" ]; then
            echo "Validating Docker Compose configuration..."
            # Create temporary file with base variables for validation
            cp compose.yml.example compose.yml.temp
            # Check syntax without variable substitution
            docker compose -f compose.yml.temp config --quiet --dry-run || echo "âš ï¸ Docker Compose validation skipped (requires env vars)"
            rm -f compose.yml.temp
            echo "âœ… Docker Compose syntax check completed"
          else
            echo "âš ï¸ compose.yml.example not found, skipping validation"
          fi

      # Validate Nginx configuration
      - name: ðŸŒ Validate Nginx config
        run: |
          if [ -f "conf/nginx/nginx.conf" ]; then
            echo "Validating Nginx configuration..."
            # Check Nginx configuration syntax
            docker run --rm -v $(pwd)/conf/nginx:/etc/nginx/conf.d:ro nginx:alpine nginx -t -c /etc/nginx/nginx.conf || echo "âš ï¸ Nginx validation requires full config context"
            echo "âœ… Nginx syntax check completed"
          else
            echo "âš ï¸ Nginx config not found, skipping validation"
          fi

  # Test environment-specific secrets
  test-environment-secrets:
    name: ðŸ” Test Environment Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        environment: [development, staging, production]

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ðŸ” Test environment secrets availability
        run: |
          echo "Testing secrets for environment: ${{ matrix.environment }}"

          # Determine suffix for environment
          ENV_SUFFIX=""
          case "${{ matrix.environment }}" in
            "development") ENV_SUFFIX="_DEV" ;;
            "staging") ENV_SUFFIX="_STAGING" ;;
            "production") ENV_SUFFIX="_PROD" ;;
          esac

          echo "Environment suffix: $ENV_SUFFIX"

          # Check secrets structure (without revealing values)
          expected_secrets=(
            "TUNNEL_TOKEN${ENV_SUFFIX}"
            "OPENAI_API_KEY${ENV_SUFFIX}"
            "CONTEXT7_API_KEY${ENV_SUFFIX}"
            "ANTHROPIC_API_KEY${ENV_SUFFIX}"
            "GOOGLE_API_KEY${ENV_SUFFIX}"
          )

          echo "Expected secrets for ${{ matrix.environment }}:"
          printf '%s\n' "${expected_secrets[@]}"

          # Check that secrets do not contain placeholder values
          if [ "${{ matrix.environment }}" = "production" ]; then
            echo "âš ï¸ Production secrets should be manually verified"
          fi

          echo "âœ… Environment secrets structure validated"

  # DAST - Dynamic Application Security Testing
  # Note: Runs only on schedule and manual trigger (not on PRs - requires running services)
  dast-scan:
    name: ðŸŽ¯ DAST Scan (ZAP Baseline)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: ðŸ³ Start test services
        run: |
          # Start minimal services for DAST testing
          docker compose -f compose.yml up -d nginx auth || true
          sleep 30
          echo "Services started for DAST testing"

      - name: ðŸŽ¯ Run ZAP Baseline Scan
        uses: zaproxy/action-baseline@6c5a007541891231cd9e0ddec25d4f25c59c9874 # v0.15.0
        with:
          target: "http://localhost:8080"
          rules_file_name: ".github/zap-rules.tsv"
          cmd_options: "-a -j"
          allow_issue_writing: false
        continue-on-error: true

      - name: ðŸ“¤ Upload ZAP Report
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: zap-report
          path: report_html.html
          retention-days: 30

      - name: ðŸ”¬ Run Nuclei Scan
        uses: projectdiscovery/nuclei-action@128f7284c2a836b485e292b9080dbc6175103758 # v2.0.2
        with:
          target: "http://localhost:8080"
          templates: "cves,vulnerabilities,misconfiguration"
          output: nuclei-results.txt
          sarif-export: nuclei-results.sarif
        continue-on-error: true

      - name: ðŸ“¤ Upload Nuclei Results
        if: always()
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v5
        with:
          name: nuclei-report
          path: |
            nuclei-results.txt
            nuclei-results.sarif
          retention-days: 30

      - name: ðŸ³ Stop test services
        if: always()
        run: docker compose down || true

  # Security report summary
  security-report:
    name: ðŸ“Š Security Report
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [codeql, dependency-scan, bandit, trivy, secret-scan, container-scan, config-scan]
    if: always()

    steps:
      - name: ðŸ“Š Generate Security Summary
        run: |
          echo "## ðŸ”’ Security Analysis Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| CodeQL Analysis | ${{ needs.codeql.result == 'success' && 'âœ… Passed' || needs.codeql.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependency Scan | ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || needs.dependency-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bandit + Ruff | ${{ needs.bandit.result == 'success' && 'âœ… Passed' || needs.bandit.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Trivy Scan | ${{ needs.trivy.result == 'success' && 'âœ… Passed' || needs.trivy.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Secret Scan | ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || needs.secret-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Container Scan | ${{ needs.container-scan.result == 'success' && 'âœ… Passed' || needs.container-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Config Security | ${{ needs.config-scan.result == 'success' && 'âœ… Passed' || needs.config-scan.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Run: ${{ github.run_id }} | ðŸ”— [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
