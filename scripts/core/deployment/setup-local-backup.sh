#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ ERNI-KI —á–µ—Ä–µ–∑ Backrest
# –°–æ–∑–¥–∞–µ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –∏ –ø–ª–∞–Ω –±—ç–∫–∞–ø–∞ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö

set -euo pipefail

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

error() {
    echo -e "${RED}[ERROR]${NC} $1"
    exit 1
}

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
BACKREST_URL="http://localhost:9898"
REPO_ID="erni-ki-local"
REPO_PATH="/backup-sources/.config-backup"
PLAN_ID="erni-ki-critical-data"

# –ü–æ–ª—É—á–µ–Ω–∏–µ —É—á–µ—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
get_credentials() {
    if [ -f ".backrest_secrets" ]; then
        BACKREST_PASSWORD=$(grep "BACKREST_PASSWORD=" .backrest_secrets | cut -d'=' -f2)
        RESTIC_PASSWORD=$(grep "RESTIC_PASSWORD=" .backrest_secrets | cut -d'=' -f2)

        if [ -z "$BACKREST_PASSWORD" ] || [ -z "$RESTIC_PASSWORD" ]; then
            error "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ .backrest_secrets"
        fi

        success "–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã"
    else
        error "–§–∞–π–ª .backrest_secrets –Ω–µ –Ω–∞–π–¥–µ–Ω. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–Ω–∞—á–∞–ª–∞ ./scripts/backrest-setup.sh"
    fi
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Backrest
check_backrest() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Backrest..."

    if ! curl -s -o /dev/null -w "%{http_code}" "$BACKREST_URL/" | grep -q "200"; then
        error "Backrest –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É $BACKREST_URL"
    fi

    success "Backrest –¥–æ—Å—Ç—É–ø–µ–Ω"
}

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
create_repository_instructions() {
    log "–°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."

    echo ""
    echo "=== –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –°–û–ó–î–ê–ù–ò–Æ –†–ï–ü–û–ó–ò–¢–û–†–ò–Ø ==="
    echo ""
    echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Backrest: $BACKREST_URL"
    echo "2. –í–æ–π–¥–∏—Ç–µ —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏:"
    echo "   - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: admin"
    echo "   - –ü–∞—Ä–æ–ª—å: $BACKREST_PASSWORD"
    echo ""
    echo "3. –ù–∞–∂–º–∏—Ç–µ 'Add Repository' –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:"
    echo "   - Repository ID: $REPO_ID"
    echo "   - Repository URI: $REPO_PATH"
    echo "   - Password: $RESTIC_PASSWORD"
    echo ""
    echo "4. –í —Ä–∞–∑–¥–µ–ª–µ 'Prune Policy' —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:"
    echo "   - Schedule: 0 3 * * * (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 3:00)"
    echo "   - Max Unused Bytes: 1GB"
    echo ""
    echo "5. –í —Ä–∞–∑–¥–µ–ª–µ 'Check Policy' —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:"
    echo "   - Schedule: 0 4 * * 0 (–µ–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –≤ 4:00)"
    echo ""
    echo "6. –ù–∞–∂–º–∏—Ç–µ 'Create Repository'"
    echo ""
}

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –±—ç–∫–∞–ø–∞ (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
create_backup_plan_instructions() {
    log "–°–æ–∑–¥–∞–Ω–∏–µ –ø–ª–∞–Ω–∞ –±—ç–∫–∞–ø–∞..."

    echo ""
    echo "=== –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –°–û–ó–î–ê–ù–ò–Æ –ü–õ–ê–ù–ê –ë–≠–ö–ê–ü–ê ==="
    echo ""
    echo "1. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞–∂–º–∏—Ç–µ 'Add Plan'"
    echo ""
    echo "2. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:"
    echo "   - Plan ID: $PLAN_ID"
    echo "   - Repository: $REPO_ID"
    echo ""
    echo "3. –í —Ä–∞–∑–¥–µ–ª–µ 'Paths' –¥–æ–±–∞–≤—å—Ç–µ:"
    echo "   - /backup-sources/env"
    echo "   - /backup-sources/conf"
    echo "   - /backup-sources/data/postgres"
    echo "   - /backup-sources/data/openwebui"
    echo "   - /backup-sources/data/ollama"
    echo ""
    echo "4. –í —Ä–∞–∑–¥–µ–ª–µ 'Excludes' –¥–æ–±–∞–≤—å—Ç–µ:"
    echo "   - *.log"
    echo "   - *.tmp"
    echo "   - **/cache/**"
    echo "   - **/temp/**"
    echo "   - **/.git/**"
    echo "   - **/node_modules/**"
    echo ""
    echo "5. –í —Ä–∞–∑–¥–µ–ª–µ 'Schedule' —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:"
    echo "   - Schedule: 0 2 * * * (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 2:00)"
    echo ""
    echo "6. –í —Ä–∞–∑–¥–µ–ª–µ 'Retention Policy' –≤—ã–±–µ—Ä–∏—Ç–µ 'Time-based' –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:"
    echo "   - Keep Daily: 7"
    echo "   - Keep Weekly: 4"
    echo "   - Keep Monthly: 0"
    echo "   - Keep Yearly: 0"
    echo ""
    echo "7. –ù–∞–∂–º–∏—Ç–µ 'Create Plan'"
    echo ""
}

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±—ç–∫–∞–ø–∞ (–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏)
create_test_backup_instructions() {
    log "–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –±—ç–∫–∞–ø–∞..."

    echo ""
    echo "=== –ò–ù–°–¢–†–£–ö–¶–ò–ò –ü–û –°–û–ó–î–ê–ù–ò–Æ –¢–ï–°–¢–û–í–û–ì–û –ë–≠–ö–ê–ü–ê ==="
    echo ""
    echo "1. –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É 'Plans'"
    echo "2. –ù–∞–π–¥–∏—Ç–µ –ø–ª–∞–Ω '$PLAN_ID'"
    echo "3. –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É 'Backup Now' —Ä—è–¥–æ–º —Å –ø–ª–∞–Ω–æ–º"
    echo "4. –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏ –±—ç–∫–∞–ø–∞"
    echo "5. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ .config-backup/ –ø–æ—è–≤–∏–ª–∏—Å—å —Ñ–∞–π–ª—ã"
    echo ""
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞
check_backup() {
    log "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞..."

    if [ -d ".config-backup" ] && [ "$(ls -A .config-backup 2>/dev/null)" ]; then
        success "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .config-backup —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –±—ç–∫–∞–ø–∞"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
        ls -la .config-backup/
    else
        warning "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è .config-backup –ø—É—Å—Ç–∞ –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –±—ç–∫–∞–ø–∞"
        echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã —Å–æ–∑–¥–∞–ª–∏ –∏ –∑–∞–ø—É—Å—Ç–∏–ª–∏ –ø–ª–∞–Ω –±—ç–∫–∞–ø–∞ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å"
    fi
}

# –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é
create_restore_instructions() {
    log "–°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–π –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é..."

    cat > docs/local-backup-restore-guide.md << 'EOF'
# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ ERNI-KI

## üéØ –û–±–∑–æ—Ä

–î–∞–Ω–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞, —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ —Å –ø–æ–º–æ—â—å—é Backrest –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `.config-backup/`.

## üìã –ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ –±—ç–∫–∞–ø

- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã**: `env/` –∏ `conf/`
- **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö PostgreSQL**: `data/postgres/`
- **–î–∞–Ω–Ω—ã–µ Open WebUI**: `data/openwebui/`
- **–ú–æ–¥–µ–ª–∏ Ollama**: `data/ollama/`

## üîß –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Backrest

### 1. –î–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ http://localhost:9898
2. –í–æ–π–¥–∏—Ç–µ —Å —É—á–µ—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ `.backrest_secrets`
3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª "Snapshots"
4. –í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

1. –í —Å–ø–∏—Å–∫–µ —Å–Ω–∞–ø—à–æ—Ç–æ–≤ –Ω–∞–∂–º–∏—Ç–µ "Browse"
2. –ù–∞–≤–∏–≥–∏—Ä—É–π—Ç–µ –∫ –Ω—É–∂–Ω—ã–º —Ñ–∞–π–ª–∞–º
3. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª—ã –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
4. –ù–∞–∂–º–∏—Ç–µ "Restore" –∏ —É–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è

### 3. –ü–æ–ª–Ω–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã ERNI-KI:
   ```bash
   docker-compose down
   ```

2. –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö:
   ```bash
   mv data data.backup.$(date +%Y%m%d_%H%M%S)
   mv env env.backup.$(date +%Y%m%d_%H%M%S)
   mv conf conf.backup.$(date +%Y%m%d_%H%M%S)
   ```

3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ Backrest –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å:
   - –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–π —É—Å–ø–µ—à–Ω—ã–π —Å–Ω–∞–ø—à–æ—Ç
   - –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫–∞–∂–¥—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –º–µ—Å—Ç–æ
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

4. –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã:
   ```bash
   docker-compose up -d
   ```

## üõ†Ô∏è –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –∫–æ–º–∞–Ω–¥–Ω—É—é —Å—Ç—Ä–æ–∫—É

### 1. –ü—Ä—è–º–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ restic

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
export RESTIC_REPOSITORY="/path/to/.config-backup"
export RESTIC_PASSWORD="your_restic_password_from_.backrest_secrets"

# –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–Ω–∞–ø—à–æ—Ç–æ–≤
restic snapshots

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–Ω–∞–ø—à–æ—Ç–∞
restic restore latest --target ./restore-temp

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤
restic restore latest --target ./restore-temp --include "*/env/*"
```

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ Backrest

```bash
# –í—Ö–æ–¥ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Backrest
docker-compose exec backrest sh

# –í–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
export RESTIC_REPOSITORY="/backup-sources/.config-backup"
export RESTIC_PASSWORD="your_restic_password"

# –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–Ω–∞–ø—à–æ—Ç–æ–≤
restic snapshots

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ
restic restore latest --target /tmp/restore
```

## üö® –ü—Ä–æ—Ü–µ–¥—É—Ä—ã —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ü–æ—Ç–µ—Ä—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose down

# 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π
# –ß–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Backrest –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ:
# - /backup-sources/env -> ./env
# - /backup-sources/conf -> ./conf

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
docker-compose up -d
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–µ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose down

# 2. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–Ω–æ–π –ë–î
mv data/postgres data/postgres.corrupted.$(date +%Y%m%d_%H%M%S)

# 3. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ë–î –∏–∑ –±—ç–∫–∞–ø–∞
# –ß–µ—Ä–µ–∑ Backrest –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ /backup-sources/data/postgres -> ./data/postgres

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
sudo chown -R 999:999 data/postgres

# 5. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d db
# –î–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–ø—É—Å–∫–∞ –ë–î, –∑–∞—Ç–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
docker-compose up -d
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ü–æ—Ç–µ—Ä—è –º–æ–¥–µ–ª–µ–π Ollama

```bash
# 1. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Ollama
docker-compose stop ollama

# 2. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π
# –ß–µ—Ä–µ–∑ Backrest –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ /backup-sources/data/ollama -> ./data/ollama

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
sudo chown -R 1000:1000 data/ollama

# 4. –ó–∞–ø—É—Å–∫ Ollama
docker-compose start ollama
```

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤

```bash
# –°—Ç–∞—Ç—É—Å –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker-compose logs --tail=50
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏

1. **Open WebUI**: http://localhost (–∏–ª–∏ –≤–∞—à –¥–æ–º–µ–Ω)
2. **Backrest**: http://localhost:9898
3. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**:
   ```bash
   docker-compose exec db psql -U postgres -d openwebui -c "SELECT COUNT(*) FROM users;"
   ```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö

- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –º–æ–¥–µ–ª–µ–π Ollama
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —á–∞—Ç—ã –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã

## üìù –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–†–µ–≥—É–ª—è—Ä–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–æ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤–æ–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –µ–∂–µ–º–µ—Å—è—á–Ω–æ
2. **–î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –í–µ–¥–∏—Ç–µ –∂—É—Ä–Ω–∞–ª –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –Ω–∞ –Ω–µ—É–¥–∞—á–Ω—ã–µ –±—ç–∫–∞–ø—ã
4. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: –•—Ä–∞–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ

## üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Backrest: `docker-compose logs backrest`
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏ –±—ç–∫–∞–ø–∞: `restic check`
3. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ Backrest: https://garethgeorge.github.io/backrest/
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º –∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º

---

**–í–∞–∂–Ω–æ**: –í—Å–µ–≥–¥–∞ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º!
EOF

    success "–°–æ–∑–¥–∞–Ω–æ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é: docs/local-backup-restore-guide.md"
}

# –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    log "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ ERNI-KI..."

    get_credentials
    check_backrest
    create_repository_instructions
    create_backup_plan_instructions
    create_test_backup_instructions
    create_restore_instructions

    echo ""
    success "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –±—ç–∫–∞–ø–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
    echo ""
    warning "–°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò:"
    echo "1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Backrest: $BACKREST_URL"
    echo "2. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –≤—ã—à–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –∏ –ø–ª–∞–Ω–∞"
    echo "3. –°–æ–∑–¥–∞–π—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –±—ç–∫–∞–ø"
    echo "4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ .config-backup/"
    echo ""
    echo "–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞:"
    echo "- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: admin"
    echo "- –ü–∞—Ä–æ–ª—å: $BACKREST_PASSWORD"
}

# –ó–∞–ø—É—Å–∫ —Å–∫—Ä–∏–ø—Ç–∞
main "$@"
