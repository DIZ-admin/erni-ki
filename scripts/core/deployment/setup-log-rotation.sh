#!/bin/bash
# ERNI-KI Log Rotation Setup Script
# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ —Å 7-–¥–Ω–µ–≤–Ω—ã–º retention

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
LOGROTATE_CONFIG="$PROJECT_ROOT/conf/logrotate/erni-ki"

echo "üîÑ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ ERNI-KI..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
if [ "$EUID" -eq 0 ]; then
    echo "‚ö†Ô∏è  –ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –æ—Ç root. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ sudo —Ç–æ–ª—å–∫–æ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏."
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
echo "üìÅ –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –¥–ª—è –ª–æ–≥–æ–≤..."
mkdir -p "$PROJECT_ROOT/logs"
mkdir -p "$PROJECT_ROOT/.config-backup/logs"
mkdir -p "$PROJECT_ROOT/monitoring/logs/critical"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è logrotate –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ ! -f "$LOGROTATE_CONFIG" ]; then
    echo "‚ùå –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è logrotate –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $LOGROTATE_CONFIG"
    exit 1
fi

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ logrotate
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ logrotate..."
if ! logrotate -d "$LOGROTATE_CONFIG" >/dev/null 2>&1; then
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ logrotate"
    logrotate -d "$LOGROTATE_CONFIG"
    exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –≤ —Å–∏—Å—Ç–µ–º—É (—Ç—Ä–µ–±—É–µ—Ç sudo)
echo "‚öôÔ∏è  –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ logrotate –≤ —Å–∏—Å—Ç–µ–º—É..."
if sudo cp "$LOGROTATE_CONFIG" /etc/logrotate.d/erni-ki; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è logrotate —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –≤ /etc/logrotate.d/erni-ki"
else
    echo "‚ùå –û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ logrotate"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
if sudo logrotate -d /etc/logrotate.d/erni-ki >/dev/null 2>&1; then
    echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è logrotate –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
else
    echo "‚ùå –û—à–∏–±–∫–∞ –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏"
    sudo logrotate -d /etc/logrotate.d/erni-ki
    exit 1
fi

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ª–æ–≥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
echo "üìù –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ –ª–æ–≥–∞..."
echo "$(date): Test log entry for rotation" >> "$PROJECT_ROOT/logs/test-rotation.log"

# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Ä–æ—Ç–∞—Ü–∏–∏
echo "üîÑ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ —Ä–æ—Ç–∞—Ü–∏–∏..."
if sudo logrotate -f /etc/logrotate.d/erni-ki; then
    echo "‚úÖ –¢–µ—Å—Ç–æ–≤–∞—è —Ä–æ—Ç–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ"
else
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –ø—Ä–∏ —Ç–µ—Å—Ç–æ–≤–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ (—ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ cron –∑–∞–¥–∞—á–∏ –¥–ª—è logrotate
echo "‚è∞ –ü—Ä–æ–≤–µ—Ä–∫–∞ cron –∑–∞–¥–∞—á–∏ –¥–ª—è logrotate..."
if crontab -l 2>/dev/null | grep -q logrotate; then
    echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ –¥–ª—è logrotate —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞"
else
    echo "‚ÑπÔ∏è  Logrotate –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ —Å–∏—Å—Ç–µ–º–Ω—ã–π cron (/etc/cron.daily/logrotate)"
fi

echo ""
echo "üéâ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
echo ""
echo "üìä –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:"
echo "   ‚Ä¢ –ï–∂–µ–¥–Ω–µ–≤–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ª–æ–≥–æ–≤"
echo "   ‚Ä¢ 7 –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–±—ã—á–Ω—ã—Ö –ª–æ–≥–æ–≤"
echo "   ‚Ä¢ 30 –¥–Ω–µ–π —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ª–æ–≥–æ–≤"
echo "   ‚Ä¢ –°–∂–∞—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö –ª–æ–≥–æ–≤"
echo "   ‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤"
echo ""
echo "üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ª–æ–≥–æ–≤:"
echo "   ‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏: $PROJECT_ROOT/logs/"
echo "   ‚Ä¢ –õ–æ–≥–∏ –±—ç–∫–∞–ø–æ–≤: $PROJECT_ROOT/.config-backup/logs/"
echo "   ‚Ä¢ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ª–æ–≥–∏: $PROJECT_ROOT/monitoring/logs/critical/"
echo ""
echo "üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:"
echo "   ‚Ä¢ –†—É—á–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è: sudo logrotate -f /etc/logrotate.d/erni-ki"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: sudo logrotate -d /etc/logrotate.d/erni-ki"
echo "   ‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç—É—Å–∞: sudo cat /var/lib/logrotate/status"
