# План аудита запуска проекта ERNI-KI

Этот документ описывает комплексный план аудита для подготовки проекта ERNI-KI к
запуску в эксплуатацию (Production). План составлен с учетом текущего
технологического стека (Docker, Node.js, Python, AI services) и лучших практик
DevOps и безопасности.

## 1. Архитектура и Инфраструктура

### 1.1. Контейнеризация и Оркестрация

- [ ] **Проверка Docker Compose**:
  - [ ] Убедиться, что все сервисы имеют зафиксированные версии образов (pinned
        versions/digests), избегая тега `latest`.
  - [ ] Проверить политики перезапуска (`restart: unless-stopped` или `always`).
  - [ ] Валидация конфигурации `watchtower`: убедиться, что автоматическое
        обновление отключено для критических сервисов (DB, Nginx, AI GPU
        services) в продакшене.
- [ ] **Управление ресурсами**:
  - [ ] Аудит лимитов CPU и Memory (`mem_limit`, `mem_reservation`, `cpus`) для
        всех контейнеров.
  - [ ] Проверка настроек OOM Killer (`oom_score_adj`) для критических сервисов
        (LiteLLM, Ollama).
- [ ] **GPU конфигурация**:
  - [ ] Проверка проброса GPU (NVIDIA runtime) для Ollama, OpenWebUI, Docling.
  - [ ] Тестирование совместимости версий драйверов CUDA.

### 1.2. Сеть и Хранение данных

- [ ] **Сетевая изоляция**:
  - [ ] Убедиться, что внутренние порты сервисов (DB, Redis, Metrics) доступны
        только через `127.0.0.1` или внутреннюю сеть Docker, и не выставлены
        наружу (кроме Nginx/Cloudflared).
- [ ] **Персистентность данных**:
  - [ ] Проверка всех Docker volumes на корректность монтирования.
  - [ ] Тестирование стратегии резервного копирования (сервис `backrest`):
    - [ ] Бэкап базы данных PostgreSQL.
    - [ ] Бэкап конфигураций и данных Redis.
    - [ ] Тестовое восстановление из бэкапа.

## 2. Безопасность (Security)

### 2.1. Управление секретами

- [ ] **Docker Secrets**:
  - [ ] Убедиться, что все пароли, API ключи и токены передаются через Docker
        Secrets, а не через переменные окружения (ENV).
  - [ ] Проверка отсутствия хардкода секретов в коде и конфигурационных файлах
        (использовать `.gitleaks.toml`).
- [ ] **Файлы окружения**:
  - [ ] Проверить права доступа к файлам в директории `env/`.
  - [ ] Убедиться, что `.env` файлы исключены из git (проверка `.gitignore`).

### 2.2. Безопасность контейнеров и приложений

- [ ] **Сканирование уязвимостей**:
  - [ ] Запуск Snyk или Trivy для проверки Docker образов и зависимостей
        (`npm audit`).
  - [ ] Анализ отчетов Checkov (`.checkov.yml`) для IaC.
- [ ] **Права доступа**:
  - [ ] Проверка запуска контейнеров от непривилегированных пользователей
        (non-root), где это возможно.
  - [ ] Аудит конфигурации Nginx (SSL/TLS, заголовки безопасности, rate
        limiting).
  - [ ] Проверка конфигурации Cloudflare Tunnel.

### 2.3. Аутентификация и Авторизация

- [ ] **Auth Service**:
  - [ ] Аудит JWT реализации (время жизни токенов, алгоритмы подписи).
  - [ ] Проверка механизмов защиты от перебора паролей (Rate Limiting).
- [ ] **Доступы к админ-панелям**:
  - [ ] Смена дефолтных паролей для Grafana, OpenWebUI, Portainer (если есть).

## 3. Качество кода и Процессы разработки

### 3.1. Тестирование

- [ ] **Unit тесты**:
  - [ ] Запуск `npm run test:unit` (Vitest). Проверка покрытия кода (Coverage >
        80% для критических модулей).
- [ ] **E2E тесты**:
  - [ ] Запуск `npm run test:e2e` (Playwright). Проверка основных
        пользовательских сценариев.
- [ ] **Линтинг и Статический анализ**:
  - [ ] Запуск `npm run lint` и `npm run type-check`. Устранение всех ошибок и
        предупреждений.
  - [ ] Проверка конфигурации `eslint-plugin-security`.

### 3.2. CI/CD

- [ ] **GitHub Actions**:
  - [ ] Аудит workflow файлов в `.github/workflows/`.
  - [ ] Проверка шагов сборки, тестирования и деплоя.
  - [ ] Наличие шагов автоматического релиз-менеджмента (`semantic-release`).

## 4. Наблюдаемость (Observability)

### 4.1. Логирование

- [ ] **Сбор логов**:
  - [ ] Проверка интеграции с Loki/Fluentd.
  - [ ] Убедиться, что логи критических сервисов (Tier 1) пишутся корректно и не
        теряются.
- [ ] **Политики хранения**:
  - [ ] Проверка ротации логов (`max-size`, `max-file` в `compose.yml`).
  - [ ] Проверка отсутствия чувствительных данных в логах (PII, токены).

### 4.2. Мониторинг и Алертринг

- [ ] **Prometheus & Grafana**:
  - [ ] Проверка сбора метрик со всех экспортеров (Node, Postgres, GPU).
  - [ ] Валидация дашбордов Grafana: наличие метрик по CPU, RAM, Disk, Network,
        Error Rates.
- [ ] **Alertmanager**:
  - [ ] Тестирование отправки алертов (Slack, PagerDuty).
  - [ ] Проверка правил алертинга (`alert_rules.yml`) на адекватность порогов.
- [ ] **Health Checks**:
  - [ ] Проверка корректности `healthcheck` скриптов в `compose.yml` для всех
        сервисов.

## 5. Документация и Комплаенс

### 5.1. Документация

- [ ] **Актуализация README**: Инструкции по запуску, переменные окружения.
- [ ] **Архитектурная схема**: Наличие актуальной схемы взаимодействия сервисов.
- [ ] **API документация**: Если есть публичные API, наличие Swagger/OpenAPI
      спецификаций.

### 5.2. Лицензирование

- [ ] Проверка лицензий используемых библиотек и Docker образов на совместимость
      с проектом.

## 6. План действий (Next Steps)

1.  Запустить автоматические сканеры безопасности (`npm run security:scan`).
2.  Провести нагрузочное тестирование (хотя бы минимальное) для проверки лимитов
    ресурсов.
3.  Выполнить тестовый прогон восстановления из бэкапа.
4.  Зафиксировать все найденные проблемы в трекере задач.
