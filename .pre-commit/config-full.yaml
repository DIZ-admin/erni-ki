# Pre-commit hooks configuration for ERNI-KI project
# Automated code quality checks before commits
# https://pre-commit.com/

minimum_pre_commit_version: "3.5.0"

default_language_version:
  python: python3.11
  node: "22.14.0"

default_stages: [pre-commit]

repos:
  # ===================================================================
  # BASIC FILE CHECKS
  # ===================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # Check trailing whitespace
      - id: trailing-whitespace
        args: [--markdown-linebreak-ext=md]
        exclude: |
          (?x)^(
            \.env.*|
            conf/litellm/config\.yaml|
            conf/.*\.conf|
            conf/.*\.ini|
            .*\.key|
            .*\.pem|
            .*\.crt|
            secrets/.*|
            data/.*|
            logs/.*|
            \.config-backup/.*
          )$

      # Check end-of-file
      - id: end-of-file-fixer
        exclude: |
          (?x)^(
            \.env.*|
            conf/litellm/config\.yaml|
            conf/.*\.conf|
            conf/.*\.ini|
            .*\.key|
            .*\.pem|
            .*\.crt|
            secrets/.*|
            data/.*|
            logs/.*|
            \.config-backup/.*
          )$

      # Check large files (>500KB)
      - id: check-added-large-files
        args: ["--maxkb=500"]
        exclude: |
          (?x)^(
            data/.*|
            logs/.*|
            \.config-backup/.*|
            node_modules/.*|
            .*\.pdf|
            .*\.zip|
            .*\.tar\.gz
          )$

      # Check merge conflicts
      - id: check-merge-conflict

      # Check case conflicts (important for Windows/macOS)
      - id: check-case-conflict

      # Check executable files have shebangs
      - id: check-executables-have-shebangs
        exclude: |
          (?x)^(
            node_modules/.*|
            \.git/.*
          )$

      # Check shebang scripts are executable
      - id: check-shebang-scripts-are-executable

  # ===================================================================
  # YAML AND JSON VALIDATION
  # ===================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v6.0.0
    hooks:
      # Validate YAML files
      - id: check-yaml
        args: [--allow-multiple-documents]
        exclude: |
          (?x)^(
            \.env.*|
            mkdocs\.yml|
            conf/litellm/config\.yaml|
            conf/.*\.yml|
            conf/.*\.yaml|
            data/.*|
            logs/.*|
            \.config-backup/.*
          )$

      # Validate JSON files
      - id: check-json
        exclude: |
          (?x)^(
            \.env.*|
            conf/.*\.json|
            data/.*|
            logs/.*|
            \.config-backup/.*|
            \.vscode/.*
          )$

      # Validate TOML syntax
      - id: check-toml
        exclude: |
          (?x)^(
            conf/.*\.toml|
            data/.*|
            logs/.*|
            \.config-backup/.*
          )$

  # ===================================================================
  # PRETTIER FORMATTING
  # ===================================================================
  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        name: "Prettier: code formatting"
        files: \.(md|yml|yaml|json|js|jsx|ts|tsx)$
        additional_dependencies:
          - prettier@3.6.2

  # ===================================================================
  # PYTHON LINTING/FORMATTING (RUFF)
  # ===================================================================
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.14.6
    hooks:
      - id: ruff
        name: "Ruff: Python lint"
        args: [--fix]

      - id: ruff-format
        name: "Ruff: Python format"

  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.8.0
    hooks:
      - id: mypy
        name: "mypy: static type check"
        additional_dependencies: [types-requests, types-PyYAML]
        args: ["--config-file", "mypy.ini", "--ignore-missing-imports"]
        exclude: ^webhook_handler\.py$|webhook-receiver|ops/ollama-exporter/app\.py|docs/examples/webhook-client-python\.py

  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.29.1
    hooks:
      - id: gitleaks

  # ===================================================================
  # SHELLCHECK
  # ===================================================================
  - repo: https://github.com/koalaman/shellcheck-precommit
    rev: v0.9.0
    hooks:
      - id: shellcheck
        args: ["--severity=error", "-e", "SC1091"]
        files: "\\.sh$"

  # ===================================================================
  # ESLINT CHECKS
  # ===================================================================
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v10.0.0-alpha.0
    hooks:
      - id: eslint
        name: "ESLint: TypeScript/JavaScript validation"
        files: \.(js|jsx|ts|tsx)$
        exclude: |
          (?x)^(
            node_modules/.*|
            dist/.*|
            build/.*|
            data/.*|
            logs/.*|
            \.config-backup/.*|
            vendor/.*|
            .*\.min\.js|
            .*\.pb\.js|
            .*\.pb\.ts
          )$
        additional_dependencies:
          - eslint@9.15.0
          - "@typescript-eslint/eslint-plugin@8.47.0"
          - "@typescript-eslint/parser@8.47.0"
          - eslint-plugin-security@3.0.1
          - eslint-plugin-n@17.13.2
          - eslint-plugin-promise@7.1.0
        args: [--fix]

  # ===================================================================
  # SECURITY AND SECRETS
  # ===================================================================
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.5.0
    hooks:
      - id: detect-secrets
        name: "Detect Secrets: find secrets in code"
        args: [
            "--baseline",
            ".secrets.baseline", # pragma: allowlist secret
            "--exclude-files",
            "scripts/redis-performance-optimization.sh|\\.pre-commit-config\\.yaml|conf/watchtower/notifications-examples\\.env",
          ]
        exclude: |
          (?x)^(
            \.env.*|
            conf/litellm/config\.yaml|
            conf/.*\.conf|
            conf/.*\.ini|
            .*\.key|
            .*\.pem|
            .*\.crt|
            secrets/.*|
            data/.*|
            logs/.*|
            \.config-backup/.*|
            node_modules/.*|
            package-lock\.json|
            \.secrets\.baseline|
            \.pre-commit/config-.*\.yaml
          )$

  # ===================================================================
  # COMMITLINT (COMMIT MESSAGE VALIDATION)
  # Disabled - handled by Husky in commitlint.config.cjs
  # ===================================================================

  # ===================================================================
  # ADDITIONAL CHECKS
  # ===================================================================
  - repo: https://github.com/pre-commit/pygrep-hooks
    rev: v1.10.0
    hooks:
      # Check for inline work markers in source code
      # Goal: All tasks are tracked in GitHub Issues, not in comments
      - id: python-check-blanket-noqa
        exclude: |
          (?x)^(
            data/.*|
            logs/.*|
            \.config-backup/.*
          )$

  # ===================================================================
  # LOCAL HOOKS
  # ===================================================================
  - repo: local
    hooks:
      # Language policy validation (moved from Husky/lint-staged)
      - id: language-check
        name: "Language: validate language policy"
        entry: bun run lint:language -- --all
        language: system
        pass_filenames: false
        stages: [pre-commit]

      # TypeScript type check (fast, no emit)
      - id: ts-type-check
        name: "TypeScript: type check"
        entry: npm run type-check
        language: system
        pass_filenames: false
        stages: [pre-commit]
        files: \.(ts|tsx)$

      # Docker Compose file validation
      - id: docker-compose-check
        name: "Docker Compose: configuration validation"
        entry: docker compose config -q
        language: system
        files: ^compose\.yml$
        pass_filenames: false
      # Check for inline work markers
      # Blocks commits with untracked work; create an Issue first
      - id: check-todo-fixme
        name: "Code Quality: no inline task markers"
        entry: bash
        language: system
        types: [text]
        pass_filenames: false
        args:
          - -c
          - |
            # Scan source files for inline task markers (TODO/FIXME), prefer ripgrep for speed
            if command -v rg >/dev/null 2>&1; then
              matches=$(rg --no-heading --line-number --glob '*.{py,js,ts,go,yml,yaml}' --iglob '!node_modules/**' --iglob '!.venv/**' --iglob '!site/**' --iglob '!*.pre-commit-config.yaml' "TODO|FIXME" || true)
            else
              matches=$(find . -type f \( -name "*.py" -o -name "*.js" -o -name "*.ts" -o -name "*.go" -o -name "*.yml" -o -name "*.yaml" \) ! -path "*/node_modules/*" ! -path "*/.venv/*" ! -path "*/site/*" ! -name ".pre-commit-config.yaml" -exec grep -Hn "TODO\\|FIXME" {} \; 2>/dev/null)
            fi
            matches=$(echo "$matches" | grep -v "pragma: allowlist todo" | head -20)
            if [[ -n "$matches" ]]; then
              echo "❌ Inline tasks detected; create a GitHub Issue instead of a comment."
              echo "$matches"
              exit 1
            fi

      # Go code formatting
      - id: gofmt
        name: "Go: code formatting"
        entry: gofmt
        language: system
        files: \.go$
        args: [-w]

      # Go imports organization
      - id: goimports
        name: "Go: organize imports"
        entry: bash
        language: system
        pass_filenames: false
        args:
          - -c
          - |
            set -euo pipefail
            if ! command -v go >/dev/null 2>&1; then
              echo "go toolchain is required for goimports" >&2
              exit 1
            fi
            GOPATH_BIN=$(go env GOPATH 2>/dev/null || true)
            if [[ -n "$GOPATH_BIN" ]]; then
              export PATH="$PATH:$GOPATH_BIN/bin"
            fi
            if ! command -v goimports >/dev/null 2>&1; then
              go install golang.org/x/tools/cmd/goimports@latest
            fi
            if ! command -v goimports >/dev/null 2>&1; then
              git ls-files "*.go" | xargs -r go run golang.org/x/tools/cmd/goimports@latest -w
            else
              git ls-files "*.go" | xargs -r goimports -w
            fi

      # Detect duplicate basenames in scripts/ and conf/
      - id: check-duplicate-basenames
        name: "Dupes: scripts/conf basenames"
        entry: python3 scripts/maintenance/check_duplicate_basenames.py
        language: system
        pass_filenames: false

      # Validate status snippet is up-to-date
      - id: status-snippet-check
        name: "Docs: validate status snippets"
        entry: python3 scripts/docs/update_status_snippet.py --check
        language: system
        pass_filenames: false
        files: |
          (?x)^(
            docs/reference/status\.yml|
            docs/reference/status-snippet\.md|
            docs/de/reference/status-snippet\.md|
            docs/de/index\.md|
            docs/(index|overview)\.md|
            README\.md
          )$

      # Check archive/data README coverage
      - id: archive-readme-check
        name: "Docs: archive/data README coverage"
        entry: python3 scripts/docs/check_archive_readmes.py
        language: system
        pass_filenames: false

      - id: markdownlint-cli2
        name: "Docs: markdownlint"
        entry: npx markdownlint-cli2
        language: node
        files: \.(md|markdown)$
        additional_dependencies:
          - markdownlint-cli2@0.19.1

      - id: visuals-and-links-check
        name: "Docs: visuals/TOC/link check"
        entry: python3 scripts/docs/visuals_and_links_check.py
        language: system
        pass_filenames: false

      # Check for temporary files
      - id: check-temporary-files
        name: "Cleanup: prevent .tmp and temporary files from being committed"
        entry: bash
        language: system
        types: [text]
        pass_filenames: false
        args:
          - -c
          - |
            # Check for .tmp files and other temporary artifacts
            if find . -type d \( -path "./.git" -o -path "./node_modules" -o -path "./.venv" -o -path "./site" -o -path "./coverage" \) -prune -o -type f \( -name "*.tmp" -o -name "*~" -o -name "*.bak" -o -name ".DS_Store" \) -print | head -1 | grep -q .; then
              echo "❌ Found temporary files that should not be committed:"
              find . -type d \( -path "./.git" -o -path "./node_modules" -o -path "./.venv" -o -path "./site" -o -path "./coverage" \) -prune -o -type f \( -name "*.tmp" -o -name "*~" -o -name "*.bak" -o -name ".DS_Store" \) -print | head -20
              echo ""
              echo "Please remove these files before committing."
              exit 1
            fi

      # Validate documentation metadata
      - id: validate-docs-metadata
        name: "Docs: validate metadata"
        entry: python3 scripts/docs/validate_metadata.py
        language: system
        pass_filenames: false
        files: ^docs/.*\.md$

      # Prevent accidental Finder/OS duplicates like "file 2.md"
      - id: forbid-numbered-copies
        name: "Docs: forbid numbered filename copies"
        entry: bash
        language: system
        files: ^docs/.*$
        args:
          - -c
          - |
            status=0
            for f in "$@"; do
              base="${f##*/}"
              if [[ "$base" =~ [[:space:]][0-9]+(\.|$) ]]; then
                echo "Duplicate-style filename detected: $f"
                status=1
              fi
            done
            exit $status

      # Forbid Finder-style duplicate filenames anywhere in repo (except ignored dirs)
      - id: forbid-numbered-copies-any
        name: "Repo: forbid numbered filename copies"
        entry: bash
        language: system
        pass_filenames: false
        args:
          - -c
          - |
            status=0
            find -E . \
              -path './.git' -prune -o \
              -path './node_modules' -prune -o \
              -path './.venv' -prune -o \
              -path './site' -prune -o \
              -regex '.* [0-9]+(\.[^/]+)?' -print | while read -r f; do
                echo "Duplicate-style filename detected: $f"
                status=1
              done
            exit $status

      # Validate no emoji in project files
      - id: no-emoji-in-files
        name: "Docs: validate no emoji"
        entry: python3 scripts/validate-no-emoji.py
        language: system
        files: \.(md|txt)$
        exclude: |
          (?x)^(
            node_modules/.*|
            \.venv/.*|
            site/.*|
            data/.*|
            \.config-backup/.*
          )$

      # Check secret file permissions (security)
      - id: check-secret-permissions
        name: "Security: check secret file permissions"
        entry: scripts/security/check-secret-permissions.sh
        language: script
        pass_filenames: false
