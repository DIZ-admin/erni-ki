# üîí –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ ERNI-KI

## –û–±–∑–æ—Ä

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã ERNI-KI, –≤–∫–ª—é—á–∞—è —Å–µ—Ç–µ–≤—É—é –∏–∑–æ–ª—è—Ü–∏—é, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏, –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è.

## üåê –°–µ—Ç–µ–≤–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–µ—Ç–∏

ERNI-KI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å–µ—Ç–µ–≤—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:

#### üîµ Frontend —Å–µ—Ç—å (`erni-ki-frontend`)
- **–ü–æ–¥—Å–µ—Ç—å**: 172.20.0.0/16
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã –∏ –≤–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø
- **–°–µ—Ä–≤–∏—Å—ã**: auth, nginx, openwebui, litellm, searxng, docling, tika, edgetts, mcposerver, cloudflared

#### üî¥ Backend —Å–µ—Ç—å (`erni-ki-backend`)
- **–ü–æ–¥—Å–µ—Ç—å**: 172.21.0.0/16
- **–ò–∑–æ–ª—è—Ü–∏—è**: `internal: true` - –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –≤–Ω–µ—à–Ω–µ–º—É –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å–µ—Ä–≤–∏—Å—ã
- **–°–µ—Ä–≤–∏—Å—ã**: db, redis, ollama, backrest + –º—É–ª—å—Ç–∏—Å–µ—Ç–µ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã

#### ‚ö™ Default —Å–µ—Ç—å (`erni-ki_default`)
- **–ü–æ–¥—Å–µ—Ç—å**: 172.18.0.0/16
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–ª—É–∂–µ–±–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã
- **–°–µ—Ä–≤–∏—Å—ã**: watchtower

#### üìä Monitoring —Å–µ—Ç—å (`erni-ki-monitoring`)
- **–ü–æ–¥—Å–µ—Ç—å**: 172.19.0.0/16
- **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ**: –°–∏—Å—Ç–µ–º–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
- **–°–µ—Ä–≤–∏—Å—ã**: prometheus, grafana, alertmanager, node-exporter, cadvisor, etc.

### –ú—É–ª—å—Ç–∏—Å–µ—Ç–µ–≤—ã–µ —Å–µ—Ä–≤–∏—Å—ã

–°–ª–µ–¥—É—é—â–∏–µ —Å–µ—Ä–≤–∏—Å—ã –∏–º–µ—é—Ç –¥–æ—Å—Ç—É–ø –∫ –Ω–µ—Å–∫–æ–ª—å–∫–∏–º —Å–µ—Ç—è–º:
- **nginx**: frontend + backend (–ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä)
- **openwebui**: frontend + backend (–æ—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
- **litellm**: frontend + backend (AI gateway)
- **searxng**: frontend + backend (–ø–æ–∏—Å–∫–æ–≤—ã–π –¥–≤–∏–∂–æ–∫)

## üîê –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–∞–º–∏

### Docker Secrets

–ü–∞—Ä–æ–ª–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `secrets/` —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞ 600:

```bash
secrets/
‚îú‚îÄ‚îÄ postgres_password.txt    # –ü–∞—Ä–æ–ª—å PostgreSQL
‚îú‚îÄ‚îÄ redis_password.txt       # –ü–∞—Ä–æ–ª—å Redis
‚îî‚îÄ‚îÄ backrest_password.txt    # –ü–∞—Ä–æ–ª—å Backrest
```

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤ compose.yml

```yaml
secrets:
  postgres_password:
    file: ./secrets/postgres_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  backrest_password:
    file: ./secrets/backrest_password.txt
```

### –†–æ—Ç–∞—Ü–∏—è –ø–∞—Ä–æ–ª–µ–π

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏:

```bash
# –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫
./scripts/rotate-secrets.sh --dry-run

# –†–æ—Ç–∞—Ü–∏—è –≤—Å–µ—Ö –ø–∞—Ä–æ–ª–µ–π
./scripts/rotate-secrets.sh

# –†–æ—Ç–∞—Ü–∏—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞
./scripts/rotate-secrets.sh --service postgres
```

## üõ°Ô∏è Security Headers –≤ Nginx

### –ù–∞—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏

```nginx
# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤–µ—Ä—Å–∏–∏ Nginx
server_tokens off;

# Security headers - –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
add_header X-Frame-Options DENY always;
add_header X-Content-Type-Options nosniff always;
add_header X-XSS-Protection "1; mode=block" always;
add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;
add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; img-src 'self' data:; style-src 'self' 'unsafe-inline'; font-src 'self'; connect-src 'self';" always;
```

### Rate Limiting

```nginx
# Rate limiting - –∑–∞—â–∏—Ç–∞ –æ—Ç DDoS –∏ –±—Ä—É—Ç—Ñ–æ—Ä—Å –∞—Ç–∞–∫
limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=login:10m rate=1r/s;
limit_req_zone $binary_remote_addr zone=general:10m rate=30r/s;
limit_req_zone $binary_remote_addr zone=searxng_web:10m rate=5r/s;
limit_req_zone $binary_remote_addr zone=searxng_api:10m rate=10r/s;
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

### Security Alerts

–ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –∞–ª–µ—Ä—Ç—ã –≤ `monitoring/security_alerts.yml`:

- **HighErrorRate**: –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å 5xx –æ—à–∏–±–æ–∫
- **SuspiciousLoginAttempts**: –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏ –≤—Ö–æ–¥–∞
- **UnauthorizedAPIAccess**: –ù–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ API
- **RateLimitingTriggered**: –ß–∞—Å—Ç–æ–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ rate limiting
- **HighTrafficVolume**: –ù–µ–æ–±—ã—á–Ω–æ –≤—ã—Å–æ–∫–∏–π –æ–±—ä–µ–º —Ç—Ä–∞—Ñ–∏–∫–∞
- **SSLCertificateExpiring**: –ò—Å—Ç–µ—á–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞

### –°–∏—Å—Ç–µ–º–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã

- **HighCPUUsage**: –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CPU
- **HighMemoryUsage**: –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏
- **HighNetworkTraffic**: –ü–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–∞—è —Å–µ—Ç–µ–≤–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å
- **DatabaseConnectionsHigh**: –í—ã—Å–æ–∫–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –ë–î
- **RedisMemoryHigh**: –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ Redis
- **OllamaDown**: –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Ollama —Å–µ—Ä–≤–∏—Å–∞

## ‚öôÔ∏è –†–µ—Å—É—Ä—Å–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã

```yaml
# PostgreSQL
deploy:
  resources:
    limits:
      memory: 4G
      cpus: "2.0"
    reservations:
      memory: 1G
      cpus: "0.5"

# Ollama (GPU)
deploy:
  resources:
    limits:
      memory: 8G
      cpus: "4.0"
    reservations:
      memory: 2G
      cpus: "1.0"
```

### –í–µ–±-—Å–µ—Ä–≤–∏—Å—ã

```yaml
# OpenWebUI
deploy:
  resources:
    limits:
      memory: 2G
      cpus: "1.0"
    reservations:
      memory: 512M
      cpus: "0.5"
```

## üîß –ü—Ä–æ—Ü–µ–¥—É—Ä—ã –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è

### –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏

1. **–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ**:
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–ª–µ—Ä—Ç–æ–≤
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤

2. **–ï–∂–µ–º–µ—Å—è—á–Ω–æ**:
   - –†–æ—Ç–∞—Ü–∏—è –ø–∞—Ä–æ–ª–µ–π
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
   - –ê—É–¥–∏—Ç —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

3. **–ï–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ**:
   - –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ–¥—É—Ä –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
   - –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

### –ö–æ–º–∞–Ω–¥—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose ps

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ç–µ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
docker network ls | grep erni-ki

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
docker-compose logs nginx | grep -E "(40[0-9]|50[0-9])"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ—Å—É—Ä—Å–æ–≤
docker stats --no-stream
```

## üö® –ü—Ä–æ—Ü–µ–¥—É—Ä—ã —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –∏–Ω—Ü–∏–¥–µ–Ω—Ç—ã

### –ü—Ä–∏ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–∏ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

1. **–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ Nginx –∏ –∞–ª–µ—Ä—Ç—ã
   - –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ IP —á–µ—Ä–µ–∑ rate limiting
   - –£–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞

2. **–í —Ç–µ—á–µ–Ω–∏–µ —á–∞—Å–∞**:
   - –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–∞—Å—à—Ç–∞–± –∏–Ω—Ü–∏–¥–µ–Ω—Ç–∞
   - –ü—Ä–∏–º–µ–Ω–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã –∑–∞—â–∏—Ç—ã
   - –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Ü–∏–¥–µ–Ω—Ç

3. **–í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è**:
   - –ü—Ä–æ–≤–µ—Å—Ç–∏ –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑
   - –û–±–Ω–æ–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
   - –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –æ—Ç—á–µ—Ç

### –ö–æ–Ω—Ç–∞–∫—Ç—ã —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏—è

- **–°–∏—Å—Ç–µ–º–Ω—ã–π –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä**: [—É–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã]
- **–°–ª—É–∂–±–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏**: [—É–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã]
- **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞**: [—É–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç—ã]
