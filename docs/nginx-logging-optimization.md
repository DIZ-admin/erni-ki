# üìä –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è nginx –¥–ª—è ERNI-KI

> **–í–µ—Ä—Å–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞:** 1.0  
> **–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-08-12  
> **–ê–≤—Ç–æ—Ä:** –ê–ª—å—Ç—ç–æ–Ω –®—É–ª—å—Ü, Tech Lead-–ú—É–¥—Ä–µ—Ü  
> **–°—Ç–∞—Ç—É—Å:** Production Ready

## üìã –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ ERNI-KI –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ nginx –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –æ–±—ä–µ–º–∞ –ª–æ–≥–æ–≤ –∏ —Ñ–æ–∫—É—Å–∏—Ä–æ–≤–∫–∏ –Ω–∞ –≤–∞–∂–Ω—ã—Ö —Å–æ–±—ã—Ç–∏—è—Ö. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã —É—Å–ª–æ–≤–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.

## üéØ –¶–µ–ª–∏ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

- **–£–º–µ–Ω—å—à–µ–Ω–∏–µ –æ–±—ä–µ–º–∞ –ª–æ–≥–æ–≤** –Ω–∞ 70-90% –∑–∞ —Å—á–µ—Ç —É—Å–ª–æ–≤–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- **–§–æ–∫—É—Å –Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞—Ö** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ –æ—à–∏–±–æ–∫ –∏ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ** - JSON —Ñ–æ—Ä–º–∞—Ç—ã –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å** - –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –≤–ª–∏—è–Ω–∏–µ –Ω–∞ –≤—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ (<5ms)

## üèóÔ∏è –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### –û—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –§–æ—Ä–º–∞—Ç | –£—Å–ª–æ–≤–∏–µ |
|------|------------|--------|---------|
| `access.log` | –í—Å–µ HTTP –∑–∞–ø—Ä–æ—Å—ã | combined | –í—Å–µ–≥–¥–∞ |
| `error.log` | –û—à–∏–±–∫–∏ nginx | default | –û—à–∏–±–∫–∏ |
| `rate_limit.log` | Rate limiting —Å–æ–±—ã—Ç–∏—è | rate_limit_json | status=429 |
| `upstream_errors.log` | –û—à–∏–±–∫–∏ upstream | upstream_errors | status=5xx |

### –°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ª–æ–≥–∏

| –§–∞–π–ª | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ | –§–æ—Ä–º–∞—Ç | –£—Å–ª–æ–≤–∏–µ |
|------|------------|--------|---------|
| `websocket.log` | WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è | combined | location=/ws/ |
| `files_upload.log` | –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ | combined | location=/api/v1/files/ |
| `searxng_issues.log` | SearXNG –æ—à–∏–±–∫–∏ | searxng_detailed | status=4xx,5xx |
| `searxng_slow.log` | –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã | searxng_detailed | time>2s |

## üìù –§–æ—Ä–º–∞—Ç—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### combined (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π)
```nginx
log_format combined '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent"';
```

### rate_limit_json (JSON –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞)
```nginx
log_format rate_limit_json escape=json '{'
  '"timestamp":"$time_iso8601",'
  '"remote_addr":"$remote_addr",'
  '"request":"$request",'
  '"status":$status,'
  '"request_time":$request_time,'
  '"upstream_response_time":"$upstream_response_time",'
  '"user_agent":"$http_user_agent",'
  '"referer":"$http_referer",'
  '"host":"$host"'
'}';
```

### searxng_detailed (–¥–µ—Ç–∞–ª—å–Ω—ã–π –¥–ª—è SearXNG)
```nginx
log_format searxng_detailed '$time_iso8601 [$status] $request_method $request_uri '
                           'response_time: $request_time upstream_time: $upstream_response_time '
                           'client: $remote_addr query: "$args" user_agent: "$http_user_agent"';
```

### upstream_errors (–æ—à–∏–±–∫–∏ upstream)
```nginx
log_format upstream_errors '$time_iso8601 [$status] $request_method $scheme://$host$request_uri '
                          'upstream: $upstream_addr response_time: $upstream_response_time '
                          'client: $remote_addr user_agent: "$http_user_agent"';
```

## ‚öôÔ∏è –£—Å–ª–æ–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

```nginx
# Rate limiting —Å–æ–±—ã—Ç–∏—è
map $status $rate_limit_log {
    429 1;
    default 0;
}

# Upstream –æ—à–∏–±–∫–∏
map $status $log_upstream_errors {
    ~^5 1; # 5xx –æ—à–∏–±–∫–∏
    default 0;
}

# SearXNG –ø—Ä–æ–±–ª–µ–º—ã
map $status $log_searxng_issues {
    ~^[45] 1;  # 4xx –∏ 5xx –æ—à–∏–±–∫–∏
    default 0;
}

# –ú–µ–¥–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
map $request_time $log_slow_requests {
    ~^[2-9] 1;     # 2+ —Å–µ–∫—É–Ω–¥
    ~^[0-9][0-9] 1; # 10+ —Å–µ–∫—É–Ω–¥
    default 0;
}
```

### –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —É—Å–ª–æ–≤–∏–π

```nginx
# –û—Å–Ω–æ–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
access_log /var/log/nginx/access.log combined;

# –£—Å–ª–æ–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
access_log /var/log/nginx/rate_limit.log rate_limit_json if=$rate_limit_log;
access_log /var/log/nginx/upstream_errors.log upstream_errors if=$log_upstream_errors;
access_log /var/log/nginx/searxng_issues.log searxng_detailed if=$log_searxng_issues;
access_log /var/log/nginx/searxng_slow.log searxng_detailed if=$log_slow_requests;
```

## üîß –ù–µ–¥–∞–≤–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è (2025-08-12)

### WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫–∞
- **–ü—Ä–æ–±–ª–µ–º–∞**: 502 –æ—à–∏–±–∫–∏ –¥–ª—è `/ws/socket.io/` endpoints
- **–†–µ—à–µ–Ω–∏–µ**: –î–æ–±–∞–≤–ª–µ–Ω—ã dedicated WebSocket locations
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ 502 –æ—à–∏–±–∫–∏ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

```nginx
location /ws/ {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
    proxy_cache_bypass $http_upgrade;
    proxy_send_timeout 3600s;
    proxy_read_timeout 3600s;
    access_log /var/log/nginx/websocket.log combined;
}
```

### –£–≤–µ–ª–∏—á–µ–Ω–Ω—ã–µ timeout –¥–ª—è —Ñ–∞–π–ª–æ–≤
- **–ü—Ä–æ–±–ª–µ–º–∞**: 504 timeout –æ—à–∏–±–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –±–æ–ª—å—à–∏—Ö RAG –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
- **–†–µ—à–µ–Ω–∏–µ**: –£–≤–µ–ª–∏—á–µ–Ω—ã timeout –∑–Ω–∞—á–µ–Ω–∏—è —Å 300s –¥–æ 900s (15 –º–∏–Ω—É—Ç)
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –£—Å–ø–µ—à–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –¥–æ 100MB

```nginx
location ~ ^/api/v1/files(/.*)?$ {
    proxy_connect_timeout 60s;
    proxy_send_timeout 900s;    # 15 –º–∏–Ω—É—Ç
    proxy_read_timeout 900s;    # 15 –º–∏–Ω—É—Ç
    client_body_timeout 600s;   # 10 –º–∏–Ω—É—Ç
    access_log /var/log/nginx/files_upload.log combined;
}
```

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```bash
# –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ rate limiting
./scripts/monitor-rate-limiting.sh
```

**–§—É–Ω–∫—Ü–∏–∏ —Å–∫—Ä–∏–ø—Ç–∞:**
- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ endpoints –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –º–∏–Ω—É—Ç
- –ü—Ä–æ—Ü–µ–Ω—Ç rate limiting —Å –∞–ª–µ—Ä—Ç–∞–º–∏ –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 80%
- –¢–æ–ø 10 IP –∞–¥—Ä–µ—Å–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –∑–∞–ø—Ä–æ—Å–æ–≤
- –†–∞–∑–º–µ—Ä—ã –ª–æ–≥–æ–≤ –∏ —Å—Ç–∞—Ç—É—Å nginx
- –¶–≤–µ—Ç–Ω–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è –ø—Ä–æ–±–ª–µ–º

### –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- **Rate limiting**: <80% - –Ω–æ—Ä–º–∞, >80% - –∞–ª–µ—Ä—Ç
- **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞**: <100ms –¥–ª—è nginx, <2s –¥–ª—è SearXNG
- **–†–∞–∑–º–µ—Ä—ã –ª–æ–≥–æ–≤**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–æ—Ç–∞—Ü–∏—è –ø—Ä–∏ >10MB
- **Upstream –æ—à–∏–±–∫–∏**: <5% –æ—Ç –æ–±—â–µ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

## üöÄ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
1. **–£—Å–ª–æ–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ** - —É–º–µ–Ω—å—à–∞–µ—Ç –æ–±—ä–µ–º –Ω–∞ 70-90%
2. **–°–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã** - —Ç–æ–ª—å–∫–æ –Ω—É–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
3. **–û—Ç–¥–µ–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã** - –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –ø—Ä–æ–±–ª–µ–º
4. **JSON —Ñ–æ—Ä–º–∞—Ç** - –ª–µ–≥–∫–∏–π –ø–∞—Ä—Å–∏–Ω–≥ –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

### –í–ª–∏—è–Ω–∏–µ –Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- **–û—Å–Ω–æ–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: <1ms –∑–∞–¥–µ—Ä–∂–∫–∏
- **–£—Å–ª–æ–≤–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: <0.1ms –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
- **–û–±—â–µ–µ –≤–ª–∏—è–Ω–∏–µ**: <5% CPU –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- **–í—Ä–µ–º—è –æ—Ç–∫–ª–∏–∫–∞ nginx**: 5-10ms (–æ—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)

## üõ†Ô∏è –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
```bash
# –†–∞–∑–º–µ—Ä—ã –ª–æ–≥–æ–≤
docker exec erni-ki-nginx-1 ls -lh /var/log/nginx/

# –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏ access.log
docker logs --tail=20 erni-ki-nginx-1

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
curl -k https://localhost/api/searxng/nonexistent  # –°–æ–∑–¥–∞—Å—Ç –∑–∞–ø–∏—Å—å –≤ searxng_issues.log

# –¢–µ—Å—Ç WebSocket
curl -k -H "Connection: Upgrade" -H "Upgrade: websocket" https://localhost/ws/socket.io/
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ access.log
docker logs -f erni-ki-nginx-1

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫
docker exec erni-ki-nginx-1 tail -f /var/log/nginx/upstream_errors.log

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ rate limiting
docker exec erni-ki-nginx-1 tail -f /var/log/nginx/rate_limit.log
```

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

### –î–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –û–±—ä–µ–º –ª–æ–≥–æ–≤: ~500MB/–¥–µ–Ω—å
- –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–±–ª–µ–º: 10-15 –º–∏–Ω—É—Ç
- –õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∞–ª–µ—Ä—Ç–æ–≤: 30-40%

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- –û–±—ä–µ–º –ª–æ–≥–æ–≤: ~50-100MB/–¥–µ–Ω—å (—Å–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞ 80-90%)
- –í—Ä–µ–º—è –ø–æ–∏—Å–∫–∞ –ø—Ä–æ–±–ª–µ–º: 2-3 –º–∏–Ω—É—Ç—ã
- –õ–æ–∂–Ω—ã–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏—è –∞–ª–µ—Ä—Ç–æ–≤: <5%
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ rate limiting >80%

---

**–ê–≤—Ç–æ—Ä:** –ê–ª—å—Ç—ç–æ–Ω –®—É–ª—å—Ü, Tech Lead-–ú—É–¥—Ä–µ—Ü  
**–î–∞—Ç–∞:** 2025-08-12  
**–í–µ—Ä—Å–∏—è:** 1.0
