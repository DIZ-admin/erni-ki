# Docker Log Rotation –¥–ª—è ERNI-KI

## –û–ø–∏—Å–∞–Ω–∏–µ

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ä–æ—Ç–∞—Ü–∏–∏ –ª–æ–≥–æ–≤ Docker –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è
–Ω–µ–∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º–æ–≥–æ —Ä–æ—Å—Ç–∞ –¥–∏—Å–∫–æ–≤–æ–≥–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞.

## –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ì–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (daemon.json)

–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å `/etc/docker/daemon.json`:

```json
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
```

–ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Docker:

```bash
sudo systemctl restart docker
```

**–≠—Ñ—Ñ–µ–∫—Ç:** –ö–∞–∂–¥—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—É–¥–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –º–∞–∫—Å–∏–º—É–º 3 —Ñ–∞–π–ª–∞ –ø–æ 10 MB (30 MB –Ω–∞
–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä).

---

### –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ (compose.yml)

–î–æ–±–∞–≤–∏—Ç—å –≤ –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å –≤ `compose.yml`:

```yaml
services:
  openwebui:
    # ... –æ—Å—Ç–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
    logging:
      driver: 'json-file'
      options:
        max-size: '10m'
        max-file: '3'
```

#### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Ä–∞–∑–º–µ—Ä–∞–º –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤:

**–í—ã—Å–æ–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã (–±–æ–ª—å—à–µ –ª–æ–≥–æ–≤):**

- `openwebui`, `ollama`, `nginx`, `litellm`

```yaml
logging:
  driver: 'json-file'
  options:
    max-size: '20m'
    max-file: '5'
```

**–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**

- `postgres`, `redis`, `prometheus`, `grafana`

```yaml
logging:
  driver: 'json-file'
  options:
    max-size: '10m'
    max-file: '3'
```

**–ù–∏–∑–∫–æ–Ω–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã:**

- `backrest`, `webhook`, `watchtower`

```yaml
logging:
  driver: 'json-file'
  options:
    max-size: '5m'
    max-file: '2'
```

---

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ì–ª–æ–±–∞–ª—å–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

```bash
# 1. –°–æ–∑–¥–∞—Ç—å backup —Ç–µ–∫—É—â–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sudo cp /etc/docker/daemon.json /etc/docker/daemon.json.backup-$(date +%Y%m%d) 2>/dev/null || true

# 2. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
sudo tee /etc/docker/daemon.json > /dev/null << 'EOF'
{
  "log-driver": "json-file",
  "log-opts": {
    "max-size": "10m",
    "max-file": "3"
  }
}
EOF

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Docker
sudo systemctl restart docker

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
sudo systemctl status docker

# 5. –ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –Ω–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
cd /home/konstantin/Documents/augment-projects/erni-ki
docker compose up -d --force-recreate
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤ compose.yml

```bash
# 1. –°–æ–∑–¥–∞—Ç—å backup
cp compose.yml .config-backup/compose.yml.backup-$(date +%Y%m%d-%H%M%S)

# 2. –î–æ–±–∞–≤–∏—Ç—å logging –≤ –∫–∞–∂–¥—ã–π —Å–µ—Ä–≤–∏—Å (–≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ sed)
# –ü—Ä–∏–º–µ—Ä –¥–ª—è –æ–¥–Ω–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞:
# services:
#   openwebui:
#     logging:
#       driver: "json-file"
#       options:
#         max-size: "10m"
#         max-file: "3"

# 3. –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
docker compose up -d --force-recreate
```

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
docker inspect erni-ki-openwebui-1 | grep -A 10 "LogConfig"

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker ps -q | xargs -I {} sh -c 'echo "Container: {}"; docker inspect {} | grep -A 5 "LogPath" | grep LogPath | cut -d\" -f4 | xargs ls -lh 2>/dev/null'

# –û–±—â–∏–π —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ Docker
sudo du -sh /var/lib/docker/containers/*/
```

---

## –û—á–∏—Å—Ç–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –ª–æ–≥–æ–≤

```bash
# –í–ù–ò–ú–ê–ù–ò–ï: –£–¥–∞–ª–∏—Ç –≤—Å–µ —Ç–µ–∫—É—â–∏–µ –ª–æ–≥–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤!

# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose down

# –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥–∏
sudo truncate -s 0 /var/lib/docker/containers/*/*-json.log

# –ó–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã
docker compose up -d
```

---

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–î–æ–±–∞–≤–∏—Ç—å –≤ `scripts/monitor-disk-space.sh`:

```bash
# –†–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤ Docker
DOCKER_LOGS_SIZE=$(sudo du -sh /var/lib/docker/containers/ 2>/dev/null | awk '{print $1}')
echo "$(date '+%Y-%m-%d %H:%M:%S') - Docker logs: $DOCKER_LOGS_SIZE" >> "$LOG_FILE"
```

---

## –†–∞—Å—á—ë—Ç —ç–∫–æ–Ω–æ–º–∏–∏

**–ë–µ–∑ —Ä–æ—Ç–∞—Ü–∏–∏:**

- 49 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ √ó ~100 MB –ª–æ–≥–æ–≤ = ~5 GB

**–° —Ä–æ—Ç–∞—Ü–∏–µ–π (10m √ó 3):**

- 49 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ √ó 30 MB = ~1.5 GB
- **–≠–∫–æ–Ω–æ–º–∏—è: ~3.5 GB**

---

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. ‚úÖ **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É** —á–µ—Ä–µ–∑ `/etc/docker/daemon.json` -
   –ø—Ä–æ—â–µ –∏ –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–Ω–æ
2. ‚úÖ **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** —Ä–∞–∑–º–µ—Ä–∞ –ª–æ–≥–æ–≤ —á–µ—Ä–µ–∑ `monitor-disk-space.sh`
3. ‚úÖ **–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å** —Ä–∞–∑–º–µ—Ä –ª–æ–≥–æ–≤:
   `sudo du -sh /var/lib/docker/containers/`
4. ‚ö†Ô∏è **–ù–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è** - –º–æ–∂–Ω–æ –ø–æ—Ç–µ—Ä—è—Ç—å –≤–∞–∂–Ω—ã–µ
   –ª–æ–≥–∏ –ø—Ä–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ
5. ‚ö†Ô∏è **–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è

---

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –¥—Ä–∞–π–≤–µ—Ä—ã –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

### Syslog (–¥–ª—è —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è)

```yaml
logging:
  driver: 'syslog'
  options:
    syslog-address: 'tcp://localhost:514'
    tag: '{{.Name}}'
```

### Local (–±–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π, —á–µ–º json-file)

```yaml
logging:
  driver: 'local'
  options:
    max-size: '10m'
    max-file: '3'
```

---

**–°—Ç–∞—Ç—É—Å:** üìù –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞  
**–ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ:** –¢—Ä–µ–±—É–µ—Ç —Ä—É—á–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏)
