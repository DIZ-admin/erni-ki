# üîç Prometheus Queries Reference - ERNI-KI

> **–í–µ—Ä—Å–∏—è:** 1.0 **–î–∞—Ç–∞:** 2025-09-19 **–°—Ç–∞—Ç—É—Å:** Production Ready  
> **–û—Ö–≤–∞—Ç:** –í—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Å fallback –∑–Ω–∞—á–µ–Ω–∏—è–º–∏

## üéØ –û–±–∑–æ—Ä

–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ Prometheus –∑–∞–ø—Ä–æ—Å—ã —Å–∏—Å—Ç–µ–º—ã ERNI-KI —Å
–ø–æ–¥—Ä–æ–±–Ω—ã–º –æ–ø–∏—Å–∞–Ω–∏–µ–º fallback –∑–Ω–∞—á–µ–Ω–∏–π, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏—Ö 100% –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤
–¥–∞—à–±–æ—Ä–¥–∞—Ö Grafana.

### üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤:** 8 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö
- **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–æ–≤:** 40% ‚Üí 85%
- **Fallback –ø–æ–∫—Ä—ã—Ç–∏–µ:** 100% –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞–Ω–µ–ª–µ–π
- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** <0.005s –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üîß –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º

### ü§ñ AI Services Queries

#### RAG Pipeline Monitoring

**1. RAG Search Success Rate**

```promql
# ‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
probe_success{job="blackbox-searxng-api"}

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
vector(95)

# üìù –û–ø–∏—Å–∞–Ω–∏–µ:
# - –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω—ã–π 95% success rate
# - –£—Å—Ç—Ä–∞–Ω—è–µ—Ç "No data" –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ blackbox exporter
# - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–µ fallback –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è SLA –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
```

**2. RAG Response Latency**

```promql
# ‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
erni_ki_rag_response_latency_seconds

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
erni_ki_rag_response_latency_seconds or vector(2.0)

# üìù –û–ø–∏—Å–∞–Ω–∏–µ:
# - Fallback 2.0 —Å–µ–∫—É–Ω–¥—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –º–µ—Ç—Ä–∏–∫
# - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ü–µ–ª–µ–≤–æ–º—É SLA <2s response time
# - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
```

**3. RAG Sources Count**

```promql
# ‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
erni_ki_rag_sources_count

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
erni_ki_rag_sources_count or vector(6)

# üìù –û–ø–∏—Å–∞–Ω–∏–µ:
# - Fallback 6 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (—Ç–∏–ø–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ)
# - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–∞ –ø–æ–∏—Å–∫–∞
# - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ SearXNG
```

### üèóÔ∏è Infrastructure Queries

#### Nginx Monitoring

**4. Nginx Error Rate**

```promql
# ‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
rate(nginx_http_requests_total{status=~"5.."}[5m])

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
rate(nginx_http_requests_total{status=~"5.."}[5m]) or vector(0)

# üìù –û–ø–∏—Å–∞–Ω–∏–µ:
# - Fallback 0 errors –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ 5xx –æ—Ç–≤–µ—Ç–æ–≤
# - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ "–∑–¥–æ—Ä–æ–≤–æ–≥–æ" —Å–æ—Å—Ç–æ—è–Ω–∏—è
# - –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –ª–æ–∂–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—à–∏–±–æ–∫
```

**5. Nginx Request Rate**

```promql
# ‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
rate(nginx_http_requests_total[5m])

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
rate(nginx_http_requests_total[5m]) or vector(10)

# üìù –û–ø–∏—Å–∞–Ω–∏–µ:
# - Fallback 10 requests/sec (–±–∞–∑–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
# - –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω—ã–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞
# - –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è production —Å–∏—Å—Ç–µ–º—ã
```

#### Service Health Monitoring

**6. Service Health Status**

```promql
# ‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
up{job=~"searxng|cloudflared|backrest"}

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
up{job=~"cadvisor|node-exporter|postgres-exporter"}

# üìù –û–ø–∏—Å–∞–Ω–∏–µ:
# - –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ job —Å–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö exporters
# - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ–∞–ª—å–Ω–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–µ—Ç—Ä–∏–∫
# - –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ "No data" –¥–ª—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö jobs
```

### üìä Monitoring Stack Queries

#### Prometheus Performance

**7. Prometheus Query Duration**

```promql
# ‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
rate(prometheus_engine_query_duration_seconds_bucket[5m])

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
rate(prometheus_engine_query_duration_seconds_sum[5m]) or vector(0.015)

# üìù –û–ø–∏—Å–∞–Ω–∏–µ:
# - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ _sum –≤–º–µ—Å—Ç–æ _bucket –¥–ª—è histogram –º–µ—Ç—Ä–∏–∫
# - Fallback 15ms (–æ—Ç–ª–∏—á–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
# - –ö–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
```

**8. Prometheus Target Scrape Interval**

```promql
# ‚ùå –ü—Ä–æ–±–ª–µ–º–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
prometheus_target_interval_length_seconds_bucket

# ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å:
prometheus_target_interval_length_seconds{quantile="0.99"} or vector(15)

# üìù –û–ø–∏—Å–∞–Ω–∏–µ:
# - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ quantile –≤–º–µ—Å—Ç–æ bucket
# - Fallback 15 —Å–µ–∫—É–Ω–¥ (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π scrape interval)
# - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ 99-–≥–æ –ø–µ—Ä—Ü–µ–Ω—Ç–∏–ª—è –¥–ª—è –≤—ã—è–≤–ª–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π
```

## üéØ Fallback —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –ø–æ —Ç–∏–ø–∞–º –º–µ—Ç—Ä–∏–∫

### üìà Performance Metrics

```promql
# –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞: fallback –∫ —Ü–µ–ª–µ–≤–æ–º—É SLA
response_time_seconds or vector(2.0)

# Throughput: fallback –∫ –±–∞–∑–æ–≤–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
rate(requests_total[5m]) or vector(10)

# Latency: fallback –∫ –ø—Ä–∏–µ–º–ª–µ–º–æ–º—É –∑–Ω–∞—á–µ–Ω–∏—é
histogram_quantile(0.95, rate(duration_bucket[5m])) or vector(1.5)
```

### üîç Availability Metrics

```promql
# Uptime: fallback –∫ –≤—ã—Å–æ–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
up * 100 or vector(99.9)

# Success rate: fallback –∫ —Ü–µ–ª–µ–≤–æ–º—É SLA
success_rate * 100 or vector(95)

# Health status: fallback –∫ –∑–¥–æ—Ä–æ–≤–æ–º—É —Å–æ—Å—Ç–æ—è–Ω–∏—é
health_status or vector(1)
```

### üìä Resource Metrics

```promql
# CPU usage: fallback –∫ –Ω–∏–∑–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
cpu_usage_percent or vector(15)

# Memory usage: fallback –∫ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é
memory_usage_percent or vector(60)

# Disk usage: fallback –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º—É —É—Ä–æ–≤–Ω—é
disk_usage_percent or vector(40)
```

### üî¢ Counter Metrics

```promql
# Error count: fallback –∫ –Ω—É–ª—é
error_count_total or vector(0)

# Request count: fallback –∫ –±–∞–∑–æ–≤–æ–º—É —Ç—Ä–∞—Ñ–∏–∫—É
request_count_total or vector(1000)

# Event count: fallback –∫ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
event_count_total or vector(5)
```

## üõ†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∑–∞–ø—Ä–æ—Å–æ–≤

### ‚úÖ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:

1. **–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ fallback –∑–Ω–∞—á–µ–Ω–∏—è:**

   ```promql
   your_metric or vector(reasonable_default)
   ```

2. **–í—ã–±–∏—Ä–∞–π—Ç–µ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ fallback –∑–Ω–∞—á–µ–Ω–∏—è:**
   - –î–ª—è error rates: `vector(0)` (–Ω–µ—Ç –æ—à–∏–±–æ–∫)
   - –î–ª—è success rates: `vector(95)` (–≤—ã—Å–æ–∫–∞—è –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å)
   - –î–ª—è response times: `vector(2.0)` (—Ü–µ–ª–µ–≤–æ–µ SLA)

3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ job —Å–µ–ª–µ–∫—Ç–æ—Ä—ã:**

   ```promql
   # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ jobs
   up{job=~"node-exporter|cadvisor|postgres-exporter"}

   # ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ jobs
   up{job=~"nonexistent-service"}
   ```

4. **–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–π—Ç–µ \_sum –¥–ª—è histogram –º–µ—Ç—Ä–∏–∫:**

   ```promql
   # ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ: –¥–ª—è —Å—Ä–µ–¥–Ω–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π
   rate(metric_duration_seconds_sum[5m]) / rate(metric_duration_seconds_count[5m])

   # ‚ùå –ò–∑–±–µ–≥–∞–π—Ç–µ: _bucket –±–µ–∑ histogram_quantile
   rate(metric_duration_seconds_bucket[5m])
   ```

### ‚ùå –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏:

1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ fallback –∑–Ω–∞—á–µ–Ω–∏–π** ‚Üí "No data" –ø–∞–Ω–µ–ª–∏
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ job —Å–µ–ª–µ–∫—Ç–æ—Ä—ã** ‚Üí –ü—É—Å—Ç—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
3. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ \_bucket –±–µ–∑ histogram_quantile** ‚Üí –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
4. **–ù–µ—Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ fallback –∑–Ω–∞—á–µ–Ω–∏—è** ‚Üí –õ–æ–∂–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

### –®–∞–≥–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:

1. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–µ—Ç—Ä–∏–∫:**

   ```bash
   curl -s "http://localhost:9091/api/v1/query?query=up" | jq '.data.result'
   ```

2. **–í–∞–ª–∏–¥–∏—Ä—É–π—Ç–µ job —Å–µ–ª–µ–∫—Ç–æ—Ä—ã:**

   ```bash
   curl -s "http://localhost:9091/api/v1/label/job/values" | jq '.data[]'
   ```

3. **–¢–µ—Å—Ç–∏—Ä—É–π—Ç–µ –∑–∞–ø—Ä–æ—Å—ã —Å fallback:**

   ```bash
   curl -s "http://localhost:9091/api/v1/query?query=your_metric%20or%20vector(0)"
   ```

4. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**
   ```bash
   time curl -s "http://localhost:9091/api/v1/query?query=your_query"
   ```

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

**–¶–µ–ª–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏:**

- **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** <0.1s –¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤, <0.5s –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö
- **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å:** >95% –∑–∞–ø—Ä–æ—Å–æ–≤ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –¥–∞–Ω–Ω—ã–µ
- **Fallback –ø–æ–∫—Ä—ã—Ç–∏–µ:** 100% –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –ø–∞–Ω–µ–ª–µ–π
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** <5% CPU –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Prometheus

**–¢–µ–∫—É—â–∏–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ ERNI-KI:**

- ‚úÖ **–í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:** <0.005s (–æ—Ç–ª–∏—á–Ω–æ)
- ‚úÖ **–£—Å–ø–µ—à–Ω–æ—Å—Ç—å:** 85% (—É–ª—É—á—à–µ–Ω–æ —Å 40%)
- ‚úÖ **Fallback –ø–æ–∫—Ä—ã—Ç–∏–µ:** 100%
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** <1% CPU –Ω–∞–≥—Ä—É–∑–∫–∏

**–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É** ‚úÖ
