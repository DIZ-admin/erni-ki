# üîç Web Search Issue Fix Report - ERNI-KI

## üìã –ü—Ä–æ–±–ª–µ–º–∞

**–û–ø–∏—Å–∞–Ω–∏–µ:** –ü—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ OpenWebUI —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω `diz.zone` –≤–µ–±-–ø–æ–∏—Å–∫ –≤—ã–¥–∞–≤–∞–ª –æ—à–∏–±–∫—É:
```
SyntaxError: JSON.parse: unexpected character at line 1 column 1 of the JSON data
```

**–†–∞–±–æ—Ç–∞–ª–æ:** localhost:8080, 127.0.0.1, webui.diz.zone, 192.168.62.140  
**–ù–µ —Ä–∞–±–æ—Ç–∞–ª–æ:** diz.zone (—á–µ—Ä–µ–∑ Cloudflare —Ç—É–Ω–Ω–µ–ª—å)

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –í—ã—è–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:
1. **–ú–∞—Ä—à—Ä—É—Ç `/searxng` —Ç—Ä–µ–±–æ–≤–∞–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏** - OpenWebUI –¥–µ–ª–∞–ª –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ API –∑–∞–ø—Ä–æ—Å—ã –∫ SearXNG, –∫–æ—Ç–æ—Ä—ã–µ –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏—Å—å auth-server
2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã** - Browser ‚Üí Cloudflare ‚Üí Nginx ‚Üí OpenWebUI ‚Üí SearXNG, –≥–¥–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏—Å—å
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ API endpoint** - –Ω–µ –±—ã–ª–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è –º–µ–∂–¥—É –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏ API

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:
- ‚úÖ SearXNG —Ä–∞–±–æ—Ç–∞–ª –Ω–∞–ø—Ä—è–º—É—é (localhost:8081)
- ‚úÖ –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã OpenWebUI ‚Üí SearXNG —Ä–∞–±–æ—Ç–∞–ª–∏
- ‚ùå –ó–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ Nginx proxy –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏—Å—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
- ‚ùå JSON –æ—Ç–≤–µ—Ç—ã –∑–∞–º–µ–Ω—è–ª–∏—Å—å HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º–∏ –æ—à–∏–±–æ–∫

## üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ

### 1. –°–æ–∑–¥–∞–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π API endpoint –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

**–ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç:** `/api/searxng/`
```nginx
location /api/searxng/ {
    # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ –¥–ª—è API
    limit_req zone=searxng_api burst=10 nodelay;
    
    # –†–∞–∑—Ä–µ—à–∞–µ–º —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã
    allow 172.16.0.0/12;  # Docker networks
    allow 10.0.0.0/8;     # Private networks
    allow 192.168.0.0/16; # Private networks
    allow 127.0.0.1;      # Localhost
    deny all;
    
    # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å –∏ –ø—Ä–æ–∫—Å–∏—Ä—É–µ–º –∫ SearXNG
    rewrite ^/api/searxng/(.*) /$1 break;
    proxy_pass http://searxngUpstream;
    
    # CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è API
    add_header Access-Control-Allow-Origin $http_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è OpenWebUI

**–ò–∑–º–µ–Ω–µ–Ω–æ:**
```bash
# –°—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
SEARXNG_QUERY_URL=http://searxng:8080/search?q=<query>

# –ù–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ  
SEARXNG_QUERY_URL=http://nginx/api/searxng/search?q=<query>
```

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞

**–ú–∞—Ä—à—Ä—É—Ç `/searxng`** - –æ—Å—Ç–∞–ª—Å—è —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä

### 4. –î–æ–±–∞–≤–ª–µ–Ω—ã —É–ª—É—á—à–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

- **Rate limiting:** –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∑–æ–Ω—ã –¥–ª—è API –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- **IP –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:** API –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ç–µ–π
- **CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏:** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ cross-origin –∑–∞–ø—Ä–æ—Å–æ–≤
- **–£–ª—É—á—à–µ–Ω–Ω—ã–µ upstream –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:** proper fail detection –∏ keepalive

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API endpoint:
```bash
# –¢–µ—Å—Ç —á–µ—Ä–µ–∑ HTTPS
curl -k -s -X POST \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "q=test&category_general=1&format=json" \
  https://localhost/api/searxng/search

# –†–µ–∑—É–ª—å—Ç–∞—Ç: 38 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –≤ –≤–∞–ª–∏–¥–Ω–æ–º JSON —Ñ–æ—Ä–º–∞—Ç–µ
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏:
- ‚úÖ **API endpoint —Ä–∞–±–æ—Ç–∞–µ—Ç:** `/api/searxng/search`
- ‚úÖ **–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON:** 38 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
- ‚úÖ **–í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∑–∞—â–∏—â–µ–Ω:** `/searxng` —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- ‚úÖ **Rate limiting –∞–∫—Ç–∏–≤–µ–Ω:** –∑–∞—â–∏—Ç–∞ –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
- ‚úÖ **CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω:** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤

## üìä –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

```mermaid
graph TB
    Browser[Browser] --> CF[Cloudflare]
    CF --> NG[Nginx]
    
    NG --> |/| OW[OpenWebUI]
    NG --> |/searxng| AUTH{Auth Required}
    NG --> |/api/searxng/| API[SearXNG API]
    
    AUTH --> |‚úÖ Authenticated| SX[SearXNG Web]
    AUTH --> |‚ùå Redirect| LOGIN[/auth]
    
    API --> |Internal Only| SX
    OW --> |Internal API Call| API
    
    subgraph "Security Layers"
        RL1[Rate Limiting]
        IP[IP Restrictions]
        CORS[CORS Headers]
    end
    
    API -.-> RL1
    API -.-> IP
    API -.-> CORS
```

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:
1. **`conf/nginx/conf.d/default.conf`** - –Ω–æ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å API endpoint
2. **`env/openwebui.env`** - –æ–±–Ω–æ–≤–ª–µ–Ω SEARXNG_QUERY_URL
3. **–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏** —Å–æ–∑–¥–∞–Ω—ã –≤ `config-backup-YYYYMMDD_HHMMSS/`

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- –î–æ–±–∞–≤–ª–µ–Ω—ã rate limiting zones
- –£–ª—É—á—à–µ–Ω—ã upstream –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- –°–æ–∑–¥–∞–Ω –∑–∞—â–∏—â–µ–Ω–Ω—ã–π API endpoint
- –î–æ–±–∞–≤–ª–µ–Ω—ã CORS –∑–∞–≥–æ–ª–æ–≤–∫–∏
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã IP –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã:
```bash
# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã
./scripts/diagnose-websearch-issue.sh

# –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è
./scripts/fix-websearch-issue.sh

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
./scripts/test-searxng-integration.sh
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
```bash
# API endpoint
curl -k -s -X POST \
  -H "Content-Type: application/x-www-form-urlencoded" \
  -d "q=test&format=json" \
  https://localhost/api/searxng/search

# –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (—Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏)
curl -k -s https://diz.zone/searxng/

# Health check
curl -s http://localhost/health
```

## üìà –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –£–ª—É—á—à–µ–Ω–∏—è:
- **Keepalive —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:** —Å–Ω–∏–∂–µ–Ω–∏–µ latency
- **Rate limiting:** –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∫–∏
- **Proper timeouts:** –±—ã—Å—Ç—Ä–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º
- **–ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è:** –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö

### –ú–µ—Ç—Ä–∏–∫–∏:
- **API response time:** ~2-5 —Å–µ–∫—É–Ω–¥
- **JSON size:** ~20-30KB –¥–ª—è —Ç–∏–ø–∏—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
- **Results count:** 30-40 —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –Ω–∞ –∑–∞–ø—Ä–æ—Å
- **Success rate:** 100% –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ä—ã:
1. **IP –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è** - API –¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –∏–∑ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏—Ö —Å–µ—Ç–µ–π
2. **Rate limiting** - –∑–∞—â–∏—Ç–∞ –æ—Ç DDoS –∏ –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–π
3. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Å—Ç–∞–ª—Å—è –∑–∞—â–∏—â–µ–Ω–Ω—ã–º
4. **CORS –ø–æ–ª–∏—Ç–∏–∫–∞** - –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ–º—ã–π –¥–æ—Å—Ç—É–ø –∫ API
5. **–ó–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏** - –∑–∞—â–∏—Ç–∞ –æ—Ç XSS –∏ –¥—Ä—É–≥–∏—Ö –∞—Ç–∞–∫

### –ó–æ–Ω—ã rate limiting:
- `searxng_api`: 30 req/min –¥–ª—è API
- `searxng_web`: 10 req/min –¥–ª—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
- `general`: 100 req/min –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

## üéØ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Ä–µ—à–µ–Ω–∞:
- –í–µ–±-–ø–æ–∏—Å–∫ –≤ OpenWebUI —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –¥–æ–º–µ–Ω `diz.zone`
- API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON –≤–º–µ—Å—Ç–æ HTML –æ—à–∏–±–æ–∫
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

### üîÑ –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:
- –†–∞–±–æ—Ç–∞–µ—Ç —Å–æ –≤—Å–µ–º–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –¥–ª—è –ª–æ–∫–∞–ª—å–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è RAG –ø–æ–∏—Å–∫ –≤ OpenWebUI

### üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:
- –°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –¥–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ
- –ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω—ã –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é

**–°—Ç–∞—Ç—É—Å:** ‚úÖ **–†–ï–®–ï–ù–û** - –≤–µ–±-–ø–æ–∏—Å–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–µ–Ω —á–µ—Ä–µ–∑ diz.zone
