# Alertmanager configuration –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞ erni-ki
# –ü—Ä–∞–≤–∏–ª–∞ –∞–ª–µ—Ä—Ç–∏–Ω–≥–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

global:
  smtp_smarthost: "localhost:587"
  smtp_from: "alerts@erni-ki.local"
  smtp_auth_username: ""
  smtp_auth_password: ""
  smtp_require_tls: false

# –®–∞–±–ª–æ–Ω—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
templates:
  - "/etc/alertmanager/templates/*.tmpl"

# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤
route:
  group_by: ["alertname", "cluster", "service"]
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: "default-receiver"

  routes:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
    - match:
        severity: critical
      receiver: "critical-alerts"
      group_wait: 0s
      repeat_interval: 5m

    # –ê–ª–µ—Ä—Ç—ã –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º AI
    - match_re:
        service: (ollama|openwebui|auth)
      receiver: "ai-services-alerts"
      group_interval: 5m

    # –ê–ª–µ—Ä—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
    - match_re:
        service: (nginx|postgres|redis|cloudflared)
      receiver: "infrastructure-alerts"
      group_interval: 10m

    # –ê–ª–µ—Ä—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    - match:
        category: security
      receiver: "security-alerts"
      group_wait: 0s
      repeat_interval: 30m

# –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö—Å—è –∞–ª–µ—Ä—Ç–æ–≤
inhibit_rules:
  # –ü–æ–¥–∞–≤–ª—è–µ–º warning –µ—Å–ª–∏ –µ—Å—Ç—å critical
  - source_match:
      severity: "critical"
    target_match:
      severity: "warning"
    equal: ["alertname", "instance"]

  # –ü–æ–¥–∞–≤–ª—è–µ–º –∞–ª–µ—Ä—Ç—ã –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å down
  - source_match:
      alertname: "ServiceDown"
    target_match_re:
      alertname: "(HighLatency|HighErrorRate)"
    equal: ["instance"]

# –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
receivers:
  # –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  - name: "default-receiver"
    webhook_configs:
      - url: "http://webhook-receiver:9093/webhook"
        send_resolved: true
        http_config:
          basic_auth:
            username: "admin"
            password: "webhook-secret"

  # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã
  - name: "critical-alerts"
    email_configs:
      - to: "admin@erni-ki.local"
        subject: "üö® CRITICAL: {{ .GroupLabels.alertname }} in {{ .GroupLabels.cluster }}"
        body: |
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Severity:** {{ .Labels.severity }}
          **Instance:** {{ .Labels.instance }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
        headers:
          Priority: "high"

    # Discord webhook –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –∞–ª–µ—Ä—Ç–æ–≤
    webhook_configs:
      - url: "https://discord.com/api/webhooks/YOUR_WEBHOOK_ID/YOUR_WEBHOOK_TOKEN"
        send_resolved: true
        title: "üö® Critical Alert: {{ .GroupLabels.alertname }}"
        text: |
          {{ range .Alerts }}
          **{{ .Annotations.summary }}**
          {{ .Annotations.description }}
          Instance: {{ .Labels.instance }}
          {{ end }}

  # –ê–ª–µ—Ä—Ç—ã AI —Å–µ—Ä–≤–∏—Å–æ–≤
  - name: "ai-services-alerts"
    email_configs:
      - to: "ai-team@erni-ki.local"
        subject: "ü§ñ AI Service Alert: {{ .GroupLabels.alertname }}"
        body: |
          AI Service Issue Detected:
          {{ range .Alerts }}
          - **Service:** {{ .Labels.service }}
          - **Alert:** {{ .Annotations.summary }}
          - **Description:** {{ .Annotations.description }}
          - **Instance:** {{ .Labels.instance }}
          - **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # –ê–ª–µ—Ä—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  - name: "infrastructure-alerts"
    email_configs:
      - to: "devops@erni-ki.local"
        subject: "üèóÔ∏è Infrastructure Alert: {{ .GroupLabels.alertname }}"
        body: |
          Infrastructure Issue:
          {{ range .Alerts }}
          - **Component:** {{ .Labels.service }}
          - **Alert:** {{ .Annotations.summary }}
          - **Description:** {{ .Annotations.description }}
          - **Instance:** {{ .Labels.instance }}
          - **Severity:** {{ .Labels.severity }}
          {{ end }}

  # –ê–ª–µ—Ä—Ç—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
  - name: "security-alerts"
    email_configs:
      - to: "security@erni-ki.local"
        subject: "üîí SECURITY ALERT: {{ .GroupLabels.alertname }}"
        body: |
          SECURITY INCIDENT DETECTED:
          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Severity:** {{ .Labels.severity }}
          **Instance:** {{ .Labels.instance }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}

          IMMEDIATE ACTION REQUIRED!
          {{ end }}
        headers:
          Priority: "urgent"
          X-Priority: "1"

# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
web:
  external_url: "http://alertmanager.erni-ki.local"
