# ERNI-KI Critical Alerts Configuration
# –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ ERNI-KI

groups:
  # ============================================================================
  # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –°–ò–°–¢–ï–ú–ù–´–ï –ê–õ–ï–†–¢–´ / CRITICAL SYSTEM ALERTS
  # ============================================================================
  - name: erni-ki-critical-system
    rules:
      # GPU —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è
      - alert: GPUTemperatureCritical
        expr: nvidia_gpu_temperature_celsius > 85
        for: 2m
        labels:
          severity: critical
          service: gpu
          component: nvidia
        annotations:
          summary: "üî• GPU —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è / GPU temperature critical"
          description: "GPU {{$labels.gpu_id}} —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {{$value}}¬∞C –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ 85¬∞C –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç / GPU {{$labels.gpu_id}} temperature {{$value}}¬∞C exceeds critical threshold 85¬∞C for more than 2 minutes"
          runbook_url: "https://docs.erni-ki.local/runbooks/gpu-temperature"

      # GPU —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      - alert: GPUTemperatureWarning
        expr: nvidia_gpu_temperature_celsius > 80
        for: 5m
        labels:
          severity: warning
          service: gpu
          component: nvidia
        annotations:
          summary: "‚ö†Ô∏è GPU —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –≤—ã—Å–æ–∫–∞—è / GPU temperature high"
          description: "GPU {{$labels.gpu_id}} —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ {{$value}}¬∞C –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–π –ø–æ—Ä–æ–≥ 80¬∞C –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç / GPU {{$labels.gpu_id}} temperature {{$value}}¬∞C exceeds warning threshold 80¬∞C for more than 5 minutes"

      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ
      - alert: MemoryUsageCritical
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 90
        for: 2m
        labels:
          severity: critical
          service: system
          component: memory
        annotations:
          summary: "üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ / Critical memory usage"
          description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ {{$value | humanize}}% –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ 90% –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç / Memory usage {{$value | humanize}}% exceeds critical threshold 90% for more than 2 minutes"
          runbook_url: "https://docs.erni-ki.local/runbooks/memory-usage"

      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ RAM –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      - alert: MemoryUsageWarning
        expr: (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 80
        for: 5m
        labels:
          severity: warning
          service: system
          component: memory
        annotations:
          summary: "‚ö†Ô∏è –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ / High memory usage"
          description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ {{$value | humanize}}% –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–π –ø–æ—Ä–æ–≥ 80% –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç / Memory usage {{$value | humanize}}% exceeds warning threshold 80% for more than 5 minutes"

      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ
      - alert: DiskUsageCritical
        expr: (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 85
        for: 2m
        labels:
          severity: critical
          service: system
          component: disk
        annotations:
          summary: "üíæ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ / Critical disk usage"
          description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ {{$value | humanize}}% –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ 85% –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç / Disk usage {{$value | humanize}}% exceeds critical threshold 85% for more than 2 minutes"
          runbook_url: "https://docs.erni-ki.local/runbooks/disk-usage"

      # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ
      - alert: DiskUsageWarning
        expr: (1 - (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"})) * 100 > 75
        for: 5m
        labels:
          severity: warning
          service: system
          component: disk
        annotations:
          summary: "‚ö†Ô∏è –í—ã—Å–æ–∫–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ / High disk usage"
          description: "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –¥–∏—Å–∫–∞ {{$value | humanize}}% –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–π –ø–æ—Ä–æ–≥ 75% –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç / Disk usage {{$value | humanize}}% exceeds warning threshold 75% for more than 5 minutes"

  # ============================================================================
  # –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï –°–ï–†–í–ò–°–´ / CRITICAL SERVICES
  # ============================================================================
  - name: erni-ki-critical-services
    rules:
      # –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
      - alert: CriticalServiceDown
        expr: up{job=~"db|redis|nginx|auth"} == 0
        for: 2m
        labels:
          severity: critical
          service: "{{$labels.job}}"
          component: availability
        annotations:
          summary: "üö® –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω / Critical service down"
          description: "–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–µ—Ä–≤–∏—Å {{$labels.job}} –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç / Critical service {{$labels.job}} is down for more than 2 minutes"
          runbook_url: "https://docs.erni-ki.local/runbooks/service-down"

      # –ú–µ–¥–ª–µ–Ω–Ω—ã–µ RAG –∑–∞–ø—Ä–æ—Å—ã
      - alert: SlowRAGQueries
        expr: histogram_quantile(0.95, rate(prometheus_http_request_duration_seconds_bucket{handler=~"/api/v1/query.*"}[5m])) > 5
        for: 3m
        labels:
          severity: warning
          service: rag
          component: performance
        annotations:
          summary: "üêå –ú–µ–¥–ª–µ–Ω–Ω—ã–µ RAG –∑–∞–ø—Ä–æ—Å—ã / Slow RAG queries"
          description: "95-–π –ø—Ä–æ—Ü–µ–Ω—Ç–∏–ª—å –≤—Ä–µ–º–µ–Ω–∏ RAG –∑–∞–ø—Ä–æ—Å–æ–≤ {{$value | humanizeDuration}} –ø—Ä–µ–≤—ã—à–∞–µ—Ç 5 —Å–µ–∫—É–Ω–¥ –±–æ–ª–µ–µ 3 –º–∏–Ω—É—Ç / 95th percentile RAG query time {{$value | humanizeDuration}} exceeds 5 seconds for more than 3 minutes"

      # –í—ã—Å–æ–∫–∏–π error rate
      - alert: HighErrorRate
        expr: (rate(prometheus_http_requests_total{code=~"5.."}[5m]) / rate(prometheus_http_requests_total[5m])) * 100 > 10
        for: 3m
        labels:
          severity: warning
          service: "{{$labels.job}}"
          component: errors
        annotations:
          summary: "üìà –í—ã—Å–æ–∫–∏–π —É—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫ / High error rate"
          description: "–£—Ä–æ–≤–µ–Ω—å –æ—à–∏–±–æ–∫ 5xx –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ {{$labels.job}} —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç {{$value | humanize}}% –±–æ–ª–µ–µ 3 –º–∏–Ω—É—Ç / 5xx error rate for service {{$labels.job}} is {{$value | humanize}}% for more than 3 minutes"

  # ============================================================================
  # AI –°–ï–†–í–ò–°–´ / AI SERVICES
  # ============================================================================
  - name: erni-ki-ai-services
    rules:
      # Ollama –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
      - alert: OllamaServiceDown
        expr: up{job="ollama"} == 0
        for: 2m
        labels:
          severity: critical
          service: ollama
          component: availability
        annotations:
          summary: "ü§ñ Ollama —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω / Ollama service down"
          description: "Ollama —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç / Ollama service is down for more than 2 minutes"
          runbook_url: "https://docs.erni-ki.local/runbooks/ollama-down"

      # OpenWebUI –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
      - alert: OpenWebUIServiceDown
        expr: up{job="openwebui"} == 0
        for: 2m
        labels:
          severity: critical
          service: openwebui
          component: availability
        annotations:
          summary: "üåê OpenWebUI —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω / OpenWebUI service down"
          description: "OpenWebUI —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç / OpenWebUI service is down for more than 2 minutes"
          runbook_url: "https://docs.erni-ki.local/runbooks/openwebui-down"

      # SearXNG –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
      - alert: SearXNGServiceDown
        expr: up{job="searxng"} == 0
        for: 2m
        labels:
          severity: warning
          service: searxng
          component: availability
        annotations:
          summary: "üîç SearXNG —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω / SearXNG service down"
          description: "SearXNG —Å–µ—Ä–≤–∏—Å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç, RAG —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞ / SearXNG service is down for more than 2 minutes, RAG functionality may be limited"

      # GPU –ø–∞–º—è—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è
      - alert: GPUMemoryCritical
        expr: (nvidia_gpu_memory_used_bytes / nvidia_gpu_memory_total_bytes) * 100 > 90
        for: 2m
        labels:
          severity: critical
          service: gpu
          component: memory
        annotations:
          summary: "üéÆ GPU –ø–∞–º—è—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è / GPU memory critical"
          description: "GPU {{$labels.gpu_id}} –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ {{$value | humanize}}% –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π –ø–æ—Ä–æ–≥ 90% –±–æ–ª–µ–µ 2 –º–∏–Ω—É—Ç / GPU {{$labels.gpu_id}} memory usage {{$value | humanize}}% exceeds critical threshold 90% for more than 2 minutes"

  # ============================================================================
  # –ë–ê–ó–ê –î–ê–ù–ù–´–• / DATABASE
  # ============================================================================
  - name: erni-ki-database
    rules:
      # PostgreSQL —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π
      - alert: PostgreSQLTooManyConnections
        expr: pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
          service: postgresql
          component: connections
        annotations:
          summary: "üóÑÔ∏è PostgreSQL —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π / PostgreSQL too many connections"
          description: "PostgreSQL –∏–º–µ–µ—Ç {{$value}} –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π, —á—Ç–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–π –ø–æ—Ä–æ–≥ 80 –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç / PostgreSQL has {{$value}} active connections, exceeding warning threshold 80 for more than 5 minutes"

      # Redis –ø–∞–º—è—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è
      - alert: RedisMemoryCritical
        expr: redis_memory_used_bytes > 1073741824  # 1GB
        for: 5m
        labels:
          severity: warning
          service: redis
          component: memory
        annotations:
          summary: "‚ö° Redis –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–∞–º—è—Ç–∏ –≤—ã—Å–æ–∫–æ–µ / Redis memory usage high"
          description: "Redis –∏—Å–ø–æ–ª—å–∑—É–µ—Ç {{$value | humanizeBytes}} –ø–∞–º—è—Ç–∏, —á—Ç–æ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–∞—é—â–∏–π –ø–æ—Ä–æ–≥ 1GB –±–æ–ª–µ–µ 5 –º–∏–Ω—É—Ç / Redis is using {{$value | humanizeBytes}} memory, exceeding warning threshold 1GB for more than 5 minutes"
