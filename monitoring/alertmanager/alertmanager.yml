# Alertmanager Configuration –¥–ª—è ERNI-KI
# –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞–ª–µ—Ä—Ç–æ–≤ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π

global:
  # SMTP –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  smtp_smarthost: "localhost:587"
  smtp_from: "alerts@erni-ki.local"
  smtp_auth_username: ""
  smtp_auth_password: ""
  smtp_require_tls: false

  # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
  resolve_timeout: 5m
  http_config:
    follow_redirects: true

# –®–∞–±–ª–æ–Ω—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
templates:
  - "/etc/alertmanager/templates/*.tmpl"

# –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –∞–ª–µ—Ä—Ç–æ–≤
route:
  # –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∞–ª–µ—Ä—Ç–æ–≤
  group_by: ["alertname", "cluster", "service"]
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h

  # –ü–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  receiver: "erni-ki-webhook"

  # –ú–∞—Ä—à—Ä—É—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∞–ª–µ—Ä—Ç–æ–≤
  routes:
    # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    - match:
        severity: critical
      receiver: "erni-ki-critical"
      group_wait: 0s
      group_interval: 5s
      repeat_interval: 15m

    # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    - match:
        severity: warning
      receiver: "erni-ki-warning"
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 1h

    # GPU –∞–ª–µ—Ä—Ç—ã - —Å–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
    - match:
        service: gpu
      receiver: "erni-ki-gpu"
      group_wait: 10s
      group_interval: 2m
      repeat_interval: 30m

    # AI —Å–µ—Ä–≤–∏—Å—ã –∞–ª–µ—Ä—Ç—ã
    - match_re:
        service: "(ollama|openwebui|searxng|litellm)"
      receiver: "erni-ki-ai"
      group_wait: 15s
      group_interval: 3m
      repeat_interval: 45m

    # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞–ª–µ—Ä—Ç—ã
    - match_re:
        service: "(postgresql|redis)"
      receiver: "erni-ki-database"
      group_wait: 20s
      group_interval: 5m
      repeat_interval: 1h

# –ü–æ–ª—É—á–∞—Ç–µ–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
receivers:
  # Webhook –ø–æ–ª—É—á–∞—Ç–µ–ª—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
  - name: "erni-ki-webhook"
    webhook_configs:
      - url: "http://webhook-receiver:9093/webhook"
        send_resolved: true
        http_config:
          follow_redirects: true

  # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã - –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∫–∞–Ω–∞–ª—ã
  - name: "erni-ki-critical"
    webhook_configs:
      - url: "http://webhook-receiver:9093/webhook/critical"
        send_resolved: true
        title: "üö® CRITICAL ALERT / –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–õ–ï–†–¢"
        text: |
          üö® **–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ê–õ–ï–†–¢ / CRITICAL ALERT** üö®

          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Severity:** {{ .Labels.severity }}
          **Service:** {{ .Labels.service }}
          **Component:** {{ .Labels.component }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          **Runbook:** {{ .Annotations.runbook_url }}
          {{ end }}

          **Action Required:** Immediate attention needed / –¢—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–µ –≤–Ω–∏–º–∞–Ω–∏–µ

  # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
  - name: "erni-ki-warning"
    webhook_configs:
      - url: "http://webhook-receiver:9093/webhook/warning"
        send_resolved: true
        title: "‚ö†Ô∏è Warning Alert / –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ"
        text: |
          ‚ö†Ô∏è **WARNING / –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï** ‚ö†Ô∏è

          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Service:** {{ .Labels.service }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

  # GPU —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∞–ª–µ—Ä—Ç—ã
  - name: "erni-ki-gpu"
    webhook_configs:
      - url: "http://webhook-receiver:9093/webhook/gpu"
        send_resolved: true
        title: "üéÆ GPU Alert / GPU –ê–ª–µ—Ä—Ç"
        text: |
          üéÆ **GPU ALERT / GPU –ê–õ–ï–†–¢** üéÆ

          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **GPU ID:** {{ .Labels.gpu_id }}
          **Component:** {{ .Labels.component }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

          **Note:** GPU performance may be affected / –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å GPU –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–Ω–∏–∂–µ–Ω–∞

  # AI —Å–µ—Ä–≤–∏—Å—ã –∞–ª–µ—Ä—Ç—ã
  - name: "erni-ki-ai"
    webhook_configs:
      - url: "http://webhook-receiver:9093/webhook/ai"
        send_resolved: true
        title: "ü§ñ AI Services Alert / –ê–ª–µ—Ä—Ç AI —Å–µ—Ä–≤–∏—Å–æ–≤"
        text: |
          ü§ñ **AI SERVICES ALERT / –ê–õ–ï–†–¢ AI –°–ï–†–í–ò–°–û–í** ü§ñ

          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Service:** {{ .Labels.service }}
          **Component:** {{ .Labels.component }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

          **Impact:** AI functionality may be limited / –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å AI –º–æ–∂–µ—Ç –±—ã—Ç—å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∞

  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∞–ª–µ—Ä—Ç—ã
  - name: "erni-ki-database"
    webhook_configs:
      - url: "http://webhook-receiver:9093/webhook/database"
        send_resolved: true
        title: "üóÑÔ∏è Database Alert / –ê–ª–µ—Ä—Ç –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö"
        text: |
          üóÑÔ∏è **DATABASE ALERT / –ê–õ–ï–†–¢ –ë–ê–ó–´ –î–ê–ù–ù–´–•** üóÑÔ∏è

          {{ range .Alerts }}
          **Alert:** {{ .Annotations.summary }}
          **Description:** {{ .Annotations.description }}
          **Service:** {{ .Labels.service }}
          **Component:** {{ .Labels.component }}
          **Time:** {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

          **Impact:** Data operations may be affected / –û–ø–µ—Ä–∞—Ü–∏–∏ —Å –¥–∞–Ω–Ω—ã–º–∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞—Ç—Ä–æ–Ω—É—Ç—ã

# –ü–æ–¥–∞–≤–ª–µ–Ω–∏–µ –∞–ª–µ—Ä—Ç–æ–≤ (inhibit rules)
inhibit_rules:
  # –ü–æ–¥–∞–≤–ª—è—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –µ—Å–ª–∏ –µ—Å—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∞–ª–µ—Ä—Ç—ã –¥–ª—è —Ç–æ–≥–æ –∂–µ —Å–µ—Ä–≤–∏—Å–∞
  - source_match:
      severity: "critical"
    target_match:
      severity: "warning"
    equal: ["service", "component"]

  # –ü–æ–¥–∞–≤–ª—è—Ç—å –∞–ª–µ—Ä—Ç—ã –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —É–∂–µ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ down
  - source_match:
      alertname: "CriticalServiceDown"
    target_match_re:
      alertname: ".*ServiceDown"
    equal: ["service"]
