# ============================================================================
# Fluent Bit Configuration for ERNI-KI
# Centralized log collection and forwarding to Loki
# ============================================================================

[SERVICE]
    # Buffer flush interval (seconds)
    Flush         5
    # Run in foreground mode
    Daemon        off
    # Log level (error, warn, info, debug, trace)
    Log_Level     info
    # HTTP server for metrics and health checks
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    # Parser and plugin configuration files
    Parsers_File  parsers.conf
    Plugins_File  plugins.conf
    # Performance optimization
    Workers       4
    # Storage settings for buffering
    Storage.Path  /fluent-bit/db/
    Storage.Sync  normal
    Storage.Checksum off

# ============================================================================
# INPUT PLUGINS - Log sources
# ============================================================================

[INPUT]
    # Receive logs via Forward protocol from other services
    Name              forward
    Listen            0.0.0.0
    Port              24224
    # Buffer size for incoming data (optimized for performance)
    Buffer_Chunk_Size 4M
    Buffer_Max_Size   32M
    # Memory limit to prevent overflow
    Mem_Buf_Limit     64M
    # Allow disk spooling when Loki is unavailable
    storage.type      filesystem
    # TLS disabled until proper certificates are available in conf/fluent-bit/certs
    tls               Off

[INPUT]
    # Tail all docker json files for ERNI-KI containers
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Docker_Mode       On
    Docker_Mode_Flush 5
    Mem_Buf_Limit     64M
    Skip_Long_Lines   On
    Refresh_Interval  5
    Rotate_Wait       30
    storage.type      filesystem
    DB                /fluent-bit/db/docker-containers.db
    Ignore_Older      7d

[INPUT]
    # Expose Fluent Bit internal metrics for Prometheus scraping
    Name              fluentbit_metrics
    Tag               internal_metrics
    Scrape_interval   2

# ============================================================================
# FILTER PLUGINS - Optimized log processing and filtering
# ============================================================================

# ============================================================================
# TIMESTAMP NORMALIZATION - Fix timestamps without milliseconds
# ============================================================================

[FILTER]
    # Normalize timestamps without milliseconds (e.g., 2025-12-19T03:00:16Z)
    # Adds .000 to prevent parser errors with %Y-%m-%dT%H:%M:%S.%L%z format
    Name        lua
    Match       *
    script      /fluent-bit/scripts/timestamp_normalizer.lua
    call        normalize_timestamp

# ============================================================================
# SELF-EXCLUSION - Prevent log loops
# ============================================================================

[FILTER]
    # Exclude fluent-bit's own logs from tail stream to prevent loops
    Name        grep
    Match       docker.*
    Exclude     container_name ^erni-ki-fluent-bit$

# ============================================================================
# CONSOLIDATED NOISE FILTER - Single Lua pass instead of 12 grep filters
# Performance improvement: ~20-30% CPU reduction
# ============================================================================

[FILTER]
    # Consolidated noise filtering using Lua for better performance
    # Filters: Cloudflared context canceled, MCP errors, nginx access logs,
    # DEBUG messages, health checks, exporter noise, etc.
    Name        lua
    Match       *
    script      /fluent-bit/scripts/noise_filter.lua
    call        filter_noise

# ============================================================================
# LOG FIELD STANDARDIZATION - Unified JSON structure
# ============================================================================

[FILTER]
    # Parse JSON logs for better structuring
    Name        parser
    Match       *
    Key_Name    log
    Parser      json
    Reserve_Data On
    Preserve_Key On

# ============================================================================
# CONTAINER METADATA EXTRACTION - Add container_name as label
# ============================================================================

[FILTER]
    # Copy container_name for use as label in Loki
    # This simplifies filtering: {container_name="..."} instead of | json | container_name="..."
    Name        modify
    Match       *
    Copy        container_name container_name_label

# ============================================================================
# SERVICE NAME PARSING - Extract clean service name and category
# ============================================================================

[FILTER]
    # Prepare service_raw field for Lua script
    Name        modify
    Match       docker.*
    Copy        container_name service_raw

[FILTER]
    # Parse service name from container_name and add service_category
    # Example: erni-ki-openwebui-1 -> service=openwebui, service_category=web
    Name        lua
    Match       docker.*
    script      /fluent-bit/scripts/service_parser.lua
    call        parse_service_name

# ============================================================================
# TIER ENRICHMENT - Add tier labels for tier-based processing
# ============================================================================

[FILTER]
    # Add tier label based on service classification
    # Tiers: critical, important, auxiliary, monitoring
    Name        lua
    Match       docker.*
    script      /fluent-bit/scripts/tier_enrichment.lua
    call        enrich_tier

# ============================================================================
# TIER-BASED ROUTING - Route logs to tier-specific tags
# ============================================================================

[FILTER]
    # Route critical tier to separate tag (NO throttling)
    Name        rewrite_tag
    Match       docker.*
    Rule        $tier ^critical$ tier.critical.$container_name false

[FILTER]
    # Route important tier to separate tag (NO throttling)
    Name        rewrite_tag
    Match       docker.*
    Rule        $tier ^important$ tier.important.$container_name false

[FILTER]
    # Route auxiliary tier to separate tag (WILL be throttled)
    Name        rewrite_tag
    Match       docker.*
    Rule        $tier ^auxiliary$ tier.auxiliary.$container_name false

[FILTER]
    # Route monitoring tier to separate tag (WILL be throttled)
    Name        rewrite_tag
    Match       docker.*
    Rule        $tier ^monitoring$ tier.monitoring.$container_name false

# ============================================================================
# TIER-BASED THROTTLING - Only throttle non-critical services
# ============================================================================

[FILTER]
    # Throttle auxiliary services (Rate 5 per 60 sec)
    # Services: docling, edgetts, tika, mcp, etc.
    Name        throttle
    Match       tier.auxiliary.*
    Rate        5
    Window      60
    Interval    1s

[FILTER]
    # Throttle monitoring services (Rate 10 per 60 sec - higher than auxiliary due to legitimate volume)
    # Services: prometheus, grafana, exporters, etc.
    Name        throttle
    Match       tier.monitoring.*
    Rate        10
    Window      60
    Interval    1s

# NOTE: tier.critical.* and tier.important.* are NOT throttled
# This ensures critical logs are never lost during incidents

# ============================================================================
# OUTPUT PLUGINS - Log destinations
# ============================================================================

[OUTPUT]
    # Send tier.* tagged logs to Loki
    Name        loki
    Match       tier.*
    Host        erni-ki-loki
    Port        3100
    # Labels for source identification (optimized for Grafana)
    # Added: service, service_category, tier from Lua scripts
    Labels      job=fluent-bit,cluster=erni-ki,environment=production,container_name=$container_name_label,service=$service,service_category=$service_category,tier=$tier
    Line_format json
    Auto_kubernetes_labels Off
    # Remove temporary fields from log body (already in labels)
    Remove_keys container_name_label,service_raw,service,service_category,tier,is_metrics,should_throttle
    Retry_Limit False
    net.keepalive On
    net.keepalive_idle_timeout 30
    net.connect_timeout 5
    storage.total_limit_size 15G
    Tenant_ID   erni-ki
    tls         Off

[OUTPUT]
    # Send forward protocol logs to Loki (non-docker sources)
    Name        loki
    Match_Regex ^(?!tier\.|docker\.).*
    Host        erni-ki-loki
    Port        3100
    Labels      job=fluent-bit,cluster=erni-ki,environment=production,source=forward
    Line_format json
    Auto_kubernetes_labels Off
    Retry_Limit False
    net.keepalive On
    net.keepalive_idle_timeout 30
    net.connect_timeout 5
    storage.total_limit_size 15G
    Tenant_ID   erni-ki
    tls         Off

[OUTPUT]
    # Prometheus metrics for logging monitoring
    Name        prometheus_exporter
    Match       *
    Host        0.0.0.0
    Port        2021
    Add_label   service fluent-bit
    Add_label   cluster erni-ki
