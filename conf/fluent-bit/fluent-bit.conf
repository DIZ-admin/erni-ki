# ============================================================================
# Fluent Bit Configuration for ERNI-KI
# Centralized log collection and forwarding to Loki
# ============================================================================

[SERVICE]
    # Buffer flush interval (seconds)
    Flush         5
    # Run in foreground mode
    Daemon        off
    # Log level (error, warn, info, debug, trace)
    Log_Level     info
    # HTTP server for metrics and health checks
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    # Parser and plugin configuration files
    Parsers_File  parsers.conf
    Plugins_File  plugins.conf
    # Performance optimization
    Workers       4
    # Storage settings for buffering
    Storage.Path  /fluent-bit/db/
    Storage.Sync  normal
    Storage.Checksum off

# ============================================================================
# INPUT PLUGINS - Log sources
# ============================================================================

[INPUT]
    # Receive logs via Forward protocol from other services
    Name              forward
    Listen            0.0.0.0
    Port              24224
    # Buffer size for incoming data (optimized for performance)
    Buffer_Chunk_Size 4M
    Buffer_Max_Size   32M
    # Memory limit to prevent overflow
    Mem_Buf_Limit     64M
    # Allow disk spooling when Loki is unavailable
    storage.type      filesystem
    # TLS disabled until proper certificates are available in conf/fluent-bit/certs
    tls               Off

[INPUT]
    # Tail all docker json files for ERNI-KI containers
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Docker_Mode       On
    Docker_Mode_Flush 5
    Mem_Buf_Limit     64M
    Skip_Long_Lines   On
    Refresh_Interval  5
    Rotate_Wait       30
    storage.type      filesystem
    DB                /fluent-bit/db/docker-containers.db
    Ignore_Older      7d

# ============================================================================
# FILTER PLUGINS - Optimized log processing and filtering
# ============================================================================

# ============================================================================
# NON-CRITICAL MESSAGE EXCLUSION FILTERS
# ============================================================================

[FILTER]
    # PRIORITY 1: Exclude Cloudflared "context canceled" errors (85% of all warnings)
    # This is normal behavior when users interrupt HTTP requests
    Name        grep
    Match       *
    Exclude     log /context canceled.*cloudflared/

[FILTER]
    # Exclude fluent-bit's own logs from tail stream
    Name        grep
    Match       docker.*
    Exclude     container_name ^erni-ki-fluent-bit$

[FILTER]
    # PRIORITY 1: Exclude Cloudflared "Incoming request ended abruptly"
    Name        grep
    Match       *
    Exclude     log /Incoming request ended abruptly.*context canceled/

[FILTER]
    # PRIORITY 1: Exclude Cloudflared "Request failed" with context canceled
    Name        grep
    Match       *
    Exclude     log /Request failed.*context canceled/

[FILTER]
    # PRIORITY 1: Exclude Cloudflared stream canceled errors
    Name        grep
    Match       *
    Exclude     log /stream.*canceled by remote with error code 0/

[FILTER]
    # PRIORITY 2: Exclude MCP errors from OpenWebUI (non-critical)
    Name        grep
    Match       *
    Exclude     log /Could not fetch tool server spec from.*mcp.*openapi\.json/

[FILTER]
    # PRIORITY 2: Exclude ContentTypeError for MCP (non-critical)
    Name        grep
    Match       *
    Exclude     log /ContentTypeError.*mcp.*openapi\.json/

[FILTER]
    # PRIORITY 3: Exclude nginx access log informational messages
    Name        grep
    Match       *
    Exclude     log /GET.*200.*nginx/

[FILTER]
    # PRIORITY 3: Exclude DEBUG messages from all services
    Name        grep
    Match       *
    Exclude     log /level=debug/i

[FILTER]
    # PRIORITY 3: Exclude repeated health check requests
    Name        grep
    Match       *
    Exclude     log /GET.*\/health.*200/


[FILTER]
    # PRIORITY 3: Exclude node-exporter systemd errors (99.5% of all ERROR)
    Name        grep
    Match       *
    Exclude     log /couldn't get dbus connection.*systemd/

[FILTER]
    # PRIORITY 3: Exclude node-exporter connection reset errors
    Name        grep
    Match       *
    Exclude     log /connection reset by peer.*node-exporter/

[FILTER]
    # PRIORITY 3: Exclude cAdvisor smaps warnings (noise, non-critical)
    Name        grep
    Match       *
    Exclude     log /Cannot read smaps files for any PID from CONTAINER/

[FILTER]
    # PRIORITY 3: Exclude nginx-exporter HTML parsing errors
    Name        grep
    Match       *
    Exclude     log /failed to parse response body.*html/

[FILTER]
    # Rate limiting for repeated errors (spam prevention)
    Name        throttle
    Match       *
    Rate        10
    Window      60
    Interval    1s

# ============================================================================
# LOG FIELD STANDARDIZATION - Unified JSON structure
# ============================================================================

[FILTER]
    # Parse JSON logs for better structuring
    Name        parser
    Match       *
    Key_Name    log
    Parser      json
    Reserve_Data On
    Preserve_Key On

# ============================================================================
# CONTAINER METADATA EXTRACTION - Add container_name as label
# ============================================================================

[FILTER]
    # Copy container_name for use as label in Loki
    # This simplifies filtering: {container_name="..."} instead of | json | container_name="..."
    Name        modify
    Match       *
    Copy        container_name container_name_label
# ============================================================================
# OUTPUT PLUGINS - Log destinations
# ============================================================================

[OUTPUT]
    # Send to Loki for centralized storage (simplified configuration)
    Name        loki
    Match       *
    # Basic Loki connection parameters
    # Using container_name to avoid DNS errors (service alias not present)
    Host        erni-ki-loki
    Port        3100
    # Labels for source identification (optimized for Grafana)
    Labels      job=fluent-bit,cluster=erni-ki,environment=production,container_name=$container_name_label
    # Output format (JSON for better parsing in Grafana)
    Line_format json
    # Disable Kubernetes labels (not used in Docker Compose)
    Auto_kubernetes_labels Off
    # Remove temporary container_name_label field from log body (already in labels)
    Remove_keys container_name_label
    # Retry settings for fault tolerance
    Retry_Limit False
    net.keepalive On
    net.keepalive_idle_timeout 30
    net.connect_timeout 5
    # Disk queue limit (15GB backlog on SSD volume)
    storage.total_limit_size 15G
    # Multi-tenant Loki authentication
    Tenant_ID   erni-ki
    tls         Off

[OUTPUT]
    # Prometheus metrics for logging monitoring
    Name        prometheus_exporter
    Match       *
    Host        0.0.0.0
    Port        2021
    # Metrics for monitoring
    Add_label   service fluent-bit
    Add_label   cluster erni-ki
