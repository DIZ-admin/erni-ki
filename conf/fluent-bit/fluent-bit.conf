# ============================================================================
# Fluent Bit Configuration для ERNI-KI
# Централизованный сбор и пересылка логов
# ============================================================================
# Версия: 3.0.7
# Обновлено: 2025-08-22
# Назначение: Сбор логов от всех сервисов и отправка в Loki
# ============================================================================

[SERVICE]
    # Интервал сброса буферов (секунды)
    Flush         5
    # Запуск в foreground режиме
    Daemon        off
    # Уровень логирования (error, warn, info, debug, trace)
    Log_Level     info
    # HTTP сервер для метрик и health checks
    HTTP_Server   On
    HTTP_Listen   0.0.0.0
    HTTP_Port     2020
    # Файлы конфигурации парсеров и плагинов
    Parsers_File  parsers.conf
    Plugins_File  plugins.conf
    # Оптимизация производительности
    Workers       4
    # Настройки хранения для буферизации
    Storage.Path  /fluent-bit/db/
    Storage.Sync  normal
    Storage.Checksum off

# ============================================================================
# INPUT PLUGINS - Источники логов
# ============================================================================

[INPUT]
    # Прием логов через Forward протокол от других сервисов
    Name              forward
    Listen            0.0.0.0
    Port              24224
    # Размер буфера для входящих данных (оптимизировано для производительности)
    Buffer_Chunk_Size 4M
    Buffer_Max_Size   32M
    # Лимит памяти для предотвращения переполнения
    Mem_Buf_Limit     64M
    # Разрешаем сброс на диск при недоступности Loki
    storage.type      filesystem
    # TLS / mTLS настройки
    tls               On
    tls.verify        On
    tls.ca_file       /fluent-bit/etc/certs/logging-ca.crt
    tls.crt_file      /fluent-bit/etc/certs/fluent-bit.crt
    tls.key_file      /fluent-bit/etc/certs/fluent-bit.key

[INPUT]
    # Tail всех docker json-файлов для контейнеров ERNI-KI
    Name              tail
    Tag               docker.*
    Path              /var/lib/docker/containers/*/*.log
    Parser            docker
    Docker_Mode       On
    Docker_Mode_Flush 5
    Mem_Buf_Limit     64M
    Skip_Long_Lines   On
    Refresh_Interval  5
    Rotate_Wait       30
    storage.type      filesystem
    DB                /fluent-bit/db/docker-containers.db
    Ignore_Older      7d

# ============================================================================
# FILTER PLUGINS - Оптимизированная обработка и фильтрация логов
# ============================================================================

# ============================================================================
# ФИЛЬТРЫ ИСКЛЮЧЕНИЯ НЕКРИТИЧНЫХ СООБЩЕНИЙ (ОПТИМИЗИРОВАНЫ 2025-09-18)
# ============================================================================

[FILTER]
    # ПРИОРИТЕТ 1: Исключение Cloudflared "context canceled" ошибок (85% всех warnings)
    # Это нормальное поведение при прерывании HTTP запросов пользователями
    Name        grep
    Match       *
    Exclude     log /context canceled.*cloudflared/

[FILTER]
    # Исключаем собственные логи fluent-bit из потока tail
    Name        grep
    Match       docker.*
    Exclude     container_name ^erni-ki-fluent-bit$

[FILTER]
    # ПРИОРИТЕТ 1: Исключение Cloudflared "Incoming request ended abruptly"
    Name        grep
    Match       *
    Exclude     log /Incoming request ended abruptly.*context canceled/

[FILTER]
    # ПРИОРИТЕТ 1: Исключение Cloudflared "Request failed" с context canceled
    Name        grep
    Match       *
    Exclude     log /Request failed.*context canceled/

[FILTER]
    # ПРИОРИТЕТ 1: Исключение Cloudflared stream canceled ошибок
    Name        grep
    Match       *
    Exclude     log /stream.*canceled by remote with error code 0/

[FILTER]
    # ПРИОРИТЕТ 2: Исключение MCP ошибок OpenWebUI (некритичные)
    Name        grep
    Match       *
    Exclude     log /Could not fetch tool server spec from.*mcp.*openapi\.json/

[FILTER]
    # ПРИОРИТЕТ 2: Исключение ContentTypeError для MCP (некритичные)
    Name        grep
    Match       *
    Exclude     log /ContentTypeError.*mcp.*openapi\.json/

# Redis-exporter удален из системы - фильтр больше не нужен

[FILTER]
    # ПРИОРИТЕТ 3: Исключение информационных сообщений nginx access логов
    Name        grep
    Match       *
    Exclude     log /GET.*200.*nginx/

[FILTER]
    # ПРИОРИТЕТ 3: Исключение DEBUG сообщений всех сервисов
    Name        grep
    Match       *
    Exclude     log /level=debug/i

[FILTER]
    # ПРИОРИТЕТ 3: Исключение повторяющихся health check запросов
    Name        grep
    Match       *
    Exclude     log /GET.*\/health.*200/


[FILTER]
    # ПРИОРИТЕТ 3: Исключение node-exporter systemd ошибок (99.5% всех ERROR)
    Name        grep
    Match       *
    Exclude     log /couldn't get dbus connection.*systemd/

[FILTER]
    # ПРИОРИТЕТ 3: Исключение node-exporter connection reset ошибок
    Name        grep
    Match       *
    Exclude     log /connection reset by peer.*node-exporter/

[FILTER]
    # ПРИОРИТЕТ 3: Исключение предупреждений cAdvisor о smaps (шум, не критично)
    Name        grep
    Match       *
    Exclude     log /Cannot read smaps files for any PID from CONTAINER/

[FILTER]
    # ПРИОРИТЕТ 3: Исключение nginx-exporter HTML parsing ошибок (до исправления)
    Name        grep
    Match       *
    Exclude     log /failed to parse response body.*html/

[FILTER]
    # НОВЫЙ: Rate limiting для повторяющихся ошибок (предотвращение спама)
    Name        throttle
    Match       *
    Rate        10
    Window      60
    Interval    1s

# ============================================================================
# СТАНДАРТИЗАЦИЯ ПОЛЕЙ ЛОГОВ - Унифицированная структура JSON
# ============================================================================

[FILTER]
    # Парсинг JSON логов для лучшей структуризации
    Name        parser
    Match       *
    Key_Name    log
    Parser      json
    Reserve_Data On
    Preserve_Key On

# ============================================================================
# ИЗВЛЕЧЕНИЕ МЕТАДАННЫХ КОНТЕЙНЕРОВ - Добавление container_name как label
# ============================================================================

[FILTER]
    # Копирование container_name для использования как label в Loki
    # Это упрощает фильтрацию: {container_name="..."} вместо | json | container_name="..."
    Name        modify
    Match       *
    Copy        container_name container_name_label
# ============================================================================
# OUTPUT PLUGINS - Назначения для логов
# ============================================================================

[OUTPUT]
    # Отправка в Loki для централизованного хранения (упрощенная конфигурация)
    Name        loki
    Match       *
    # Базовые параметры подключения к Loki
    # Используем container_name, чтобы избежать DNS ошибок (service alias отсутствует)
    Host        erni-ki-loki
    Port        3100
    # Метки для идентификации источника (оптимизированы для Grafana)
    # ОБНОВЛЕНО 2025-10-03: Добавлен container_name_label для упрощения фильтрации
    Labels      job=fluent-bit,cluster=erni-ki,environment=production,container_name=$container_name_label
    # Формат отправляемых данных (JSON для лучшего парсинга в Grafana)
    Line_format json
    # Отключить Kubernetes метки (не используется в Docker Compose)
    Auto_kubernetes_labels Off
    # Удалить временное поле container_name_label из тела лога (оно уже в labels)
    Remove_keys container_name_label
    # Retry настройки для отказоустойчивости
    Retry_Limit False
    net.keepalive On
    net.keepalive_idle_timeout 30
    net.connect_timeout 5
    # Ограничение очереди на диск (10ГБ backlog на SSD volume)
    storage.total_limit_size 15G
    # Multi-tenant Loki аутентификация
    Tenant_ID   erni-ki
    tls         Off

[OUTPUT]
    # Prometheus метрики для мониторинга логгирования (Фаза 2)
    Name        prometheus_exporter
    Match       *
    Host        0.0.0.0
    Port        2021
    # Метрики для мониторинга
    Add_label   service fluent-bit
    Add_label   cluster erni-ki
