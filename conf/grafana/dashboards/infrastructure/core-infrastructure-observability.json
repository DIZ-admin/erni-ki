{
  "uid": "core-infra-observability",
  "title": "Core Infrastructure Observability",
  "description": "Detailed infrastructure metrics: PostgreSQL, Redis, filesystems, network, and container health",
  "timezone": "browser",
  "schemaVersion": 39,
  "version": 3,
  "refresh": "30s",
  "tags": ["erni-ki", "infrastructure", "postgres", "redis", "containers"],
  "time": {"from": "now-6h", "to": "now"},
  "templating": {
    "list": [
      {
        "name": "interval",
        "type": "interval",
        "query": "1m,5m,10m,30m",
        "current": {"text": "5m", "value": "5m"},
        "auto": true,
        "auto_min": "1m"
      }
    ]
  },
  "panels": [
    {
      "type": "row",
      "title": "PostgreSQL Database",
      "id": 100,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
      "collapsed": false
    },
    {
      "type": "stat",
      "title": "PG Status",
      "description": "PostgreSQL server availability",
      "id": 10,
      "gridPos": {"h": 4, "w": 3, "x": 0, "y": 1},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "pg_up", "refId": "A"}
      ],
      "fieldConfig": {
        "defaults": {
          "mappings": [{"type": "value", "options": {"0": {"text": "DOWN", "color": "red"}, "1": {"text": "UP", "color": "green"}}}]
        }
      },
      "options": {"reduceOptions": {"calcs": ["lastNotNull"]}, "colorMode": "background"}
    },
    {
      "type": "stat",
      "title": "Active Connections",
      "description": "Current database connections",
      "id": 11,
      "gridPos": {"h": 4, "w": 3, "x": 3, "y": 1},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(pg_stat_activity_count)", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "short"}},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"]}}
    },
    {
      "type": "stat",
      "title": "Total DB Size",
      "description": "Combined size of all databases",
      "id": 12,
      "gridPos": {"h": 4, "w": 3, "x": 6, "y": 1},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(pg_database_size_bytes)", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "bytes"}},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"]}}
    },
    {
      "type": "timeseries",
      "title": "PostgreSQL Sessions by State",
      "description": "Connection states over time",
      "id": 1,
      "gridPos": {"h": 6, "w": 15, "x": 9, "y": 1},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum by (state) (pg_stat_activity_count{server=\"db:5432\"})", "legendFormat": "{{state}}", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "short"}},
      "options": {"legend": {"showLegend": true, "placement": "right"}}
    },
    {
      "type": "row",
      "title": "Redis Cache",
      "id": 101,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 7},
      "collapsed": false
    },
    {
      "type": "stat",
      "title": "Redis Status",
      "description": "Redis server availability",
      "id": 20,
      "gridPos": {"h": 4, "w": 3, "x": 0, "y": 8},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "redis_up", "refId": "A"}
      ],
      "fieldConfig": {
        "defaults": {
          "mappings": [{"type": "value", "options": {"0": {"text": "DOWN", "color": "red"}, "1": {"text": "UP", "color": "green"}}}]
        }
      },
      "options": {"reduceOptions": {"calcs": ["lastNotNull"]}, "colorMode": "background"}
    },
    {
      "type": "stat",
      "title": "Memory Used",
      "description": "Redis memory consumption",
      "id": 21,
      "gridPos": {"h": 4, "w": 3, "x": 3, "y": 8},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "redis_memory_used_bytes", "refId": "A"}
      ],
      "fieldConfig": {"defaults": {"unit": "bytes"}},
      "options": {"reduceOptions": {"calcs": ["lastNotNull"]}}
    },
    {
      "type": "gauge",
      "title": "Hit Ratio",
      "description": "Cache hit effectiveness",
      "id": 22,
      "gridPos": {"h": 4, "w": 3, "x": 6, "y": 8},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "(rate(redis_keyspace_hits_total[$interval]) / clamp_min(rate(redis_keyspace_hits_total[$interval]) + rate(redis_keyspace_misses_total[$interval]), 0.001)) * 100", "refId": "A"}
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0, "max": 100,
          "thresholds": {"mode": "absolute", "steps": [{"color": "red", "value": 0}, {"color": "yellow", "value": 80}, {"color": "green", "value": 95}]}
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Redis Operations & Hit Ratio",
      "description": "Command throughput and cache effectiveness",
      "id": 2,
      "gridPos": {"h": 6, "w": 15, "x": 9, "y": 8},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(redis_commands_processed_total[$interval]))", "legendFormat": "Commands/s", "refId": "A"},
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(redis_keyspace_hits_total[$interval])) / clamp_min(sum(rate(redis_keyspace_hits_total[$interval])) + sum(rate(redis_keyspace_misses_total[$interval])), 0.001) * 100", "legendFormat": "Hit %", "refId": "B"}
      ],
      "fieldConfig": {"defaults": {"unit": "short"}},
      "options": {"legend": {"showLegend": true, "placement": "bottom"}}
    },
    {
      "type": "row",
      "title": "Host System",
      "id": 102,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 14},
      "collapsed": false
    },
    {
      "type": "timeseries",
      "title": "Filesystem Utilization",
      "description": "Disk usage by mountpoint",
      "id": 3,
      "gridPos": {"h": 7, "w": 12, "x": 0, "y": 15},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "((node_filesystem_size_bytes{fstype!~\"tmpfs|overlay\"} - node_filesystem_avail_bytes{fstype!~\"tmpfs|overlay\"}) / node_filesystem_size_bytes{fstype!~\"tmpfs|overlay\"}) * 100", "legendFormat": "{{mountpoint}}", "refId": "A"}
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "yellow", "value": 70}, {"color": "red", "value": 85}]}
        }
      },
      "options": {"legend": {"showLegend": true, "placement": "right"}}
    },
    {
      "type": "timeseries",
      "title": "Network Throughput",
      "description": "Network I/O across interfaces",
      "id": 4,
      "gridPos": {"h": 7, "w": 12, "x": 12, "y": 15},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(rate(node_network_receive_bytes_total{device!~\"lo|veth.*|docker.*|br-.*\"}[$interval]))", "legendFormat": "Receive", "refId": "A"},
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "-sum(rate(node_network_transmit_bytes_total{device!~\"lo|veth.*|docker.*|br-.*\"}[$interval]))", "legendFormat": "Transmit", "refId": "B"}
      ],
      "fieldConfig": {"defaults": {"unit": "Bps"}},
      "options": {"legend": {"showLegend": true, "placement": "bottom"}}
    },
    {
      "type": "row",
      "title": "Container Health",
      "id": 103,
      "gridPos": {"h": 1, "w": 24, "x": 0, "y": 22},
      "collapsed": false
    },
    {
      "type": "stat",
      "title": "OOM Events (1h)",
      "description": "Out-of-memory kills in containers",
      "id": 5,
      "gridPos": {"h": 4, "w": 4, "x": 0, "y": 23},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(increase(container_oom_events_total[1h])) or vector(0)", "refId": "A"}
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "red", "value": 1}]}
        }
      },
      "options": {"reduceOptions": {"calcs": ["lastNotNull"]}, "colorMode": "value"}
    },
    {
      "type": "stat",
      "title": "Container Restarts (1h)",
      "description": "Container restart count",
      "id": 6,
      "gridPos": {"h": 4, "w": 4, "x": 4, "y": 23},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "sum(changes(container_start_time_seconds[1h])) or vector(0)", "refId": "A"}
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short",
          "thresholds": {"mode": "absolute", "steps": [{"color": "green", "value": 0}, {"color": "yellow", "value": 3}, {"color": "red", "value": 10}]}
        }
      },
      "options": {"reduceOptions": {"calcs": ["lastNotNull"]}, "colorMode": "value"}
    },
    {
      "type": "table",
      "title": "Database Sizes",
      "description": "Size of each PostgreSQL database",
      "id": 7,
      "gridPos": {"h": 8, "w": 16, "x": 8, "y": 23},
      "targets": [
        {"datasource": {"type": "prometheus", "uid": "prometheus"}, "expr": "pg_database_size_bytes", "refId": "A", "format": "table", "instant": true}
      ],
      "transformations": [
        {"id": "organize", "options": {"excludeByName": {"Time": true, "__name__": true}, "renameByName": {"datname": "Database", "Value": "Size"}}}
      ],
      "fieldConfig": {
        "overrides": [
          {"matcher": {"id": "byName", "options": "Size"}, "properties": [{"id": "unit", "value": "bytes"}]}
        ]
      },
      "options": {"showHeader": true, "sortBy": [{"displayName": "Size", "desc": true}]}
    }
  ],
  "links": [
    {"title": "SRE Overview", "url": "/d/platform-sre-overview", "type": "link", "icon": "dashboard"},
    {"title": "AI Services", "url": "/d/ai-stack-ops", "type": "link", "icon": "dashboard"},
    {"title": "Monitoring Stack", "url": "/d/observability-control-plane", "type": "link", "icon": "dashboard"}
  ]
}
