{
  "uid": "core-infra-observability",
  "title": "Core Infrastructure Observability",
  "schemaVersion": 39,
  "version": 1,
  "refresh": "30s",
  "time": {"from": "now-6h", "to": "now"},
  "templating": {
    "list": [
      {
        "name": "instance",
        "type": "query",
        "datasource": {"type": "prometheus", "uid": "prometheus"},
        "query": "label_values(node_uname_info, instance)",
        "includeAll": true,
        "multi": true,
        "current": {"text": "All", "value": ["$__all"]}
      }
    ]
  },
  "panels": [
    {
      "type": "timeseries",
      "title": "PostgreSQL Connections",
      "id": 1,
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "expr": "sum(pg_stat_activity_count{instance=~\"$instance\"})",
          "legendFormat": "Active",
          "refId": "A"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "expr": "sum(pg_settings_max_connections{instance=~\"$instance\"})",
          "legendFormat": "Max",
          "refId": "B"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "short"}}
    },
    {
      "type": "timeseries",
      "title": "Redis Ops / Cache Hit Ratio",
      "id": 2,
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "expr": "sum(rate(redis_commands_processed_total[5m]))",
          "legendFormat": "Commands/sec",
          "refId": "A"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "expr": "(sum(rate(redis_keyspace_hits_total[5m])) / (sum(rate(redis_keyspace_hits_total[5m])) + sum(rate(redis_keyspace_misses_total[5m]))))",
          "legendFormat": "Cache Hit %",
          "refId": "B"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "short"}}
    },
    {
      "type": "timeseries",
      "title": "Filesystem Utilization",
      "id": 3,
      "gridPos": {"h": 8, "w": 12, "x": 0, "y": 8},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "expr": "max by (instance, mountpoint) (node_filesystem_size_bytes{fstype!~\"tmpfs|overlay\"} - node_filesystem_avail_bytes{fstype!~\"tmpfs|overlay\"}) / node_filesystem_size_bytes{fstype!~\"tmpfs|overlay\"}",
          "legendFormat": "{{instance}} {{mountpoint}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "percent"}}
    },
    {
      "type": "timeseries",
      "title": "Network Throughput",
      "id": 4,
      "gridPos": {"h": 8, "w": 12, "x": 12, "y": 8},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "expr": "sum(rate(node_network_receive_bytes_total{device!~\"lo\", instance=~\"$instance\"}[5m]))",
          "legendFormat": "RX",
          "refId": "A"
        },
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "expr": "sum(rate(node_network_transmit_bytes_total{device!~\"lo\", instance=~\"$instance\"}[5m]))",
          "legendFormat": "TX",
          "refId": "B"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "Bps"}}
    },
    {
      "type": "stat",
      "title": "Container Restarts (last hour)",
      "id": 5,
      "gridPos": {"h": 4, "w": 8, "x": 0, "y": 16},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "expr": "sum(increase(container_last_seen{namespace=\"erni-ki\"}[1h]) == 0)",
          "refId": "A"
        }
      ],
      "fieldConfig": {"defaults": {"unit": "short"}}
    },
    {
      "type": "table",
      "title": "Resource Limits vs Usage",
      "id": 6,
      "gridPos": {"h": 10, "w": 24, "x": 0, "y": 20},
      "targets": [
        {
          "datasource": {"type": "prometheus", "uid": "prometheus"},
          "expr": "max by (container_label_com_docker_compose_service) (container_memory_usage_bytes{container_label_com_docker_compose_project=\"erni-ki\"})",
          "legendFormat": "memory",
          "refId": "A",
          "format": "table"
        }
      ],
      "options": {"showHeader": true}
    }
  ]
}
