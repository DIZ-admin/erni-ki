# API Chat endpoint configuration with SSE streaming support
# Used by /api/chat/ locations across all server blocks
# Enables real-time AI response streaming via Server-Sent Events
#
# Note: X-Request-ID header must be set in location block before include:
#   proxy_set_header X-Request-ID $final_request_id;  # for port 443
#   proxy_set_header X-Request-ID $request_id_header; # for port 8080

limit_req zone=general burst=5 nodelay;
limit_conn perip 30;
limit_conn perserver 2000;

proxy_pass http://openwebui_backend;
proxy_set_header Host $host;
proxy_set_header X-Real-IP $remote_addr;
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_set_header X-Forwarded-Proto $scheme;

proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $connection_upgrade;
proxy_cache_bypass $http_upgrade;

# Extended timeouts for AI response generation
proxy_connect_timeout 30s;
proxy_send_timeout 300s;
proxy_read_timeout 600s;

# Large request body support
client_max_body_size 100M;
client_body_timeout 120s;

# Disable ALL buffering for SSE streaming
proxy_buffering off;
proxy_request_buffering off;

# SSE streaming headers - critical for real-time AI responses
add_header X-Accel-Buffering "no" always;
add_header Cache-Control "no-cache, no-store, must-revalidate" always;
chunked_transfer_encoding on;
