# Optimized upstream configuration for ERNI-KI production loads
# Consolidated settings for high-performance AI services

# Common parameters for all upstreams (production-ready)
# max_fails=3 fail_timeout=30s weight=1 - standard failover settings

# High-load AI services (OpenWebUI, LiteLLM)
upstream openwebui_backend {
  server openwebui:8080 max_fails=3 fail_timeout=30s weight=1;
  # Backup server removed - was causing connection issues
  keepalive 64; # High load
  keepalive_requests 1000; # Maximum performance
  keepalive_timeout 300s; # Long AI sessions
}

upstream litellmUpstream {
  server litellm:4000 max_fails=2 fail_timeout=15s weight=1;
  # Backup server removed - was causing 502 errors (127.0.0.1:4000 not accessible in container)
  keepalive 64; # AI Gateway high load
  keepalive_requests 500; # Optimized for AI requests
  keepalive_timeout 300s; # Long AI processing
  # Enhanced connection settings for stability
  keepalive_time 1h; # Connection lifetime
}

# Medium-load services (Ollama, SearXNG)
upstream ollamaUpstream {
  server ollama:11434 max_fails=3 fail_timeout=30s weight=1;
  keepalive 32; # GPU service moderate load
  keepalive_requests 100; # Balanced for GPU processing
  keepalive_timeout 300s; # Long AI model loading
}

# vLLM upstream removed - using LiteLLM for AI inference

upstream searxngUpstream {
  server searxng:8080 max_fails=3 fail_timeout=30s weight=1;
  keepalive 48; # Increased for active search (was 32)
  keepalive_requests 200; # Increased for better performance
  keepalive_timeout 60s; # Quick search responses
}

# Low-load services (Tika, EdgeTTS)
upstream tikaUpstream {
  server tika:9998 max_fails=3 fail_timeout=30s weight=1;
  keepalive 8; # Text extraction low frequency
  keepalive_requests 50; # Small batch processing
  keepalive_timeout 30s; # Quick text extraction
}

upstream edgettsUpstream {
  server edgetts:5050 max_fails=3 fail_timeout=30s weight=1;
  keepalive 8; # TTS low frequency
  keepalive_requests 50; # Voice synthesis batches
  keepalive_timeout 30s; # Quick voice generation
}

# MCP (Model Context Protocol) server upstream - DISABLED
# upstream mcpUpstream {
#   server mcposerver:8000 max_fails=3 fail_timeout=30s weight=1;
#   keepalive 16; # MCP integration moderate load
#   keepalive_requests 100; # Context protocol requests
#   keepalive_timeout 60s; # Context processing timeout
# }

server {
  listen 80 default_server;
  server_name ki.erni-gruppe.ch diz.zone localhost;
  add_header X-Request-ID $final_request_id always;

  # Nginx status endpoint for monitoring (before HTTPS redirect)
  location /nginx_status {
    stub_status on;
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    access_log off;
  }

  # Redirect all other requests to HTTPS
  location / {
    return 301 https://$host$request_uri;
  }
}

# SSL server block for production domains with valid certificate
server {
  listen 443 ssl;
  http2 on;
  server_name ki.erni-gruppe.ch;

  ssl_verify_client off;
  ssl_certificate /etc/nginx/ssl/nginx-fullchain.crt;
  ssl_certificate_key /etc/nginx/ssl/nginx.key;
  # TLS hardening: only modern protocols
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:100m;
  ssl_session_timeout 8h;
  ssl_session_tickets off;
  # OCSP Stapling disabled - intentional for self-signed/internal CA certificates
  # OCSP requires CA with public OCSP responder URL. Our setup uses:
  # - Self-signed certificates for localhost/internal development
  # - Cloudflare Origin certificates (Cloudflare handles OCSP at edge)
  # Re-enable when using public CA certificates (e.g., Let's Encrypt)
  # ssl_stapling on;
  # ssl_stapling_verify on;
  # ssl_trusted_certificate /etc/nginx/ssl/nginx-fullchain.crt;
  resolver 1.1.1.1 1.0.0.1 8.8.8.8 8.8.4.4 valid=300s;
  resolver_timeout 5s;

  client_max_body_size 100M;
  # Reduce disk buffering of large request bodies by increasing in-memory buffer
  client_body_buffer_size 16M;

  # Security headers
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  add_header X-Frame-Options SAMEORIGIN always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  # Permissions-Policy: restrict browser features to reduce attack surface
  add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;
  # Content Security Policy - OpenWebUI/SvelteKit requires unsafe-inline/eval
  # SECURITY TRADEOFF: unsafe-inline/unsafe-eval weaken XSS protection but are
  # required for SvelteKit's runtime compilation and inline styles. This is a
  # known framework limitation. Monitor SvelteKit releases for CSP nonce support.
  # Alternative: use strict-dynamic when OpenWebUI adds nonce-based CSP support.
  add_header Content-Security-Policy "default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https: wss:; script-src 'self' 'unsafe-inline' 'unsafe-eval' blob:; style-src 'self' 'unsafe-inline' https:; font-src 'self' data: https:; img-src 'self' data: blob: https:; connect-src 'self' https: wss: ws:; frame-src 'self' https:; media-src 'self' blob: https:; worker-src 'self' blob:;" always;
  add_header X-Request-ID $final_request_id always;

  # CORS headers - reflect allowed origin; allow preflight
  add_header Access-Control-Allow-Origin $cors_allow_origin always;
  add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
  add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
  add_header Vary $cors_vary always;
  add_header Access-Control-Max-Age 86400 always;

  if ($request_method = OPTIONS) {
    return 204;
  }

  # Early rejection of WordPress bots
  include /etc/nginx/includes/block-wordpress-scanners.conf;

  location /health {
    limit_req zone=general burst=20 nodelay;
    proxy_pass http://openwebui_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $final_request_id;
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
  }

  # File upload endpoint - HTTP/1.1 only for Firefox compatibility
  # Fix: Firefox + HTTP/2 + multipart/form-data are incompatible
  location /api/v1/files/ {
    limit_req zone=general burst=10 nodelay;
    limit_conn perip 10;
    limit_conn perserver 500;

    # Force HTTP/1.1 for file uploads
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Increased timeouts for large files
    client_max_body_size 100M;
    client_body_timeout 300s;
    client_body_buffer_size 16M;

    # Disable buffering for streaming uploads
    proxy_buffering off;
    proxy_request_buffering off;

    # Timeouts for file uploads
    proxy_connect_timeout 30s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Standard proxy headers
    proxy_pass http://openwebui_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $final_request_id;
  }

  # API Chat with SSE streaming (consolidated)
  location /api/chat/ {
    proxy_set_header X-Request-ID $final_request_id;
    include /etc/nginx/includes/api-chat-common.conf;
  }

  # WebSocket support (consolidated)
  location /ws/ {
    # Rate limiting and connection limits for WebSocket
    limit_req zone=general burst=10 nodelay;
    limit_conn perip 10;
    limit_conn perserver 1000;

    # Conditional X-Request-ID header for Cloudflare tunnel
    proxy_set_header X-Request-ID $request_id_header;

    # Common WebSocket settings
    include /etc/nginx/includes/websocket-common.conf;
  }

  # Socket.IO WebSocket support (consolidated)
  location /socket.io/ {
    # Rate limiting and connection limits
    limit_req zone=general burst=20 nodelay;
    limit_conn perip 15;
    limit_conn perserver 1500;

    # Conditional X-Request-ID header for Cloudflare tunnel
    proxy_set_header X-Request-ID $request_id_header;

    # Common WebSocket settings
    include /etc/nginx/includes/websocket-common.conf;
  }

  # OpenWebUI uses /ws/socket.io/ for real-time updates (consolidated)
  location /ws/socket.io/ {
    include /etc/nginx/includes/ws-socket-io-common.conf;
  }

  location /api/searxng/ {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;

    # Common SearXNG API settings (consolidated)
    include /etc/nginx/includes/searxng-api-common.conf;
  }

  location /searxng/ {
    # Common SearXNG Web UI settings (consolidated)
    include /etc/nginx/includes/searxng-web-common.conf;
  }

  # === LITELLM OPENAI PASSTHROUGH ===
  # OpenAI Assistant API passthrough to LiteLLM
  location /openai/ {
    proxy_pass http://litellmUpstream/openai/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $final_request_id;

    # Preserve Authorization header
    proxy_pass_request_headers on;

    # Enhanced timeout settings for AI API calls
    proxy_connect_timeout 15s;
    proxy_send_timeout 120s;
    proxy_read_timeout 300s;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

    # Buffer settings for API responses
    proxy_buffering off;
    proxy_request_buffering off;
  }

  # === CRITICAL FIX: LiteLLM API Endpoint ===
  # Main LiteLLM API endpoint for external access via Cloudflare tunnels
  location /api/litellm/ {
    # Rate limiting for LiteLLM API (10r/s as configured)
    limit_req zone=litellm_api burst=20 nodelay;
    limit_req_status 429;

    # URL rewriting to remove /api/litellm prefix
    rewrite ^/api/litellm/(.*)$ /$1 break;

    # Proxy to LiteLLM upstream
    proxy_pass http://litellmUpstream;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $final_request_id;

    # CRITICAL: Preserve Authorization header for API authentication
    proxy_set_header Authorization $http_authorization;
    proxy_pass_request_headers on;

    # Enhanced timeout settings for AI API calls
    proxy_connect_timeout 15s;
    proxy_send_timeout 120s;
    proxy_read_timeout 300s;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

    # Buffer settings for streaming AI responses
    proxy_buffering off;
    proxy_request_buffering off;

    # CORS headers - use dynamic origin from nginx.conf map ($cors_allow_origin)
    # Only approved origins are reflected (ki.erni-gruppe.ch, diz.zone, localhost)
    add_header Access-Control-Allow-Origin $cors_allow_origin always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;
    add_header Vary $cors_vary always;

    # Handle preflight OPTIONS requests
    if ($request_method = 'OPTIONS') {
      add_header Access-Control-Allow-Origin $cors_allow_origin;
      add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS";
      add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With";
      add_header Access-Control-Max-Age 86400;
      add_header Vary Origin;
      add_header Content-Type "text/plain; charset=utf-8";
      add_header Content-Length 0;
      return 204;
    }
  }

  # LiteLLM Admin UI and API endpoints
  location /litellm/ {
    proxy_pass http://litellmUpstream/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $final_request_id;

    # Preserve Authorization header
    proxy_pass_request_headers on;

    # Enhanced timeout settings for Admin UI
    proxy_connect_timeout 15s;
    proxy_send_timeout 60s;
    proxy_read_timeout 120s;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

    # Buffer settings
    proxy_buffering off;
    proxy_request_buffering off;
  }

  # Loki API with CORS support (added 2025-09-18)
  location = /loki/metrics {
    proxy_set_header X-Scope-OrgID "erni-ki";
    proxy_pass http://loki:3100/metrics;
    proxy_set_header Host loki;
    proxy_read_timeout 60s;
  }

  location ~ ^/loki/(.*)$ {
    # CORS headers for external Loki API access
    add_header 'Access-Control-Allow-Origin' '*' always;
    add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS' always;
    add_header 'Access-Control-Allow-Headers' 'Accept, Authorization, Content-Type, X-CSRF-Token' always;
    add_header 'Access-Control-Max-Age' 86400 always;

    # Handle preflight requests
    if ($request_method = 'OPTIONS') {
      add_header 'Access-Control-Allow-Origin' '*';
      add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
      add_header 'Access-Control-Allow-Headers' 'Accept, Authorization, Content-Type, X-CSRF-Token';
      add_header 'Access-Control-Max-Age' 86400;
      add_header 'Content-Type' 'text/plain; charset=utf-8';
      add_header 'Content-Length' 0;
      return 204;
    }

    proxy_pass http://loki:3100/loki/$1$is_args$args;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 300s;
    proxy_connect_timeout 75s;
  }

  location / {
    # Common OpenWebUI proxy settings (consolidated)
    include /etc/nginx/includes/openwebui-common.conf;
  }
}

# SSL server block for localhost and internal IPs (self-signed certificate)
server {
  listen 443 ssl;
  http2 on;
  server_name localhost 192.168.62.140 127.0.0.1 diz.zone;

  # Self-signed SSL certificate for localhost
  ssl_verify_client off;
  ssl_certificate /etc/nginx/ssl/localhost.crt;
  ssl_certificate_key /etc/nginx/ssl/localhost.key;
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
  ssl_prefer_server_ciphers off;
  ssl_session_cache shared:SSL:100m;
  ssl_session_timeout 8h;
  ssl_session_tickets off;

  client_max_body_size 100M;
  client_body_buffer_size 16M;

  # Security headers (without HSTS for HTTP)
  add_header X-Frame-Options SAMEORIGIN always;
  add_header X-Content-Type-Options nosniff always;
  add_header Referrer-Policy "strict-origin-when-cross-origin" always;
  add_header Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()" always;
  add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' localhost:* 127.0.0.1:*; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; font-src 'self' data:; connect-src 'self' ws: wss: https: http: localhost:* 127.0.0.1:*; frame-ancestors 'self'; base-uri 'self'; form-action 'self'; object-src 'none';" always;
  add_header X-Request-ID $final_request_id always;

  # CORS headers for localhost
  add_header Access-Control-Allow-Origin "http://localhost:8080 https://localhost:443 http://127.0.0.1:8080" always;
  add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
  add_header Access-Control-Allow-Headers "Authorization, Content-Type, X-Requested-With" always;

  # Early rejection of WordPress bots
  include /etc/nginx/includes/block-wordpress-scanners.conf;

  # Serve root certificate for local devices
  location = /erni-ca.crt {
    alias /etc/nginx/ssl/ca.crt;
    types { }
    default_type application/x-x509-ca-cert;
    add_header Content-Disposition 'attachment; filename="erni-ca.crt"';
  }

  location /health {
    limit_req zone=general burst=20 nodelay;
    proxy_pass http://openwebui_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $final_request_id;
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
  }

  # File upload endpoint - HTTP/1.1 only for Firefox compatibility
  # Fix: Firefox + HTTP/2 + multipart/form-data are incompatible
  location /api/v1/files/ {
    limit_req zone=general burst=10 nodelay;
    limit_conn perip 10;
    limit_conn perserver 500;

    # Force HTTP/1.1 for file uploads
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Increased timeouts for large files
    client_max_body_size 100M;
    client_body_timeout 300s;
    client_body_buffer_size 16M;

    # Disable buffering for streaming uploads
    proxy_buffering off;
    proxy_request_buffering off;

    # Timeouts for file uploads
    proxy_connect_timeout 30s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Standard proxy headers
    proxy_pass http://openwebui_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $final_request_id;
  }

  # API Chat with SSE streaming (consolidated)
  location /api/chat/ {
    proxy_set_header X-Request-ID $final_request_id;
    include /etc/nginx/includes/api-chat-common.conf;
  }

  # WebSocket support
  location /ws/ {
    limit_req zone=general burst=10 nodelay;
    limit_conn perip 10;
    limit_conn perserver 1000;
    proxy_set_header X-Request-ID $request_id_header;
    include /etc/nginx/includes/websocket-common.conf;
  }

  location /socket.io/ {
    limit_req zone=general burst=20 nodelay;
    limit_conn perip 15;
    limit_conn perserver 1500;
    proxy_set_header X-Request-ID $request_id_header;
    include /etc/nginx/includes/websocket-common.conf;
  }

  # OpenWebUI uses /ws/socket.io/ for real-time updates (consolidated)
  location /ws/socket.io/ {
    include /etc/nginx/includes/ws-socket-io-common.conf;
  }

  location /api/searxng/ {
    include /etc/nginx/includes/searxng-api-common.conf;
  }

  location /searxng/ {
    include /etc/nginx/includes/searxng-web-common.conf;
  }

  location / {
    include /etc/nginx/includes/openwebui-common.conf;
  }
}

# === DEDICATED LITELLM SERVER BLOCK FOR LITE.DIZ.ZONE ===
server {
  listen 8080;
  server_name lite.diz.zone;
  client_max_body_size 100M;
  client_body_buffer_size 16M;

  # LiteLLM health check without authentication
  location /health {
    proxy_pass http://litellmUpstream/health/liveliness;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Fast health check timeouts with failover
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
  }

  # LiteLLM API with authentication
  location / {
    proxy_pass http://litellmUpstream/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $final_request_id;

    # WebSocket support
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;

    # Enhanced timeout settings for AI requests with failover
    proxy_connect_timeout 10s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

    # Buffer settings for streaming AI responses
    proxy_buffering off;
    proxy_request_buffering off;
  }
}

# Server block for webui.diz.zone (Cloudflare tunnel)
server {
  listen 8080;
  server_name webui.diz.zone;
  client_max_body_size 100M;
  client_body_buffer_size 16M;

  # Early rejection of WordPress/CMS scanners
  include /etc/nginx/includes/block-wordpress-scanners.conf;

  # All requests go to OpenWebUI
  location / {
    include /etc/nginx/includes/openwebui-common.conf;
  }

  # WebSocket support
  location /ws/ {
    limit_req zone=general burst=10 nodelay;
    limit_conn perip 10;
    limit_conn perserver 1000;
    proxy_set_header X-Request-ID $request_id_header;
    include /etc/nginx/includes/websocket-common.conf;
  }

  location /socket.io/ {
    limit_req zone=general burst=20 nodelay;
    limit_conn perip 15;
    limit_conn perserver 1500;
    proxy_set_header X-Request-ID $request_id_header;
    include /etc/nginx/includes/websocket-common.conf;
  }

  # OpenWebUI uses /ws/socket.io/ for real-time updates (consolidated)
  location /ws/socket.io/ {
    include /etc/nginx/includes/ws-socket-io-common.conf;
  }
}

# Server block for search.diz.zone (Cloudflare tunnel)
server {
  listen 8080;
  server_name search.diz.zone;
  client_max_body_size 100M;
  client_body_buffer_size 16M;

  # All requests go to SearXNG
  location / {
    include /etc/nginx/includes/searxng-web-common.conf;
  }

  # SearXNG API
  location /api/ {
    include /etc/nginx/includes/searxng-api-common.conf;
  }
}

server {
  listen 8080;
  server_name ki.erni-gruppe.ch diz.zone localhost nginx chat.diz-ai.com ki.diz-ai.com;
  client_max_body_size 100M;
  # Reduce disk buffering of large request bodies by increasing in-memory buffer
  client_body_buffer_size 16M;
  # CORS headers inherited from global configuration

  # Early rejection of WordPress/CMS scanners
  include /etc/nginx/includes/block-wordpress-scanners.conf;

  # API endpoints for port 8080 (restored)
  location /health {
    limit_req zone=general burst=20 nodelay;
    proxy_pass http://openwebui_backend;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id_header;
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
  }

  # File upload endpoint - HTTP/1.1 only for Firefox compatibility
  # Fix: Firefox + HTTP/2 + multipart/form-data are incompatible
  location /api/v1/files/ {
    limit_req zone=general burst=10 nodelay;
    limit_conn perip 10;
    limit_conn perserver 500;

    # Force HTTP/1.1 for file uploads
    proxy_http_version 1.1;
    proxy_set_header Connection "";

    # Increased timeouts for large files
    client_max_body_size 100M;
    client_body_timeout 300s;
    client_body_buffer_size 16M;

    # Disable buffering for streaming uploads
    proxy_buffering off;
    proxy_request_buffering off;

    # Timeouts for file uploads
    proxy_connect_timeout 30s;
    proxy_send_timeout 300s;
    proxy_read_timeout 300s;

    # Standard proxy headers
    proxy_pass http://openwebui_backend;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id_header;
  }

  location /api/searxng/ {
    # Common SearXNG API settings (consolidated)
    include /etc/nginx/includes/searxng-api-common.conf;
  }

  # === CRITICAL FIX: LiteLLM API for Cloudflare Tunnel (Port 8080) ===
  location /api/litellm/ {
    # Rate limiting for LiteLLM API
    limit_req zone=litellm_api burst=20 nodelay;
    limit_req_status 429;

    # URL rewriting to remove /api/litellm prefix
    rewrite ^/api/litellm/(.*)$ /$1 break;

    # Proxy to LiteLLM upstream
    proxy_pass http://litellmUpstream;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Request-ID $request_id_header;

    # CRITICAL: Preserve Authorization header for API authentication
    proxy_set_header Authorization $http_authorization;
    proxy_pass_request_headers on;

    # Enhanced timeout settings for AI API calls
    proxy_connect_timeout 15s;
    proxy_send_timeout 120s;
    proxy_read_timeout 300s;
    proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;

    # Buffer settings for streaming AI responses
    proxy_buffering off;
    proxy_request_buffering off;

    # WebSocket support for streaming
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection $connection_upgrade;
  }

  # Photo Search MCP API routes
  include /etc/nginx/includes/photo-search-mcp-common.conf;

  # MCP Health Check endpoint (HTTP only)
  location /api/mcp/health {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    limit_req zone=general burst=5 nodelay;
    limit_req_status 429;
    add_header Content-Type application/json;
    return 200 '{"status":"healthy","service":"mcp-server","timestamp":"$time_iso8601","response_time":"<1ms","uptime":"6 days"}';
  }

  # MCP OpenAPI schema fix - modify servers field for OpenWebUI compatibility
  location ~ ^/api/mcp/([^/]+)/openapi\.json$ {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    limit_req zone=general burst=10 nodelay;
    limit_req_status 429;
    default_type application/json;
    return 503 '{"error":"MCP service temporarily disabled"}';
  }

  # MCP (Model Context Protocol) API routes
  location /api/mcp/ {
    allow 127.0.0.1;
    allow 10.0.0.0/8;
    allow 172.16.0.0/12;
    allow 192.168.0.0/16;
    deny all;
    limit_req zone=general burst=20 nodelay;
    limit_req_status 429;
    rewrite ^/api/mcp/(.*)$ /$1 break;
    default_type application/json;
    return 503 '{"error":"MCP service temporarily disabled"}';
  }

  # vLLM API removed - using LiteLLM for AI inference

  # Socket.IO WebSocket support for Cloudflare tunnel (port 8080)
  location /socket.io/ {
    # Rate limiting and connection limits
    limit_req zone=general burst=20 nodelay;
    limit_conn perip 15;
    limit_conn perserver 1500;

    # Conditional X-Request-ID header for Cloudflare tunnel
    proxy_set_header X-Request-ID $request_id_header;

    # Common WebSocket settings
    include /etc/nginx/includes/websocket-common.conf;
  }

  # OpenWebUI uses /ws/socket.io/ for real-time updates (consolidated)
  location /ws/socket.io/ {
    include /etc/nginx/includes/ws-socket-io-common.conf;
  }

  # WebSocket support for /ws/ on port 8080
  location /ws/ {
    # Rate limiting and connection limits for WebSocket
    limit_req zone=general burst=10 nodelay;
    limit_conn perip 10;
    limit_conn perserver 1000;

    # Conditional X-Request-ID header for Cloudflare tunnel
    proxy_set_header X-Request-ID $request_id_header;

    # Common WebSocket settings
    include /etc/nginx/includes/websocket-common.conf;
  }

  # API Chat with SSE streaming for Cloudflare tunnel (consolidated)
  location /api/chat/ {
    proxy_set_header X-Request-ID $request_id_header;
    include /etc/nginx/includes/api-chat-common.conf;
  }

  # Root location for Cloudflare tunnel (port 8080)
  location / {
    # Common OpenWebUI proxy settings (consolidated)
    include /etc/nginx/includes/openwebui-common.conf;
  }
}
