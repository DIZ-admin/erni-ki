user nginx;
worker_processes auto;
worker_rlimit_nofile 262144; # Увеличено для высокой нагрузки

# КРИТИЧЕСКИЙ сервис - INFO для диагностики веб-сервера
error_log /var/log/nginx/error.log info;
pid /var/run/nginx.pid;

events {
  worker_connections 16384; # Увеличено с 8192 для лучшей производительности
  use epoll; # Оптимизация для Linux
  multi_accept on; # Принимать несколько соединений одновременно
}

http {
  include /etc/nginx/mime.types;
  default_type application/octet-stream;

  # ============================================================================
  # GZIP COMPRESSION CONFIGURATION - Оптимизация производительности
  # ============================================================================

  # Gzip сжатие для оптимизации трафика
  gzip on;
  gzip_vary on;
  gzip_min_length 1024;
  gzip_proxied any;
  gzip_comp_level 6;
  gzip_types
  text/plain
  text/css
  text/xml
  text/javascript
  application/json
  application/javascript
  application/xml+rss
  application/atom+xml
  image/svg+xml;

  # ============================================================================
  # CORRELATION ID CONFIGURATION - Фаза 2 оптимизации логгирования
  # ============================================================================

  # Генерация уникального Request ID для трассировки запросов
  map $request_id $correlation_id {
    default $request_id;
  }

  # Если клиент уже передал X-Request-ID, используем его
  map $http_x_request_id $final_request_id {
    default $correlation_id;
    ~.+ $http_x_request_id;
  }

  log_format compression '$remote_addr - $remote_user [$time_local] '
  '"$request" $status $body_bytes_sent '
  '"$http_referer" "$http_user_agent" "$gzip_ratio" '
  'request_id="$final_request_id"';

  # Специальный формат для мониторинга rate limiting с correlation ID
  log_format rate_limit_json escape=json '{'
  '"timestamp":"$time_iso8601",'
  '"remote_addr":"$remote_addr",'
  '"request":"$request",'
  '"status":$status,'
  '"request_time":$request_time,'
  '"upstream_response_time":"$upstream_response_time",'
  '"user_agent":"$http_user_agent",'
  '"referer":"$http_referer",'
  '"host":"$host",'
  '"request_id":"$final_request_id",'
  '"service":"nginx",'
  '"level":"warn"'
  '}';

  # Переменная для логирования rate limiting
  map $status $rate_limit_log {
    429 1;
    default 0;
  }

  # Основное логирование всех запросов для мониторинга
  access_log /var/log/nginx/access.log combined;

  # Специализированное логирование rate limiting событий
  access_log /var/log/nginx/rate_limit.log rate_limit_json if=$rate_limit_log;

  # Возвращаем Request-ID в каждый ответ
  add_header X-Request-ID $final_request_id always;

  # Логирование ошибок upstream для диагностики с correlation ID
  log_format upstream_errors '$time_iso8601 [$status] $request_method $scheme://$host$request_uri '
  'upstream: $upstream_addr response_time: $upstream_response_time '
  'client: $remote_addr user_agent: "$http_user_agent" '
  'request_id: "$final_request_id"';

  # Специальный формат для SearXNG с детальной информацией и correlation ID
  log_format searxng_detailed '$time_iso8601 [$status] $request_method $request_uri '
  'response_time: $request_time upstream_time: $upstream_response_time '
  'client: $remote_addr query: "$args" user_agent: "$http_user_agent" '
  'request_id: "$final_request_id"';

  # Переменная для логирования upstream ошибок
  map $status $log_upstream_errors {
    ~^5 1; # 5xx ошибки
    default 0;
  }

  # Переменная для логирования SearXNG проблем (только ошибки и медленные запросы)
  map $status $log_searxng_issues {
    ~^[45] 1; # 4xx и 5xx ошибки
    default 0;
  }

  # Переменная для логирования медленных запросов (>2s)
  map $request_time $log_slow_requests {
    ~^[2-9] 1; # 2+ секунд
    ~^[0-9][0-9] 1; # 10+ секунд
    default 0;
  }

  access_log /var/log/nginx/upstream_errors.log upstream_errors if=$log_upstream_errors;

  sendfile on;
  keepalive_timeout 65;

  # DNS resolver для Docker с динамической резолюцией
  resolver 127.0.0.11 valid=10s ipv6=off;
  resolver_timeout 5s;

  # WebSocket upgrade mapping (безопасная схема)
  map $http_upgrade $connection_upgrade {
    default close;
    "websocket" upgrade;
  }

  # Настройки для получения реального IP от Cloudflare
  # Cloudflare IP диапазоны для real_ip модуля
  set_real_ip_from 173.245.48.0/20;
  set_real_ip_from 103.21.244.0/22;
  set_real_ip_from 103.22.200.0/22;
  set_real_ip_from 141.101.64.0/18;
  set_real_ip_from 108.162.192.0/18;
  set_real_ip_from 188.114.96.0/20;
  set_real_ip_from 172.16.0.0/12; # Docker internal networks
  real_ip_header CF-Connecting-IP;
  real_ip_recursive on;

  # Rate limiting zones оптимизированы для корпоративной сети ERNI
  # Переменная для определения доверенных IP (внутренняя сеть ERNI)
  geo $is_trusted_ip {
    default 0;
    127.0.0.1/32 1;
    10.0.0.0/8 1;
    172.16.0.0/12 1;
    192.168.0.0/16 1;
    # Добавить конкретные IP диапазоны ERNI при необходимости
  }

  # Rate limiting зоны (безопасная модель с индивидуальными ключами)
  # Доверенность решается через ACL в локациях, а не через пустые ключи
  map $is_trusted_ip $rate_is_trusted {
    1 1; 0 0;
  }

  # CORS origin reflect с белым списком доменов (безопасная модель)
  map $http_origin $cors_ok {
    default 0;
    "~^https?://(ki\.erni-gruppe\.ch|diz\.zone|localhost(:\d+)?|127\.0\.0\.1(:\d+)?)$" 1;
  }

  # Определение типа сервера по порту для условной логики
  map $server_port $is_cloudflare_tunnel {
    default 0;
    8080 1;
  }

  # Условный X-Request-ID заголовок для Cloudflare туннеля
  map $is_cloudflare_tunnel $request_id_header {
    default "";
    1 $final_request_id;
  }

  # Универсальная переменная для X-Request-ID в include файлах
  map $is_cloudflare_tunnel $universal_request_id {
    default $final_request_id;
    1 $final_request_id;
  }

  limit_req_zone $binary_remote_addr zone=general:20m rate=50r/s;
  limit_req_zone $binary_remote_addr zone=api:20m rate=30r/s;
  limit_req_zone $binary_remote_addr zone=static:20m rate=100r/s;
  limit_req_zone $binary_remote_addr zone=auth:10m rate=5r/s;
  limit_req_zone $binary_remote_addr zone=searxng_api:10m rate=60r/s;
  limit_req_zone $binary_remote_addr zone=searxng_web:10m rate=40r/s;
  limit_req_zone $binary_remote_addr zone=docling_api:10m rate=5r/s;
  limit_req_zone $binary_remote_addr zone=litellm_api:10m rate=10r/s;
  limit_req_zone $binary_remote_addr zone=ollama_api:10m rate=5r/s;

  # Connection limiting
  limit_conn_zone $binary_remote_addr zone=perip:10m;
  limit_conn_zone $server_name zone=perserver:10m;

  # Кэширование для статических файлов (постоянный путь)
  proxy_cache_path /var/cache/nginx/static levels=1:2 keys_zone=static_cache:100m
  max_size=1g inactive=60m use_temp_path=off;

  # Кэширование для SearXNG поисковых запросов (постоянный путь)
  proxy_cache_path /var/cache/nginx/searxng levels=1:2 keys_zone=searxng_cache:256m
  max_size=2g inactive=30m use_temp_path=off;

  # Upstream блоки определены в conf.d/default.conf

  # Все upstream блоки определены в conf.d/default.conf
  include /etc/nginx/conf.d/*.conf;
}
