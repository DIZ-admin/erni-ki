# Database Alert Rules
# Covers: PostgreSQL, Redis, Redis backups

groups:
  # PostgreSQL rules
  - name: postgres.rules
    rules:
      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 30s
        labels:
          severity: critical
          service: postgres
          category: database
        annotations:
          summary: "PostgreSQL is down"
          description: "PostgreSQL database has been down for more than 30 seconds."

      - alert: PostgreSQLTooManyConnections
        expr: pg_stat_activity_count > 80
        for: 5m
        labels:
          severity: warning
          service: postgres
          category: database
        annotations:
          summary: "Too many PostgreSQL connections"
          description: "PostgreSQL has more than 80 active connections for more than 5 minutes."

      - alert: PostgreSQLSlowQueries
        expr: pg_stat_activity_max_tx_duration > 300
        for: 2m
        labels:
          severity: warning
          service: postgres
          category: database
        annotations:
          summary: "PostgreSQL slow queries detected"
          description: "PostgreSQL has queries running for more than 5 minutes."

  # Redis rules
  - name: redis.rules
    rules:
      - alert: RedisDown
        expr: up{job="redis"} == 0
        for: 30s
        labels:
          severity: critical
          service: redis
          category: cache
        annotations:
          summary: "Redis is down"
          description: "Redis cache service has been down for more than 30 seconds."

      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes > (512 * 1024 * 1024 * 0.9)
        for: 5m
        labels:
          severity: warning
          service: redis
          category: cache
        annotations:
          summary: "Redis high memory usage"
          description: "Redis memory usage is above 90% of 512MB limit ({{ $value | humanize1024 }}B used)."

      - alert: RedisCriticalMemoryUsage
        expr: redis_memory_used_bytes > (512 * 1024 * 1024 * 0.95)
        for: 2m
        labels:
          severity: critical
          service: redis
          category: cache
        annotations:
          summary: "Redis critical memory usage"
          description: "Redis memory usage is above 95% of 512MB limit ({{ $value | humanize1024 }}B used). Eviction may occur."

      - alert: RedisHighConnections
        expr: redis_connected_clients > 80
        for: 5m
        labels:
          severity: warning
          service: redis
          category: cache
        annotations:
          summary: "Redis high connection count"
          description: "Redis has {{ $value }} connected clients (>80% of typical load)."

      - alert: RedisLowHitRatio
        expr: (rate(redis_keyspace_hits_total[5m]) / (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m]))) < 0.8 and (rate(redis_keyspace_hits_total[5m]) + rate(redis_keyspace_misses_total[5m])) > 0.1
        for: 10m
        labels:
          severity: warning
          service: redis
          category: cache
        annotations:
          summary: "Redis low cache hit ratio"
          description: "Redis cache hit ratio is {{ $value | humanizePercentage }} (below 80%) for more than 10 minutes."

      - alert: RedisSlowOperations
        expr: increase(redis_slowlog_length[5m]) > 0
        for: 2m
        labels:
          severity: warning
          service: redis
          category: cache
        annotations:
          summary: "Redis slow operations detected"
          description: "Redis has {{ $value }} slow operations in the last 5 minutes."

  # Redis backup rules
  - name: redis-backup.rules
    rules:
      - alert: RedisBackupFailed
        expr: redis_backup_last_success == 0
        for: 1h
        labels:
          severity: critical
          service: redis-backup
          category: backup
        annotations:
          summary: "Redis backup failed"
          description: "Redis backup has not been successful for more than 1 hour."

      - alert: RedisBackupStale
        expr: (time() - redis_backup_last_timestamp) > 86400
        for: 30m
        labels:
          severity: warning
          service: redis-backup
          category: backup
        annotations:
          summary: "Redis backup is stale"
          description: "Redis backup is older than 24 hours ({{ $value | humanizeDuration }} ago)."

      - alert: RedisBackupIntegrityFailed
        expr: redis_backup_integrity_ok == 0
        for: 15m
        labels:
          severity: critical
          service: redis-backup
          category: backup
        annotations:
          summary: "Redis backup integrity check failed"
          description: "Redis backup integrity check has been failing for more than 15 minutes."

      - alert: RedisBackupServiceDown
        expr: redis_backup_backrest_up == 0
        for: 5m
        labels:
          severity: critical
          service: redis-backup
          category: backup
        annotations:
          summary: "Redis backup service is down"
          description: "Backrest service for Redis backup is not responding for more than 5 minutes."

      - alert: RedisRDBFileStale
        expr: redis_backup_rdb_age_seconds > 172800
        for: 1h
        labels:
          severity: warning
          service: redis-backup
          category: backup
        annotations:
          summary: "Redis RDB file is stale"
          description: "Redis RDB file is older than 48 hours ({{ $value | humanizeDuration }} old)."
