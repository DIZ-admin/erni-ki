# Prometheus configuration for erni-ki project
# Service metrics collection and AI infrastructure monitoring
# Optimized according to best practices 2025 (updated 2025-09-25)

global:
  scrape_interval: 30s # Optimized for AI workloads
  evaluation_interval: 30s # Synchronized with scrape_interval
  scrape_timeout: 10s # Global timeout for stability
  external_labels:
    cluster: "erni-ki"
    environment: "production"
    region: "eu-central"
  # Retention policy optimized for production AI metrics (updated)
  # Retention: 30 days for detailed metrics (increased from 15 days)
  # Size: 50GB maximum for optimal disk usage
  # Downsampling: 5m aggregation after 24h

# Alerting rules - Modular structure (refactored 2025-12-16)
# All rules consolidated into categorized files in rules/ directory:
#   10-infrastructure.yml - ServiceDown, CPU, Memory, Disk, Container alerts
#   20-databases.yml      - PostgreSQL, Redis, Redis backup alerts
#   30-ai-services.yml    - Auth, Ollama, OpenWebUI, LiteLLM, RAG, SearXNG alerts
#   40-logging.yml        - Elasticsearch, Fluent Bit alerts
#   50-gpu.yml            - NVIDIA GPU monitoring alerts
#   60-sla.yml            - Nginx, Security, Cloudflare, Cron, Prometheus alerts
rule_files:
  - "rules/*.yml"

# Alertmanager configuration
alerting:
  alertmanagers:
    - static_configs:
        - targets:
            - alertmanager:9093

# Metrics collection configuration
scrape_configs:
  # ============================================================================
  # CORE INFRASTRUCTURE MONITORING (USE Methodology)
  # ============================================================================

  # Prometheus self-monitoring
  - job_name: "prometheus"
    static_configs:
      - targets: ["localhost:9090"]
    scrape_interval: 60s # Reduced for self-monitoring
    metrics_path: /metrics
    scrape_timeout: 15s

  # Alertmanager metrics for cluster and queue monitoring
  - job_name: "alertmanager"
    static_configs:
      - targets: ["alertmanager:9093"]
    scrape_interval: 30s # Optimized for queue monitoring
    metrics_path: /metrics
    scrape_timeout: 15s
    # USE metrics:
    # - alertmanager_cluster_messages_queued (Saturation)
    # - alertmanager_cluster_health_score (Errors)
    # - alertmanager_cluster_members (Utilization)

  # Node Exporter for system metrics (USE: CPU, Memory, Disk, Network)
  # FIXED 2025-10-24: Increased timeout to prevent connection reset errors
  - job_name: "node-exporter"
    static_configs:
      - targets: ["node-exporter:9100"]
    scrape_interval: 60s # Reduced load to mitigate broken pipe resets
    scrape_timeout: 15s  # Default-like timeout to avoid long-lived connections
    metrics_path: /metrics
    # USE metrics:
    # - node_cpu_seconds_total (Utilization)
    # - node_memory_MemAvailable_bytes (Utilization)
    # - node_load1, node_load5, node_load15 (Saturation)
    # - node_filesystem_avail_bytes (Utilization)

  # cAdvisor for container metrics (USE: Container Resources)
  - job_name: "cadvisor"
    static_configs:
      - targets: ["cadvisor:8080"]
    scrape_interval: 15s # Frequent collection for container metrics
    metrics_path: /metrics
    scrape_timeout: 10s
    # USE metrics:
    # - container_cpu_usage_seconds_total (Utilization)
    # - container_memory_usage_bytes (Utilization)
    # - container_memory_working_set_bytes (Saturation)

  # Auth service metrics - disabled (no /metrics endpoint)
  # - job_name: "auth-service"
  #   static_configs:
  #     - targets: ["auth:9090"]
  #   scrape_interval: 15s
  #   metrics_path: /metrics
  #   scrape_timeout: 10s

  # ============================================================================
  # APPLICATION SERVICES MONITORING (RED Methodology)
  # ============================================================================

  # Nginx metrics (RED: Request Rate, Error Rate, Duration)
  - job_name: "nginx"
    static_configs:
      - targets: ["nginx-exporter:9113"]
    scrape_interval: 15s # Frequent collection for web server
    metrics_path: /metrics
    scrape_timeout: 10s
    # RED metrics:
    # - nginx_http_requests_total (Rate)
    # - nginx_http_request_duration_seconds (Duration)
    # - nginx_connections_active (Utilization)

  # PostgreSQL metrics (USE: Database Resources)
  - job_name: "postgres"
    static_configs:
      - targets: ["postgres-exporter:9187"]
    scrape_interval: 30s # Standard interval for DB
    metrics_path: /metrics
    scrape_timeout: 15s
    # USE metrics:
    # - pg_stat_database_tup_fetched (Utilization)
    # - pg_stat_database_conflicts (Errors)
    # - pg_locks_count (Saturation)

  # Redis metrics (USE: Cache Performance)
  - job_name: "redis"
    static_configs:
      - targets: ["redis-exporter:9121"]
    scrape_interval: 15s # Frequent collection for cache
    metrics_path: /metrics
    scrape_timeout: 10s
    # USE metrics:
    # - redis_memory_used_bytes (Utilization)
    # - redis_connected_clients (Utilization)
    # - redis_commands_processed_total (Rate)
    # - redis_keyspace_hits_total/redis_keyspace_misses_total (Efficiency)

  # Redis Backup metrics will be added via webhook or pushgateway
  # Currently using alerts based on existing Redis metrics
  # Backup metrics:
  # - redis_backup_source_up (Availability)
  # - redis_backup_last_success (Success Rate)
  # - redis_backup_integrity_ok (Quality)
  # - redis_backup_rdb_age_seconds (Freshness)

  # ============================================================================
  # AI SERVICES MONITORING (RED + Custom AI Metrics)
  # ============================================================================

  # Ollama metrics - LLM inference server
  - job_name: "ollama-exporter"
    static_configs:
      - targets: ["ollama-exporter:9778"]
    scrape_interval: 15s # Frequent collection for AI inference
    metrics_path: /metrics
    scrape_timeout: 10s
    # AI-specific metrics:
    # - ollama_request_duration_seconds (Duration)
    # - ollama_active_requests (Utilization)
    # - ollama_model_load_duration_seconds (Performance)

  # vLLM high-performance inference server metrics - DISABLED (service not running)
  # - job_name: "vllm"
  #   static_configs:
  #     - targets: ["vllm:8000"]
  #   scrape_interval: 15s # Frequent collection for AI inference monitoring
  #   metrics_path: /metrics
  #   scrape_timeout: 10s
  #   # Authorization for metrics access
  #   authorization:
  #     type: Bearer
  #     credentials: "erni-ki-vllm-secure-key-2024"
  #   # Special vLLM metrics:
  #   # - vllm:num_requests_running (active requests)
  #   # - vllm:num_requests_waiting (queued requests)
  #   # - vllm:gpu_cache_usage_perc (GPU cache usage)
  #   # - vllm:time_to_first_token_seconds (latency metrics)
  #   # - vllm:time_per_output_token_seconds (throughput metrics)
  #   # - vllm:e2e_request_latency_seconds (end-to-end latency)

  # SearXNG metrics - disabled (returns HTML instead of metrics)
  # - job_name: "searxng"
  #   static_configs:
  #     - targets: ["searxng:8080"]
  #   scrape_interval: 60s
  #   metrics_path: /stats
  #   scrape_timeout: 15s

  # Docling metrics - disabled (no /metrics endpoint)
  # - job_name: "docling"
  #   static_configs:
  #     - targets: ["docling:5001"]
  #   scrape_interval: 60s
  #   metrics_path: /metrics
  #   scrape_timeout: 15s

  # EdgeTTS metrics - disabled (no /metrics endpoint)
  # - job_name: "edgetts"
  #   static_configs:
  #     - targets: ["edgetts:5050"]
  #   scrape_interval: 60s
  #   metrics_path: /metrics
  #   scrape_timeout: 15s

  # Tika metrics - disabled (no /metrics endpoint)
  # - job_name: "tika"
  #   static_configs:
  #     - targets: ["tika:9998"]
  #   scrape_interval: 60s
  #   metrics_path: /metrics
  #   scrape_timeout: 15s

  # Cloudflared metrics - DISABLED (service does not provide /metrics endpoint)
  # - job_name: "cloudflared"
  #   static_configs:
  #     - targets: ["cloudflared:8080"]
  #   scrape_interval: 60s
  #   metrics_path: /metrics
  #   scrape_timeout: 15s

  # ============================================================================
  # SLA MONITORING (Blackbox Probes for Availability)
  # ============================================================================

  # Internal HTTP services availability (SLA monitoring)
  - job_name: "blackbox-http"
    metrics_path: /probe
    params:
      module: [http_2xx_no_redirect]
    static_configs:
      - targets:
          - http://openwebui:8080/health
          - http://auth:9090/health
          - http://ollama:11434/api/version
          - http://searxng:8080/
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
    scrape_interval: 30s # SLA checks every 30 seconds
    scrape_timeout: 15s

  # Blackbox exporter for TCP port checks
  - job_name: "blackbox-tcp"
    metrics_path: /probe
    params:
      module: [tcp_connect]
    static_configs:
      - targets:
          - db:5432
          - redis:6379
          - ollama:11434
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # NVIDIA GPU Exporter for GPU monitoring (USE + AI-specific)
  - job_name: "nvidia-exporter"
    static_configs:
      - targets: ["nvidia-exporter:9445"]
    scrape_interval: 10s # High-frequency collection for GPU
    metrics_path: /metrics
    scrape_timeout: 8s
    # GPU USE metrics:
    # - nvidia_gpu_utilization_gpu (Utilization)
    # - nvidia_gpu_memory_used_bytes (Utilization)
    # - nvidia_gpu_temperature_celsius (Saturation)
    # - nvidia_gpu_power_draw_watts (Utilization)

  # Webhook receiver metrics - DISABLED (service does not provide /metrics endpoint)
  # - job_name: "webhook-receiver"
  #   static_configs:
  #     - targets: ["webhook-receiver:9093"]
  #   scrape_interval: 30s
  #   metrics_path: /metrics
  #   scrape_timeout: 10s

  # Fluent Bit metrics (JSON format - will be converted in alerts)
  # Fluent Bit scrape disabled (Prometheus exporter unavailable)
  # - job_name: "fluent-bit-prom"
  #   static_configs:
  #     - targets: ["fluent-bit:2021"]
  #   scrape_interval: 30s
  #   metrics_path: /metrics
  #   scrape_timeout: 10s

  # Elasticsearch metrics - DISABLED (requires separate elasticsearch_exporter)
  # - job_name: "elasticsearch"
  #   static_configs:
  #     - targets: ["elasticsearch:9200"]
  #   scrape_interval: 30s
  #   metrics_path: /_prometheus/metrics
  #   scrape_timeout: 10s

  # Blackbox exporter: check availability via internal port 8080 (no TLS handshakes)
  - job_name: "blackbox-nginx-8080"
    metrics_path: /probe
    params:
      module: [http_2xx_no_redirect]
    static_configs:
      - targets:
          - http://nginx:8080/health
          - http://nginx:8080/searxng/
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # Blackbox exporter for internal services checks (only active HTTP endpoints)
  - job_name: "blackbox-internal"
    metrics_path: /probe
    params:
      module: [http_2xx]
    static_configs:
      - targets:
          - http://openwebui:8080/health
          - http://ollama:11434/api/version
          - http://auth:9090/health
          - http://tika:9998/
          - http://docling:5001/health
          - http://edgetts:5050/health
          - http://litellm:4000/health/readiness
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115

  # NVIDIA GPU metrics
  - job_name: "nvidia-gpu"
    static_configs:
      - targets: ["nvidia-exporter:9445"]
    scrape_interval: 30s
    metrics_path: /metrics
    scrape_timeout: 15s

  # ============================================================================
  # MCP (Model Context Protocol) MONITORING
  # ============================================================================

  # LiteLLM Context Engineering Gateway (RED + AI Performance)
  # DISABLED: 2025-10-03 - Prometheus callbacks require Enterprise license
  # Endpoint /metrics/ returns 404 Not Found
  # Alternatives: Loki logs, health check endpoint /health/readiness, blackbox monitoring
  # - job_name: "litellm"
  #   static_configs:
  #     - targets: ["litellm:4000"]
  #   scrape_interval: 15s # Frequent collection for AI gateway
  #   metrics_path: /metrics/
  #   scrape_timeout: 10s
  #   # RED + AI metrics:
  #   # - litellm_proxy_total_requests_metric (Rate)
  #   # - litellm_proxy_failed_requests_metric (Errors)
  #   # - litellm_request_total_latency_metric (Duration)
  #   # - litellm_llm_api_latency_metric (AI-specific Duration)
  #   # - litellm_redis_latency (Cache Performance)
  #   # - litellm_deployment_success_responses (Success Rate)
  #   # - litellm_deployment_failure_responses (Error Rate)

  # Custom PublicAI provider metrics exported from LiteLLM
  - job_name: "litellm-publicai"
    static_configs:
      - targets: ["litellm:9109"]
    scrape_interval: 15s
    metrics_path: /metrics
    scrape_timeout: 10s
    # Metrics:
    # - litellm_publicai_requests_total (Rate)
    # - litellm_publicai_request_latency_seconds (Duration)
    # - litellm_publicai_request_errors_total (Errors)

  # MCP Tools availability (blackbox monitoring) - DISABLED (endpoints return 404)
  # - job_name: "mcp-tools-blackbox"
  #   metrics_path: /probe
  #   params:
  #     module: [http_2xx]
  #   static_configs:
  #     - targets:
  #         - http://nginx:8080/api/mcp/time/docs
  #         - http://nginx:8080/api/mcp/postgres/docs
  #         - http://nginx:8080/api/mcp/filesystem/docs
  #         - http://nginx:8080/api/mcp/memory/docs
  #         - http://nginx:8080/api/mcp/searxng/docs
  #   relabel_configs:
  #     - source_labels: [__address__]
  #       target_label: __param_target
  #     - source_labels: [__param_target]
  #       target_label: instance
  #     - target_label: __address__
  #       replacement: blackbox-exporter:9115

  # SearXNG API performance (blackbox monitoring) - FIXED
  - job_name: "blackbox-searxng-api"
    metrics_path: /probe
    params:
      module: [searxng_api_json]  # Using fixed module with JSON validation
    static_configs:
      - targets:
          - http://nginx:8080/api/searxng/search?q=monitoring-test&format=json
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: blackbox-exporter:9115
    scrape_interval: 30s
    scrape_timeout: 10s

  # Fluent Bit (Prometheus exposition via Service HTTP)
  - job_name: "fluent-bit"
    static_configs:
      - targets: ["erni-ki-fluent-bit:2020"]
    scrape_interval: 30s
    metrics_path: /api/v1/metrics/prometheus
    scrape_timeout: 10s

  # Loki internal metrics for Grafana panels
  - job_name: "loki"
    static_configs:
      - targets: ["loki:3100"]
    scheme: http
    scrape_interval: 30s
    metrics_path: /metrics
    scrape_timeout: 10s

  # RAG Exporter (latency & sources_count) - optimized for non-critical
  - job_name: "rag-exporter"
    static_configs:
      - targets: ["rag-exporter:9808"]
    scrape_interval: 60s # Increased for non-critical metrics
    metrics_path: /metrics
    scrape_timeout: 10s
# Note: Data storage and web interface configuration
# is set via command line arguments in docker-compose.monitoring.yml
